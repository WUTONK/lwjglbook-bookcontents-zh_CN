<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Particles | 使用 LWJGL 3 开发 3D 游戏</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/3d-game-development-with-lwjgl/assets/css/0.styles.33e5fdc6.css" as="style"><link rel="preload" href="/3d-game-development-with-lwjgl/assets/js/app.519c1cc5.js" as="script"><link rel="preload" href="/3d-game-development-with-lwjgl/assets/js/2.e7870360.js" as="script"><link rel="preload" href="/3d-game-development-with-lwjgl/assets/js/29.d5befc6c.js" as="script"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/10.7296f99c.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/11.a42afaf0.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/12.b7fdae6a.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/13.01b80f30.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/14.06f37286.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/15.c4635c97.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/16.f4253e97.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/17.c7f6896c.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/18.8a24c215.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/19.ab6ce5f4.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/20.9046ed34.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/21.3cb4242e.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/22.b2fa78a0.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/23.a9e504af.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/24.12580511.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/25.a115cf89.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/26.7193040d.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/27.4fa5cc0d.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/28.e559af67.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/3.8fb1d8aa.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/30.ee00c5df.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/31.0effa8ac.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/32.c13100cf.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/33.c9fbfcdb.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/34.7bde7785.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/35.604c8847.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/36.ccd3a84c.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/37.ec274013.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/38.66d82b73.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/4.e1b9ee22.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/5.75c3f2db.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/6.601d5460.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/7.1f9c2020.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/8.be9c92d8.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/9.048bb756.js">
    <link rel="stylesheet" href="/3d-game-development-with-lwjgl/assets/css/0.styles.33e5fdc6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/3d-game-development-with-lwjgl/" class="home-link router-link-active"><!----> <span class="site-name">使用 LWJGL 3 开发 3D 游戏</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/3d-game-development-with-lwjgl/" aria-current="page" class="sidebar-link">封面</a></li><li><a href="/3d-game-development-with-lwjgl/INTRODUCTION.html" class="sidebar-link">简介</a></li><li><a href="/3d-game-development-with-lwjgl/chapter01/chapter1.html" class="sidebar-link">第一步</a></li><li><a href="/3d-game-development-with-lwjgl/chapter02/chapter2.html" class="sidebar-link">The Game Loop</a></li><li><a href="/3d-game-development-with-lwjgl/chapter03/chapter3.html" class="sidebar-link">A brief about coordinates</a></li><li><a href="/3d-game-development-with-lwjgl/chapter04/chapter4.html" class="sidebar-link">Rendering</a></li><li><a href="/3d-game-development-with-lwjgl/chapter05/chapter5.html" class="sidebar-link">More on Rendering</a></li><li><a href="/3d-game-development-with-lwjgl/chapter06/chapter6.html" class="sidebar-link">Transformations</a></li><li><a href="/3d-game-development-with-lwjgl/chapter07/chapter7.html" class="sidebar-link">Textures</a></li><li><a href="/3d-game-development-with-lwjgl/chapter08/chapter8.html" class="sidebar-link">Camera</a></li><li><a href="/3d-game-development-with-lwjgl/chapter09/chapter9.html" class="sidebar-link">Loading more complex models</a></li><li><a href="/3d-game-development-with-lwjgl/chapter10/chapter10.html" class="sidebar-link">Let there be light</a></li><li><a href="/3d-game-development-with-lwjgl/chapter11/chapter11.html" class="sidebar-link">Let there be even more light</a></li><li><a href="/3d-game-development-with-lwjgl/chapter12/chapter12.html" class="sidebar-link">Game HUD</a></li><li><a href="/3d-game-development-with-lwjgl/chapter13/chapter13.html" class="sidebar-link">Sky Box and some optimizations</a></li><li><a href="/3d-game-development-with-lwjgl/chapter14/chapter14.html" class="sidebar-link">Height Maps</a></li><li><a href="/3d-game-development-with-lwjgl/chapter15/chapter15.html" class="sidebar-link">Terrain Collisions</a></li><li><a href="/3d-game-development-with-lwjgl/chapter16/chapter16.html" class="sidebar-link">Fog</a></li><li><a href="/3d-game-development-with-lwjgl/chapter17/chapter17.html" class="sidebar-link">Normal Mapping</a></li><li><a href="/3d-game-development-with-lwjgl/chapter18/chapter18.html" class="sidebar-link">Shadows</a></li><li><a href="/3d-game-development-with-lwjgl/chapter19/chapter19.html" class="sidebar-link">Animations</a></li><li><a href="/3d-game-development-with-lwjgl/chapter20/chapter20.html" aria-current="page" class="active sidebar-link">Particles</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/3d-game-development-with-lwjgl/chapter20/chapter20.html#the-basics" class="sidebar-link">The basics</a></li><li class="sidebar-sub-header"><a href="/3d-game-development-with-lwjgl/chapter20/chapter20.html#texture-atlas" class="sidebar-link">Texture Atlas</a></li></ul></li><li><a href="/3d-game-development-with-lwjgl/chapter21/chapter21.html" class="sidebar-link">Instanced Rendering</a></li><li><a href="/3d-game-development-with-lwjgl/chapter22/chapter22.html" class="sidebar-link">Audio</a></li><li><a href="/3d-game-development-with-lwjgl/chapter23/chapter23.html" class="sidebar-link">3D Object Picking</a></li><li><a href="/3d-game-development-with-lwjgl/chapter24/chapter24.html" class="sidebar-link">HUD Revisited - NanoVG</a></li><li><a href="/3d-game-development-with-lwjgl/chapter25/chapter25.html" class="sidebar-link">Optimizations - Frustum Culling \(I\)</a></li><li><a href="/3d-game-development-with-lwjgl/chapter26/chapter26.html" class="sidebar-link">Cascaded Shadow Maps</a></li><li><a href="/3d-game-development-with-lwjgl/chapter27/chapter27.html" class="sidebar-link">Assimp</a></li><li><a href="/3d-game-development-with-lwjgl/chapter28/chapter28.html" class="sidebar-link">Deferred Shading</a></li><li><a href="/3d-game-development-with-lwjgl/appendixa/appendixa.html" class="sidebar-link">Appendix A - OpenGL Debugging</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="particles"><a href="#particles" class="header-anchor">#</a> Particles</h1> <h2 id="the-basics"><a href="#the-basics" class="header-anchor">#</a> The basics</h2> <p>In this chapter we will add particle effects to the game engine. With this effect we will be able to simulate rays, fire, dust and clouds.  It’s a simple effect to implement that will improve the graphical aspect of any game.</p> <p>Before we start it's worth to mention that there are many ways to implement particle effects with different results. In this case we will use billboard particles. This technique uses moving texture quads to represent a particle with the peculiarity that they are always always facing the observer, in our case, the camera. You can also use billboarding technique to show information panels over game items like a mini HUDs.</p> <p>Let’s start by defining what is a particle. A particle can be defined by the following attributes:</p> <ol><li>A mesh that represents the quad vertices.</li> <li>A texture.</li> <li>A position at a given instant.</li> <li>A scale factor.</li> <li>Speed.</li> <li>A movement direction.</li> <li>A life time or time to live. Once this time has expired the particle ceases to exist.</li></ol> <p>The first four items are part of the <code>GameItem</code> class, but the last three are not. Thus, we will create a new class named <code>Particle</code> that extends a <code>GameItem</code> instance and that is defined like this.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>lwjglb<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>graph<span class="token punctuation">.</span>particles</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>joml<span class="token punctuation">.</span></span><span class="token class-name">Vector3f</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>lwjglb<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>graph<span class="token punctuation">.</span></span><span class="token class-name">Mesh</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>lwjglb<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>items<span class="token punctuation">.</span></span><span class="token class-name">GameItem</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Particle</span> <span class="token keyword">extends</span> <span class="token class-name">GameItem</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Vector3f</span> speed<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Time to live for particle in milliseconds.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> ttl<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Particle</span><span class="token punctuation">(</span><span class="token class-name">Mesh</span> mesh<span class="token punctuation">,</span> <span class="token class-name">Vector3f</span> speed<span class="token punctuation">,</span> <span class="token keyword">long</span> ttl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>mesh<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>speed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span>speed<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ttl <span class="token operator">=</span> ttl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Particle</span><span class="token punctuation">(</span><span class="token class-name">Particle</span> baseParticle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>baseParticle<span class="token punctuation">.</span><span class="token function">getMesh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Vector3f</span> aux <span class="token operator">=</span> baseParticle<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setPosition</span><span class="token punctuation">(</span>aux<span class="token punctuation">.</span>x<span class="token punctuation">,</span> aux<span class="token punctuation">.</span>y<span class="token punctuation">,</span> aux<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
        aux <span class="token operator">=</span> baseParticle<span class="token punctuation">.</span><span class="token function">getRotation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setRotation</span><span class="token punctuation">(</span>aux<span class="token punctuation">.</span>x<span class="token punctuation">,</span> aux<span class="token punctuation">.</span>y<span class="token punctuation">,</span> aux<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setScale</span><span class="token punctuation">(</span>baseParticle<span class="token punctuation">.</span><span class="token function">getScale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>speed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span>baseParticle<span class="token punctuation">.</span>speed<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ttl <span class="token operator">=</span> baseParticle<span class="token punctuation">.</span><span class="token function">geTtl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Vector3f</span> <span class="token function">getSpeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> speed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSpeed</span><span class="token punctuation">(</span><span class="token class-name">Vector3f</span> speed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>speed <span class="token operator">=</span> speed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">geTtl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> ttl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setTtl</span><span class="token punctuation">(</span><span class="token keyword">long</span> ttl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ttl <span class="token operator">=</span> ttl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Updates the Particle's TTL
     * @param elapsedTime Elapsed Time in milliseconds
     * @return The Particle's TTL
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">updateTtl</span><span class="token punctuation">(</span><span class="token keyword">long</span> elapsedTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ttl <span class="token operator">-=</span> elapsedTime<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ttl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><p>As you can see from the code above, the particle's speed and movement direction can be expressed as a single vector. The direction of that vector models the movement direction and its module the speed. The Particle Time To Live (TTL) is modelled as a milliseconds counter that will be decreased whenever the game state is updated. The class has also a copy constructor, that is, a constructor that takes an instance of another Particle to make a copy.</p> <p>Now, we need to create a particle generator or particle emitter, that is, a class that generates the particles dynamically, controls their life cycle and updates their position according to a specific model.  We can create many implementations that vary in how particles are created and how their positions are updated (for instance, taking into consideration gravity or not). So, in order to keep our game engine generic, we will create an interface that all the Particle emitters must implement. This interface, named <code>IParticleEmitter</code>, is defined like this:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>lwjglb<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>graph<span class="token punctuation">.</span>particles</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>lwjglb<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>items<span class="token punctuation">.</span></span><span class="token class-name">GameItem</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IParticleEmitter</span> <span class="token punctuation">{</span>

    <span class="token keyword">void</span> <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Particle</span> <span class="token function">getBaseParticle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GameItem</span><span class="token punctuation">&gt;</span></span> <span class="token function">getParticles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>The <code>IParticleEmitter</code> interface has a method to clean up resources, named <code>cleanup</code>, and a method to get the list of Particles, named <code>getParticles</code>. It also has a method named <code>getBaseParticle</code>, but what’s this method for? A particle emitter will create many particles dynamically. Whenever a particle expires, new ones will be created. That particle renewal cycle will use a base particle, like a pattern, to create new instances. This is what this base particle is used for, and it's also the reason why the <code>Particle</code> class defines a copy constructor.</p> <p>In the game engine code we will refer only to the <code>IParticleEmitter</code> interface so the base code will not be dependent on the specific implementations. Nevertheless we can create a implementation that simulates a flow of particles that are not affected by gravity. This implementation can be used to simulate rays or fire and is named <code>FlowParticleEmitter</code>.</p> <p>The behaviour of this class can be tuned with the following attributes:</p> <ul><li>A maximum number of particles that can be alive at a time.</li> <li>A minimum period to create particles. Particles will be created one by one with a minimum period to avoid creating particles in bursts.</li> <li>A set of ranges to randomize particles speed and starting position. New particles will use  base particle position and speed which can be randomized with values between those ranges to spread the beam.</li></ul> <p>The implementation of this class is as follows:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>lwjglb<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>graph<span class="token punctuation">.</span>particles</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Iterator</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>joml<span class="token punctuation">.</span></span><span class="token class-name">Vector3f</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>lwjglb<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>items<span class="token punctuation">.</span></span><span class="token class-name">GameItem</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlowParticleEmitter</span> <span class="token keyword">implements</span> <span class="token class-name">IParticleEmitter</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> maxParticles<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> active<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GameItem</span><span class="token punctuation">&gt;</span></span> particles<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Particle</span> baseParticle<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">long</span> creationPeriodMillis<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">long</span> lastCreationTime<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">float</span> speedRndRange<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">float</span> positionRndRange<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">float</span> scaleRndRange<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">FlowParticleEmitter</span><span class="token punctuation">(</span><span class="token class-name">Particle</span> baseParticle<span class="token punctuation">,</span> <span class="token keyword">int</span> maxParticles<span class="token punctuation">,</span> <span class="token keyword">long</span> creationPeriodMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        particles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>baseParticle <span class="token operator">=</span> baseParticle<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>maxParticles <span class="token operator">=</span> maxParticles<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>lastCreationTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>creationPeriodMillis <span class="token operator">=</span> creationPeriodMillis<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Particle</span> <span class="token function">getBaseParticle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> baseParticle<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getCreationPeriodMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> creationPeriodMillis<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getMaxParticles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> maxParticles<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GameItem</span><span class="token punctuation">&gt;</span></span> <span class="token function">getParticles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> particles<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">float</span> <span class="token function">getPositionRndRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> positionRndRange<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">float</span> <span class="token function">getScaleRndRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> scaleRndRange<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">float</span> <span class="token function">getSpeedRndRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> speedRndRange<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCreationPeriodMillis</span><span class="token punctuation">(</span><span class="token keyword">long</span> creationPeriodMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>creationPeriodMillis <span class="token operator">=</span> creationPeriodMillis<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMaxParticles</span><span class="token punctuation">(</span><span class="token keyword">int</span> maxParticles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>maxParticles <span class="token operator">=</span> maxParticles<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPositionRndRange</span><span class="token punctuation">(</span><span class="token keyword">float</span> positionRndRange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>positionRndRange <span class="token operator">=</span> positionRndRange<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setScaleRndRange</span><span class="token punctuation">(</span><span class="token keyword">float</span> scaleRndRange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>scaleRndRange <span class="token operator">=</span> scaleRndRange<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> active<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setActive</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>active <span class="token operator">=</span> active<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSpeedRndRange</span><span class="token punctuation">(</span><span class="token keyword">float</span> speedRndRange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>speedRndRange <span class="token operator">=</span> speedRndRange<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">long</span> elapsedTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastCreationTime <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            lastCreationTime <span class="token operator">=</span> now<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GameItem</span><span class="token punctuation">&gt;</span></span> it <span class="token operator">=</span> particles<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Particle</span> particle <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Particle</span><span class="token punctuation">)</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>particle<span class="token punctuation">.</span><span class="token function">updateTtl</span><span class="token punctuation">(</span>elapsedTime<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                it<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">updatePosition</span><span class="token punctuation">(</span>particle<span class="token punctuation">,</span> elapsedTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">int</span> length <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getParticles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> lastCreationTime <span class="token operator">&gt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>creationPeriodMillis <span class="token operator">&amp;&amp;</span> length <span class="token operator">&lt;</span> maxParticles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">createParticle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>lastCreationTime <span class="token operator">=</span> now<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">createParticle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Particle</span> particle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Particle</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getBaseParticle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Add a little bit of randomness of the particle</span>
        <span class="token keyword">float</span> sign <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0.5d</span> <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1.0f</span> <span class="token operator">:</span> <span class="token number">1.0f</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> speedInc <span class="token operator">=</span> sign <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>speedRndRange<span class="token punctuation">;</span>
        <span class="token keyword">float</span> posInc <span class="token operator">=</span> sign <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>positionRndRange<span class="token punctuation">;</span>        
        <span class="token keyword">float</span> scaleInc <span class="token operator">=</span> sign <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scaleRndRange<span class="token punctuation">;</span>        
        particle<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>posInc<span class="token punctuation">,</span> posInc<span class="token punctuation">,</span> posInc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        particle<span class="token punctuation">.</span><span class="token function">getSpeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>speedInc<span class="token punctuation">,</span> speedInc<span class="token punctuation">,</span> speedInc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        particle<span class="token punctuation">.</span><span class="token function">setScale</span><span class="token punctuation">(</span>particle<span class="token punctuation">.</span><span class="token function">getScale</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> scaleInc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        particles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>particle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Updates a particle position
     * @param particle The particle to update
     * @param elapsedTime Elapsed time in milliseconds
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updatePosition</span><span class="token punctuation">(</span><span class="token class-name">Particle</span> particle<span class="token punctuation">,</span> <span class="token keyword">long</span> elapsedTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Vector3f</span> speed <span class="token operator">=</span> particle<span class="token punctuation">.</span><span class="token function">getSpeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> delta <span class="token operator">=</span> elapsedTime <span class="token operator">/</span> <span class="token number">1000.0f</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> dx <span class="token operator">=</span> speed<span class="token punctuation">.</span>x <span class="token operator">*</span> delta<span class="token punctuation">;</span>
        <span class="token keyword">float</span> dy <span class="token operator">=</span> speed<span class="token punctuation">.</span>y <span class="token operator">*</span> delta<span class="token punctuation">;</span>
        <span class="token keyword">float</span> dz <span class="token operator">=</span> speed<span class="token punctuation">.</span>z <span class="token operator">*</span> delta<span class="token punctuation">;</span>
        <span class="token class-name">Vector3f</span> pos <span class="token operator">=</span> particle<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        particle<span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span>pos<span class="token punctuation">.</span>x <span class="token operator">+</span> dx<span class="token punctuation">,</span> pos<span class="token punctuation">.</span>y <span class="token operator">+</span> dy<span class="token punctuation">,</span> pos<span class="token punctuation">.</span>z <span class="token operator">+</span> dz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">GameItem</span> particle <span class="token operator">:</span> <span class="token function">getParticles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            particle<span class="token punctuation">.</span><span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br></div></div><p>Now we can extend the information contained in the <code>Scene</code> class to include an array of <code>ParticleEmitter</code> instances.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>lwjglb<span class="token punctuation">.</span>engine</span><span class="token punctuation">;</span>

<span class="token comment">// Imports here</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Scene</span> <span class="token punctuation">{</span>

    <span class="token comment">// More attributes here</span>

    <span class="token keyword">private</span> <span class="token class-name">IParticleEmitter</span><span class="token punctuation">[</span><span class="token punctuation">]</span> particleEmitters<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>At this stage we can start rendering the particles. Particles will not be affected by lights and will not cast any shadow. They will not have any skeletal animation, so it makes sense to have specific shaders to render them. The shaders will be very simple, they will just render the vertices using the projection and modelview matrices and use a texture to set the colours.</p> <p>The vertex shader is defined like this.</p> <div class="language-glsl line-numbers-mode"><pre class="language-glsl"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span></span></span>

<span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> position<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> texCoord<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> vertexNormal<span class="token punctuation">;</span>

<span class="token keyword">out</span> <span class="token keyword">vec2</span> outTexCoord<span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> modelViewMatrix<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> projectionMatrix<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> projectionMatrix <span class="token operator">*</span> modelViewMatrix <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    outTexCoord <span class="token operator">=</span> texCoord<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>The fragment shader is defined like this:</p> <div class="language-glsl line-numbers-mode"><pre class="language-glsl"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span></span></span>

<span class="token keyword">in</span> <span class="token keyword">vec2</span> outTexCoord<span class="token punctuation">;</span>
<span class="token keyword">in</span> <span class="token keyword">vec3</span> mvPos<span class="token punctuation">;</span>
<span class="token keyword">out</span> <span class="token keyword">vec4</span> fragColor<span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> texture_sampler<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    fragColor <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span>texture_sampler<span class="token punctuation">,</span> outTexCoord<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>As you can see, they are very simple: they resemble the pair of shaders used in the first chapters. Now, as in other chapters, we need to setup and use those shaders in the <code>Renderer</code> class. The shaders' setup will be done in a method named <code>setupParticlesShader</code> which is defined like this:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setupParticlesShader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    particlesShaderProgram <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShaderProgram</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    particlesShaderProgram<span class="token punctuation">.</span><span class="token function">createVertexShader</span><span class="token punctuation">(</span><span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">loadResource</span><span class="token punctuation">(</span><span class="token string">&quot;/shaders/particles_vertex.vs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    particlesShaderProgram<span class="token punctuation">.</span><span class="token function">createFragmentShader</span><span class="token punctuation">(</span><span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">loadResource</span><span class="token punctuation">(</span><span class="token string">&quot;/shaders/particles_fragment.fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    particlesShaderProgram<span class="token punctuation">.</span><span class="token function">link</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    particlesShaderProgram<span class="token punctuation">.</span><span class="token function">createUniform</span><span class="token punctuation">(</span><span class="token string">&quot;projectionMatrix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    particlesShaderProgram<span class="token punctuation">.</span><span class="token function">createUniform</span><span class="token punctuation">(</span><span class="token string">&quot;modelViewMatrix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    particlesShaderProgram<span class="token punctuation">.</span><span class="token function">createUniform</span><span class="token punctuation">(</span><span class="token string">&quot;texture_sampler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>And now we can create the render method named <code>renderParticles</code> in the <code>Renderer</code> class which is defined like this:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">renderParticles</span><span class="token punctuation">(</span><span class="token class-name">Window</span> window<span class="token punctuation">,</span> <span class="token class-name">Camera</span> camera<span class="token punctuation">,</span> <span class="token class-name">Scene</span> scene<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    particlesShaderProgram<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    particlesShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;texture_sampler&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Matrix4f</span> projectionMatrix <span class="token operator">=</span> transformation<span class="token punctuation">.</span><span class="token function">getProjectionMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    particlesShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;projectionMatrix&quot;</span><span class="token punctuation">,</span> projectionMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Matrix4f</span> viewMatrix <span class="token operator">=</span> transformation<span class="token punctuation">.</span><span class="token function">getViewMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IParticleEmitter</span><span class="token punctuation">[</span><span class="token punctuation">]</span> emitters <span class="token operator">=</span> scene<span class="token punctuation">.</span><span class="token function">getParticleEmitters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> numEmitters <span class="token operator">=</span> emitters <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> emitters<span class="token punctuation">.</span>length <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numEmitters<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">IParticleEmitter</span> emitter <span class="token operator">=</span> emitters<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">Mesh</span> mesh <span class="token operator">=</span> emitter<span class="token punctuation">.</span><span class="token function">getBaseParticle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMesh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mesh<span class="token punctuation">.</span><span class="token function">renderList</span><span class="token punctuation">(</span><span class="token punctuation">(</span>emitter<span class="token punctuation">.</span><span class="token function">getParticles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">GameItem</span> gameItem<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">Matrix4f</span> modelViewMatrix <span class="token operator">=</span> transformation<span class="token punctuation">.</span><span class="token function">buildModelViewMatrix</span><span class="token punctuation">(</span>gameItem<span class="token punctuation">,</span> viewMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
            particlesShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;modelViewMatrix&quot;</span><span class="token punctuation">,</span> modelViewMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    particlesShaderProgram<span class="token punctuation">.</span><span class="token function">unbind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>The fragment above should be self explanatory if you managed to get to this point, it just renders each particle setting up the required uniforms. We have now created all the methods we need to test the implementation of the particle effect. We just need to modify the <code>DummyGame</code> class to setup a particle emitter and the characteristics of the base particle.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Vector3f</span> particleSpeed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
particleSpeed<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span><span class="token number">2.5f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> ttl <span class="token operator">=</span> <span class="token number">4000</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> maxParticles <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> creationPeriodMillis <span class="token operator">=</span> <span class="token number">300</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> range <span class="token operator">=</span> <span class="token number">0.2f</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> scale <span class="token operator">=</span> <span class="token number">0.5f</span><span class="token punctuation">;</span>
<span class="token class-name">Mesh</span> partMesh <span class="token operator">=</span> <span class="token class-name">OBJLoader</span><span class="token punctuation">.</span><span class="token function">loadMesh</span><span class="token punctuation">(</span><span class="token string">&quot;/models/particle.obj&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Texture</span> texture <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Texture</span><span class="token punctuation">(</span><span class="token string">&quot;/textures/particle_tmp.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Material</span> partMaterial <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Material</span><span class="token punctuation">(</span>texture<span class="token punctuation">,</span> reflectance<span class="token punctuation">)</span><span class="token punctuation">;</span>
partMesh<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span>partMaterial<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Particle</span> particle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Particle</span><span class="token punctuation">(</span>partMesh<span class="token punctuation">,</span> particleSpeed<span class="token punctuation">,</span> ttl<span class="token punctuation">)</span><span class="token punctuation">;</span>
particle<span class="token punctuation">.</span><span class="token function">setScale</span><span class="token punctuation">(</span>scale<span class="token punctuation">)</span><span class="token punctuation">;</span>
particleEmitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlowParticleEmitter</span><span class="token punctuation">(</span>particle<span class="token punctuation">,</span> maxParticles<span class="token punctuation">,</span> creationPeriodMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
particleEmitter<span class="token punctuation">.</span><span class="token function">setActive</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
particleEmitter<span class="token punctuation">.</span><span class="token function">setPositionRndRange</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span><span class="token punctuation">;</span>
particleEmitter<span class="token punctuation">.</span><span class="token function">setSpeedRndRange</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>scene<span class="token punctuation">.</span><span class="token function">setParticleEmitters</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FlowParticleEmitter</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>particleEmitter<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>We are using a plain filled circle as the particle texture for now to better understand what’s happening. If you execute the code above you will see something like this.</p> <p><img src="particles_i.png" alt="Particles I"></p> <p>Why do some particles seem to be cut off? Why the transparent background does not solve this? The reason for that is depth testing. Some fragments of the particles get discarded because they have a depth buffer value higher than the current value of the depth buffer for that zone. We can solve this by ordering the particle drawings depending in their distance to the camera or we can just disable writing to the depth buffer.</p> <p>Before we draw the particles we just need to insert this line:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token function">glDepthMask</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>And when we are done with rendering we restore the previous value:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token function">glDepthMask</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Then we will get something like this.</p> <p><img src="particles_ii.png" alt="Particles II"></p> <p>OK, problem solved. Nevertheless, we still want another effect to be applied, we would want that colours get blended so colours will be added to create better effects. This is achieved with by adding this line before rendering to setup additive blending.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token function">glBlendFunc</span><span class="token punctuation">(</span>GL_SRC_ALPHA<span class="token punctuation">,</span> GL_ONE<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>As in the depth case, after we have rendered all the particles we restore the blending function to:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token function">glBlendFunc</span><span class="token punctuation">(</span>GL_SRC_ALPHA<span class="token punctuation">,</span> GL_ONE_MINUS_SRC_ALPHA<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Now we get something like this.</p> <p><img src="particles_iii.png" alt="Particles III"></p> <p>But we have not finished yet. If you have moved the camera over the blue square looking down you may have got something like this.</p> <p><img src="particles_iv.png" alt="Particles IV"></p> <p>The particles do not look very good, they should look round but they resemble a sheet of paper. This point is where we should be applying the billboard technique. The quad that is used to render the particle should always be facing the camera, totally perpendicular to it as if it there was no rotation at all. The camera matrix applies translation and rotation to every object in the scene, we want to skip the rotation to be applied.</p> <p>Warning: Maths ahead, you can skip it if you don't feel comfortable with this. Let’s review that view matrix once again. That matrix can be represented like this (without any scale applied to it).</p> <p>$$
\begin{bmatrix}
\color{red}{r_{00}} &amp; \color{red}{r_{10}} &amp; \color{red}{r_{20}} &amp; \color{blue}{dx} \
\color{red}{r_{01}} &amp; \color{red}{r_{11}} &amp; \color{red}{r_{21}} &amp; \color{blue}{dy} \
\color{red}{r_{02}} &amp; \color{red}{r_{12}} &amp; \color{red}{r_{22}} &amp; \color{blue}{dz} \
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}
$$</p> <p>The red elements represent the camera rotation while the blue ones represent the translation. We need to cancel the effect of the upper left 3x3 matrix contained in the view matrix so it gets to something like this.</p> <p>$$
\begin{bmatrix}
\color{red}{1} &amp; \color{red}{0} &amp; \color{red}{0} &amp; \color{blue}{dx} \
\color{red}{0} &amp; \color{red}{1} &amp; \color{red}{0} &amp; \color{blue}{dy} \
\color{red}{0} &amp; \color{red}{0} &amp; \color{red}{1} &amp; \color{blue}{dz} \
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}
$$</p> <p>So, we have a 3x3 matrix, the upper left red fragment, let's name it $$M_{r}$$ and we want it to transform it to the identify matrix: $$I$$. Any matrix multiplied by its inverse will give the identify matrix: $$M_{r} \times M_{r}^{-1} = I$$. So we just need to get the upper left 3x3 matrix from the view matrix, and multiply it by its inverse, but we can even optimize this. A rotation matrix has an interesting characteristic, its inverse coincides with its transpose matrix. That is: $$ M_{r} \times M_{r}^{-1} = M_{r} \times M_{r}^{T} = I $$. And a transpose matrix is much easier to calculate than the inverse, as it only requires swapping rows and columns.</p> <h1 id="begin-bmatrix-r-00-r-10-r-20-r-01-r-11-r-21-r-02-r-12-r-22-end-bmatrix-t"><a href="#begin-bmatrix-r-00-r-10-r-20-r-01-r-11-r-21-r-02-r-12-r-22-end-bmatrix-t" class="header-anchor">#</a> $$
\begin{bmatrix}
r_{00} &amp; r_{10} &amp; r_{20} \
r_{01} &amp; r_{11} &amp; r_{21} \
r_{02} &amp; r_{12} &amp; r_{22}
\end{bmatrix}^{T}</h1> <p>\begin{bmatrix}
r_{00} &amp; r_{01} &amp; r_{02} \
r_{10} &amp; r_{11} &amp; r_{12} \
r_{20} &amp; r_{21} &amp; r_{22}
\end{bmatrix}
$$</p> <p>OK, let's summarize. We have this transformation: $$V \times M$$, where $$V$$ is the view matrix and $$M$$ is the model matrix. We can write that expression like this:</p> <p>$$
\begin{bmatrix}
\color{red}{v_{00}} &amp; \color{red}{v_{10}} &amp; \color{red}{v_{20}} &amp; v_{30} \
\color{red}{v_{01}} &amp; \color{red}{v_{11}} &amp; \color{red}{v_{21}} &amp; v_{31} \
\color{red}{v_{02}} &amp; \color{red}{v_{12}} &amp; \color{red}{v_{22}} &amp; v_{32} \
v_{03} &amp; v_{13} &amp; v_{23} &amp; v_{33}
\end{bmatrix}
\times
\begin{bmatrix}
\color{red}{m_{00}} &amp; \color{red}{m_{10}} &amp; \color{red}{m_{20}} &amp; m_{30} \
\color{red}{m_{01}} &amp; \color{red}{m_{11}} &amp; \color{red}{m_{21}} &amp; m_{31} \
\color{red}{m_{02}} &amp; \color{red}{m_{12}} &amp; \color{red}{m_{22}} &amp; m_{32} \
m_{03} &amp; m_{13} &amp; m_{23} &amp; m_{33}
\end{bmatrix}
$$</p> <p>We want to cancel the rotation of the view matrix, to get something like this:</p> <p>$$
\begin{bmatrix}
\color{red}{1} &amp; \color{red}{0} &amp; \color{red}{0} &amp; mv_{30} \
\color{red}{0} &amp; \color{red}{1} &amp; \color{red}{0} &amp; mv_{31} \
\color{red}{0} &amp; \color{red}{0} &amp; \color{red}{1} &amp; mv_{32} \
mv_{03} &amp; mv_{13} &amp; mv_{23} &amp; mv_{33}
\end{bmatrix}
$$</p> <p>So we just need to set the upper left 3x3 matrix for the model matrix as the transpose matrix of the 3x3 upper part of the view matrix:</p> <p>$$
\begin{bmatrix}
\color{red}{v_{00}} &amp; \color{red}{v_{10}} &amp; \color{red}{v_{20}} &amp; v_{30} \
\color{red}{v_{01}} &amp; \color{red}{v_{11}} &amp; \color{red}{v_{21}} &amp; v_{31} \
\color{red}{v_{02}} &amp; \color{red}{v_{12}} &amp; \color{red}{v_{22}} &amp; v_{32} \
v_{03} &amp; v_{13} &amp; v_{23} &amp; v_{33}
\end{bmatrix}
\times
\begin{bmatrix}
\color{red}{v_{00}} &amp; \color{red}{v_{01}} &amp; \color{red}{v_{02}} &amp; m_{30} \
\color{red}{v_{10}} &amp; \color{red}{v_{11}} &amp; \color{red}{v_{12}} &amp; m_{31} \
\color{red}{v_{20}} &amp; \color{red}{v_{21}} &amp; \color{red}{v_{22}} &amp; m_{32} \
m_{03} &amp; m_{13} &amp; m_{23} &amp; m_{33}
\end{bmatrix}
$$</p> <p>But, after doing this, we have removed the scaling factor, indeed what we do really want to achieve is something like this:</p> <p>$$\begin{bmatrix}
\color{red}{sx} &amp; \color{red}{0} &amp; \color{red}{0} &amp; mv_{30} \
\color{red}{0} &amp; \color{red}{sy} &amp; \color{red}{0} &amp; mv_{31} \
\color{red}{0} &amp; \color{red}{0} &amp; \color{red}{sz} &amp; mv_{32} \
mv_{03} &amp; mv_{13} &amp; mv_{23} &amp; mv_{33}
\end{bmatrix}$$</p> <p>Where sx, sy and sz are the scaling factor. Thus, after we have set set the upper left 3x3 matrix for the model matrix as the transpose matrix of the view matrix, we need to apply scaling again.</p> <p>And that's all, we just need to change this in the <code>renderParticlesMethod</code> like this:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numEmitters<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">IParticleEmitter</span> emitter <span class="token operator">=</span> emitters<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token class-name">Mesh</span> mesh <span class="token operator">=</span> emitter<span class="token punctuation">.</span><span class="token function">getBaseParticle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMesh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            mesh<span class="token punctuation">.</span><span class="token function">renderList</span><span class="token punctuation">(</span><span class="token punctuation">(</span>emitter<span class="token punctuation">.</span><span class="token function">getParticles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">GameItem</span> gameItem<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">Matrix4f</span> modelMatrix <span class="token operator">=</span> transformation<span class="token punctuation">.</span><span class="token function">buildModelMatrix</span><span class="token punctuation">(</span>gameItem<span class="token punctuation">)</span><span class="token punctuation">;</span>

                viewMatrix<span class="token punctuation">.</span><span class="token function">transpose3x3</span><span class="token punctuation">(</span>modelMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name">Matrix4f</span> modelViewMatrix <span class="token operator">=</span> transformation<span class="token punctuation">.</span><span class="token function">buildModelViewMatrix</span><span class="token punctuation">(</span>modelMatrix<span class="token punctuation">,</span> viewMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
                modelViewMatrix<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>gameItem<span class="token punctuation">.</span><span class="token function">getScale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                particlesShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;modelViewMatrix&quot;</span><span class="token punctuation">,</span> modelViewMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>We also have added another method to the <code>Transformation</code> class to construct a model view matrix using two matrices instead of a <code>GameItem</code> and the view matrix.</p> <p>With that change, when we look at the particles from above we get something like this.</p> <p><img src="particles_v.png" alt="Particles V"></p> <p>Now we have everything we need to create a more realistic particle effect so let's change the texture to something more elaborated. We will use this image (it was created with <a href="https://www.gimp.org/" target="_blank" rel="noopener noreferrer">GIMP<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> with the lights and shadows filters).</p> <p><img src="particle_texture.png" alt="Particle texture">
With this texture, we will get something like this.</p> <p><img src="particles_vi.png" alt="Particles VI"></p> <p>Much better! You may notice that we need to adjust the scale, since particles are now always facing the camera the displayed area is always the maximum.</p> <p>Finally, another conclusion, to get perfect results which can be used in any scene you will need to implement particle ordering and activate depth buffer. In any case, you have here a sample to include this effect in your games.</p> <h2 id="texture-atlas"><a href="#texture-atlas" class="header-anchor">#</a> Texture Atlas</h2> <p>Now that we have set the basic infrastructure for particle effect we can add some animation effects to it. In order to achieve that, we are going to support texture atlases. A texture atlas is a large image that contains all the textures that will be used. With a texture atlas we need only to load a large image and then while drawing the game items we select the portions of that image to be used as our texture. This technique can be applied for instance when we want to represent the same model many times with different textures (think for instance about trees, or rocks). Instead of having many texture instances and switching between them (remember that switching states are always slow) we can use the same texture atlas and just select the appropriate coordinates.</p> <p>In this case, we are going to use texture coordinates to animate particles. We will iterate over different textures to model a particle animation. All those textures will be grouped into a texture atlas which looks like this.</p> <p><img src="texture_atlas.png" alt="Texture Atlas"></p> <p>The texture atlas can be divided into quad tiles. We will assign a tile position to a particle and will change it over time to represent animation. So let’s get on it. The first thing that we are going to do is modifying the <code>Texture</code> class to specify the number of rows and columns that a texture atlas can have.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>lwjglb<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>graph</span><span class="token punctuation">;</span>

<span class="token comment">// .. Imports here ..</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Texture</span> <span class="token punctuation">{</span>

    <span class="token comment">// More attributes here</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> numRows <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> numCols <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

   <span class="token comment">// More code here</span>

    <span class="token keyword">public</span> <span class="token class-name">Texture</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileName<span class="token punctuation">,</span> <span class="token keyword">int</span> numCols<span class="token punctuation">,</span> <span class="token keyword">int</span> numRows<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span>  <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>numCols <span class="token operator">=</span> numCols<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>numRows <span class="token operator">=</span> numRows<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>The default case is to have a texture with a number of columns and rows equal to 1, that is, the textures we have dealing with. We also add another constructor to be able to specify the rows and columns.</p> <p>Then we need to keep track the position in the texture atlas for a <code>GameItem</code>, so we just add another attribute to that class with a default value equal to 0.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>lwjglb<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>items</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>joml<span class="token punctuation">.</span></span><span class="token class-name">Vector3f</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>lwjglb<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>graph<span class="token punctuation">.</span></span><span class="token class-name">Mesh</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GameItem</span> <span class="token punctuation">{</span>

    <span class="token comment">// More attributes here</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> textPos<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>Then we will modify the <code>Particle</code> class to be able to iterate automatically through a texture atlas.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>lwjglb<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>graph<span class="token punctuation">.</span>particles</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>joml<span class="token punctuation">.</span></span><span class="token class-name">Vector3f</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>lwjglb<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>graph<span class="token punctuation">.</span></span><span class="token class-name">Mesh</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>lwjglb<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>graph<span class="token punctuation">.</span></span><span class="token class-name">Texture</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>lwjglb<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>items<span class="token punctuation">.</span></span><span class="token class-name">GameItem</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Particle</span> <span class="token keyword">extends</span> <span class="token class-name">GameItem</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">long</span> updateTextureMillis<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">long</span> currentAnimTimeMillis<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>The <code>updateTextureMillis</code> attribute models the period of time (in milliseconds) to move to the next position in the texture atlas. The lowest the value the fastest the particle will roll over the textures. The <code>currentAnimTimeMillis</code> attribute just keeps track of the time that the particle has maintained a texture position.</p> <p>Thus, we need to modify the <code>Particle</code> class constructor to set up those values. Also we calculate the number of tiles of the texture atlas, which is modelled by the attribute <code>animFrames</code>.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Particle</span><span class="token punctuation">(</span><span class="token class-name">Mesh</span> mesh<span class="token punctuation">,</span> <span class="token class-name">Vector3f</span> speed<span class="token punctuation">,</span> <span class="token keyword">long</span> ttl<span class="token punctuation">,</span> <span class="token keyword">long</span> updateTextureMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>mesh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>speed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span>speed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ttl <span class="token operator">=</span> ttl<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>updateTextureMills <span class="token operator">=</span> updateTextureMills<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>currentAnimTimeMillis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">Texture</span> texture <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMesh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaterial</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>animFrames <span class="token operator">=</span> texture<span class="token punctuation">.</span><span class="token function">getNumCols</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> texture<span class="token punctuation">.</span><span class="token function">getNumRows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>Now we just need to modify the method that checks if the particle has expired to check also if we need to update the texture position.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">updateTtl</span><span class="token punctuation">(</span><span class="token keyword">long</span> elapsedTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ttl <span class="token operator">-=</span> elapsedTime<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>currentAnimTimeMillis <span class="token operator">+=</span> elapsedTime<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currentAnimTimeMillis <span class="token operator">&gt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getUpdateTextureMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>animFrames <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>currentAnimTimeMillis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> pos <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTextPos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pos<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> pos <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>animFrames <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setTextPos</span><span class="token punctuation">(</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setTextPos</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ttl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>Beside that, we also have modified the <code>FlowRangeEmitter</code> class to add some randomness to the period of time when we should change a particle’s texture position. You can check it in the source code.</p> <p>Now we can use that information to set up appropriate texture coordinates. We will do this in the vertex fragment since it outputs those values to be used in the fragment shader. The new version of that shader is defined like this.</p> <div class="language-glsl line-numbers-mode"><pre class="language-glsl"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span></span></span>

<span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> position<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> texCoord<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> vertexNormal<span class="token punctuation">;</span>

<span class="token keyword">out</span> <span class="token keyword">vec2</span> outTexCoord<span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> modelViewMatrix<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> projectionMatrix<span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">float</span> texXOffset<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">float</span> texYOffset<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">int</span> numCols<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">int</span> numRows<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> projectionMatrix <span class="token operator">*</span> modelViewMatrix <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Support for texture atlas, update texture coordinates</span>
    <span class="token keyword">float</span> x <span class="token operator">=</span> <span class="token punctuation">(</span>texCoord<span class="token punctuation">.</span>x <span class="token operator">/</span> numCols <span class="token operator">+</span> texXOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> y <span class="token operator">=</span> <span class="token punctuation">(</span>texCoord<span class="token punctuation">.</span>y <span class="token operator">/</span> numRows <span class="token operator">+</span> texYOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>

    outTexCoord <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>As you can see we have now three new uniforms. The uniforms <code>numCols</code> and <code>numRows</code> contain the number of columns and rows of the texture atlas.  In order to calculate the texture coordinates, we first must scale down these parameters. Each tile will have a width which is equal to $$1 / numCols$$ and a height which is equal to $$1 / numRows$$ as shown in the next figure.</p> <p><img src="texture_coordinates.png" alt="Texture coordinates"><br>
Then we just need to apply and offset depending on the row and column. This is what is modelled by the <code>texXOffset</code> and <code>texYOffset</code> uniforms.</p> <p>We will calculate these offsets in the <code>Renderer</code> class as shown in the next fragment. We calculate the row and column that each particle is in according to its position and calculate the offset accordingly  as a multiple of tile’s width and height.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>mesh<span class="token punctuation">.</span><span class="token function">renderList</span><span class="token punctuation">(</span><span class="token punctuation">(</span>emitter<span class="token punctuation">.</span><span class="token function">getParticles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">GameItem</span> gameItem<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> col <span class="token operator">=</span> gameItem<span class="token punctuation">.</span><span class="token function">getTextPos</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> text<span class="token punctuation">.</span><span class="token function">getNumCols</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> row <span class="token operator">=</span> gameItem<span class="token punctuation">.</span><span class="token function">getTextPos</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> text<span class="token punctuation">.</span><span class="token function">getNumCols</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> textXOffset <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> col <span class="token operator">/</span> text<span class="token punctuation">.</span><span class="token function">getNumCols</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> textYOffset <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> row <span class="token operator">/</span> text<span class="token punctuation">.</span><span class="token function">getNumRows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    particlesShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;texXOffset&quot;</span><span class="token punctuation">,</span> textXOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    particlesShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;texYOffset&quot;</span><span class="token punctuation">,</span> textYOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>Note that if you only need to support perfectly square texture atlas, you will only need two uniforms. The final result looks like this.</p> <p><img src="animated_particles.png" alt="Animated particles"></p> <p>Now we have animated particles working. In the next chapter we will learn how to optimize the rendering process. We are currently rendering multiple elements that have the same mesh and we are performing a drawing call for each of them, and in the next chapter we will learn how to do it in a single call. That technique is not only useful for particles but also for rendering scenes where multiple elements share the same model but are placed in different locations or have different textures.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/CraftStarStudio/wjglbook-bookcontents-zh_CN/edit/master/chapter20/chapter20.md" target="_blank" rel="noopener noreferrer">帮助我们完善这个页面</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">最后更新 :</span> <span class="time">6/27/2021, 1:14:09 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/3d-game-development-with-lwjgl/chapter19/chapter19.html" class="prev">
        Animations
      </a></span> <span class="next"><a href="/3d-game-development-with-lwjgl/chapter21/chapter21.html">
        Instanced Rendering
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/3d-game-development-with-lwjgl/assets/js/app.519c1cc5.js" defer></script><script src="/3d-game-development-with-lwjgl/assets/js/2.e7870360.js" defer></script><script src="/3d-game-development-with-lwjgl/assets/js/29.d5befc6c.js" defer></script>
  </body>
</html>
