<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Optimizations - Frustum Culling \(I\) | 使用 LWJGL 3 开发 3D 游戏</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/3d-game-development-with-lwjgl/assets/css/0.styles.33e5fdc6.css" as="style"><link rel="preload" href="/3d-game-development-with-lwjgl/assets/js/app.519c1cc5.js" as="script"><link rel="preload" href="/3d-game-development-with-lwjgl/assets/js/2.e7870360.js" as="script"><link rel="preload" href="/3d-game-development-with-lwjgl/assets/js/34.7bde7785.js" as="script"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/10.7296f99c.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/11.a42afaf0.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/12.b7fdae6a.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/13.01b80f30.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/14.06f37286.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/15.c4635c97.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/16.f4253e97.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/17.c7f6896c.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/18.8a24c215.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/19.ab6ce5f4.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/20.9046ed34.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/21.3cb4242e.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/22.b2fa78a0.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/23.a9e504af.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/24.12580511.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/25.a115cf89.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/26.7193040d.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/27.4fa5cc0d.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/28.e559af67.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/29.d5befc6c.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/3.8fb1d8aa.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/30.ee00c5df.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/31.0effa8ac.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/32.c13100cf.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/33.c9fbfcdb.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/35.604c8847.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/36.ccd3a84c.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/37.ec274013.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/38.66d82b73.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/4.e1b9ee22.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/5.75c3f2db.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/6.601d5460.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/7.1f9c2020.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/8.be9c92d8.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/9.048bb756.js">
    <link rel="stylesheet" href="/3d-game-development-with-lwjgl/assets/css/0.styles.33e5fdc6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/3d-game-development-with-lwjgl/" class="home-link router-link-active"><!----> <span class="site-name">使用 LWJGL 3 开发 3D 游戏</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/3d-game-development-with-lwjgl/" aria-current="page" class="sidebar-link">封面</a></li><li><a href="/3d-game-development-with-lwjgl/INTRODUCTION.html" class="sidebar-link">简介</a></li><li><a href="/3d-game-development-with-lwjgl/chapter01/chapter1.html" class="sidebar-link">第一步</a></li><li><a href="/3d-game-development-with-lwjgl/chapter02/chapter2.html" class="sidebar-link">The Game Loop</a></li><li><a href="/3d-game-development-with-lwjgl/chapter03/chapter3.html" class="sidebar-link">A brief about coordinates</a></li><li><a href="/3d-game-development-with-lwjgl/chapter04/chapter4.html" class="sidebar-link">Rendering</a></li><li><a href="/3d-game-development-with-lwjgl/chapter05/chapter5.html" class="sidebar-link">More on Rendering</a></li><li><a href="/3d-game-development-with-lwjgl/chapter06/chapter6.html" class="sidebar-link">Transformations</a></li><li><a href="/3d-game-development-with-lwjgl/chapter07/chapter7.html" class="sidebar-link">Textures</a></li><li><a href="/3d-game-development-with-lwjgl/chapter08/chapter8.html" class="sidebar-link">Camera</a></li><li><a href="/3d-game-development-with-lwjgl/chapter09/chapter9.html" class="sidebar-link">Loading more complex models</a></li><li><a href="/3d-game-development-with-lwjgl/chapter10/chapter10.html" class="sidebar-link">Let there be light</a></li><li><a href="/3d-game-development-with-lwjgl/chapter11/chapter11.html" class="sidebar-link">Let there be even more light</a></li><li><a href="/3d-game-development-with-lwjgl/chapter12/chapter12.html" class="sidebar-link">Game HUD</a></li><li><a href="/3d-game-development-with-lwjgl/chapter13/chapter13.html" class="sidebar-link">Sky Box and some optimizations</a></li><li><a href="/3d-game-development-with-lwjgl/chapter14/chapter14.html" class="sidebar-link">Height Maps</a></li><li><a href="/3d-game-development-with-lwjgl/chapter15/chapter15.html" class="sidebar-link">Terrain Collisions</a></li><li><a href="/3d-game-development-with-lwjgl/chapter16/chapter16.html" class="sidebar-link">Fog</a></li><li><a href="/3d-game-development-with-lwjgl/chapter17/chapter17.html" class="sidebar-link">Normal Mapping</a></li><li><a href="/3d-game-development-with-lwjgl/chapter18/chapter18.html" class="sidebar-link">Shadows</a></li><li><a href="/3d-game-development-with-lwjgl/chapter19/chapter19.html" class="sidebar-link">Animations</a></li><li><a href="/3d-game-development-with-lwjgl/chapter20/chapter20.html" class="sidebar-link">Particles</a></li><li><a href="/3d-game-development-with-lwjgl/chapter21/chapter21.html" class="sidebar-link">Instanced Rendering</a></li><li><a href="/3d-game-development-with-lwjgl/chapter22/chapter22.html" class="sidebar-link">Audio</a></li><li><a href="/3d-game-development-with-lwjgl/chapter23/chapter23.html" class="sidebar-link">3D Object Picking</a></li><li><a href="/3d-game-development-with-lwjgl/chapter24/chapter24.html" class="sidebar-link">HUD Revisited - NanoVG</a></li><li><a href="/3d-game-development-with-lwjgl/chapter25/chapter25.html" aria-current="page" class="active sidebar-link">Optimizations - Frustum Culling \(I\)</a></li><li><a href="/3d-game-development-with-lwjgl/chapter26/chapter26.html" class="sidebar-link">Cascaded Shadow Maps</a></li><li><a href="/3d-game-development-with-lwjgl/chapter27/chapter27.html" class="sidebar-link">Assimp</a></li><li><a href="/3d-game-development-with-lwjgl/chapter28/chapter28.html" class="sidebar-link">Deferred Shading</a></li><li><a href="/3d-game-development-with-lwjgl/appendixa/appendixa.html" class="sidebar-link">Appendix A - OpenGL Debugging</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="optimizations-frustum-culling-i"><a href="#optimizations-frustum-culling-i" class="header-anchor">#</a> Optimizations - Frustum Culling (I)</h1> <p>At this moment we are using many different graphic effects, such as lights, particles, etc. In addition to that, we have learned how to instanced rendering to reduce the overhead of drawing many similar objects. However, we still have plenty of room for applying simple optimization techniques that will increase the Frames Per Second (FPS) that we can achieve.</p> <p>You may have wondered why are we drawing the whole list of GameItems every frame even if some of them will not be visible (because they are behind the camera or too far away). You may even think that this is handled automatically handled by OpenGL, and some way you are true. OpenGL will discard the rendering of vertices that fall off the visible area. This called clipping. The issue with clipping is that it’s done per vertex, after the vertex shader has been executed. Hence, even this operation saves resources, we can be more efficient by not trying to render objects that will not be visible. We would not be wasting resources by sending the data to the GPU and by performing transformations for every vertex that is part of those objects. We need to remove the objects that do are not contained into the view frustum, that is, we need to perform frustum culling.</p> <p>But, first let’s review what is the view frustum. The view frustum is a volume that contains every object that may be visible taking into consideration the camera position and rotation and the projection that we are using. Typically, the view frustum is a rectangular pyramid like shown in the next figure.</p> <p><img src="view_frustum_i.png" alt="View Frustum I"></p> <p>As you can see, the view frustum is defined by six planes, anything that lies outside the view frustum will not be rendering. So, frustum culling is the process of removing objects that are outside the view frustum.</p> <p>Thus, in order to perform frustum culling we need to:</p> <ul><li><p>Calculate frustum planes using the data contained in the view and projection matrices.</p></li> <li><p>For every GameItem, check if its contained inside that view frustum, that is, contained between the size frustum planes, and eliminate the ones that lie outside from the rendering process.</p></li></ul> <p><img src="view_frustum_ii.png" alt="View Frustum II"></p> <p>So let’s start by calculating the frustum planes. A plane, is defined by a point contained in it and a vector orthogonal to that plane, as shown in the next figure:</p> <p><img src="plane.png" alt="Plane"></p> <p>The equation of a plane is defined like this:</p> <p>$$Ax+By+Cz+D=0$$</p> <p>Hence, we need to calculate the six plane equations for the six sides of our view frustum. In order to to that you basically have two options. You can perform tedious calculations that will get you the six plane equations, that this, the four constants (A, B, C and D) from the previous equation. The other option is to let <a href="https://github.com/JOML-CI/JOML" title="JOML" target="_blank" rel="noopener noreferrer">JOML <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>library to calculate this for you. In this case, we will chose the last option.</p> <p>So let’s start coding. We will create a new class named <code>FrustumCullingFilter</code> which will perform, as its name states, filtering operations according to the view frustum.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FrustumCullingFilter</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> NUM_PLANES <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Matrix4f</span> prjViewMatrix<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Vector4f</span><span class="token punctuation">[</span><span class="token punctuation">]</span> frustumPlanes<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">FrustumCullingFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        prjViewMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        frustumPlanes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector4f</span><span class="token punctuation">[</span>NUM_PLANES<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NUM_PLANES<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            frustumPlanes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector4f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>The <code>FrustumCullingFilter</code> class will also have a method to calculate the plane equations called <code>updateFrustum</code> which will be called before rendering. The method is defined like this:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateFrustum</span><span class="token punctuation">(</span><span class="token class-name">Matrix4f</span> projMatrix<span class="token punctuation">,</span> <span class="token class-name">Matrix4f</span> viewMatrix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Calculate projection view matrix</span>
    prjViewMatrix<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>projMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    prjViewMatrix<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>viewMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Get frustum planes</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NUM_PLANES<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        prjViewMatrix<span class="token punctuation">.</span><span class="token function">frustumPlane</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> frustumPlanes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>First, we store a copy of the projection matrix and multiply it by the view matrix to get the projection view matrix. Then, with that transformation matrix we just simply need to invoke the <code>frustumPlane</code> method for each of the frustum planes. It’s important to note that these plane equations are expressed in world coordinates, so all the calculations need to be done in that space.</p> <p>Now that we have all the planes calculated we just need to check if the <code>GameItem</code> instances are inside the frustum or not. How can we do this? Let’s first examine how we can check if a point is inside the frustum. We can achieve that by calculating the signed distance of the point to each of the planes. If the distance of the point to the plane is positive, this means that the point is in front of the plane (according to its normal). If it’s negative, this means that the point is behind the plane.</p> <p><img src="/chapter25/distance_to_plane.png" alt="Distance to a plane"></p> <p>Therefore, a point will be inside the view frustum if the distance to all the planes of the frustum is positive. The distance of a point to the plane is defined like this:</p> <p>$$dist=Ax_{0}+By_{0}+Cz_{0}+D$$, where $$x_{0}$$, $$y_{0}$$ and $$z_{0}$$ are the coordinates of the point.</p> <p>So, a point is behind the plane if $$Ax_{0}+By_{0}+Cz_{0}+D &lt;= 0$$.</p> <p>But we do not have points, we have complex meshes, we cannot just use a point to check if an object is inside a frustum or not. You may think in checking every vertex of the <code>GameItem</code> and see if it’s inside the frustum or not. If any of the points is inside, the GameItem should be drawn. But this what OpenGL does in fact when clipping, this is what we are tying to avoid. Remember that frustum culling benefits will be more noticeable the more complex the meshes to be rendered are.</p> <p>We need to enclose every <code>GameItem</code> into a simple volume that is easy to check. Here we have basically two options:</p> <ul><li><p>Bounding boxes.</p></li> <li><p>Bounding spheres.</p></li></ul> <p>In this case, we will use spheres, since is the most simple approach. We will enclose every <code>GameItem</code> into a sphere and will check if the sphere is inside the view frustum or not. In order to do that, we just need the center and the radius of the sphere. The checks are almost equal to the point case, except that we need to take the radius into consideration. A sphere will be outside the frustum if it the following condition is met: $$dist=Ax_{0}+By_{0}+Cz_{0} &lt;= -radius$$.</p> <p><img src="/chapter25/bounding_sphere.png" alt="Bounding sphere"></p> <p>So, we will add a new method to the <code>FrustumCullingFilter</code> class to check if a sphere is inside the frustum or not. The method is defined like this.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">insideFrustum</span><span class="token punctuation">(</span><span class="token keyword">float</span> x0<span class="token punctuation">,</span> <span class="token keyword">float</span> y0<span class="token punctuation">,</span> <span class="token keyword">float</span> z0<span class="token punctuation">,</span> <span class="token keyword">float</span> boundingRadius<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NUM_PLANES<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Vector4f</span> plane <span class="token operator">=</span> frustumPlanes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>plane<span class="token punctuation">.</span>x <span class="token operator">*</span> x0 <span class="token operator">+</span> plane<span class="token punctuation">.</span>y <span class="token operator">*</span> y0 <span class="token operator">+</span> plane<span class="token punctuation">.</span>z <span class="token operator">*</span> z0 <span class="token operator">+</span> plane<span class="token punctuation">.</span>w <span class="token operator">&lt;=</span> <span class="token operator">-</span>boundingRadius<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>Then, we will add method that filters the GameItems that outside the view frustum:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GameItem</span><span class="token punctuation">&gt;</span></span> gameItems<span class="token punctuation">,</span> <span class="token keyword">float</span> meshBoundingRadius<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">float</span> boundingRadius<span class="token punctuation">;</span>
    <span class="token class-name">Vector3f</span> pos<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">GameItem</span> gameItem <span class="token operator">:</span> gameItems<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        boundingRadius <span class="token operator">=</span> gameItem<span class="token punctuation">.</span><span class="token function">getScale</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> meshBoundingRadius<span class="token punctuation">;</span>
        pos <span class="token operator">=</span> gameItem<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        gameItem<span class="token punctuation">.</span><span class="token function">setInsideFrustum</span><span class="token punctuation">(</span><span class="token function">insideFrustum</span><span class="token punctuation">(</span>pos<span class="token punctuation">.</span>x<span class="token punctuation">,</span> pos<span class="token punctuation">.</span>y<span class="token punctuation">,</span> pos<span class="token punctuation">.</span>z<span class="token punctuation">,</span> boundingRadius<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>We have added a new attribute, <code>insideFrustum</code>, to the <code>GameItem</code> class, to track the visibility. As you can see, the radius of the bounding sphere is passed as parameter This is due to the fact that the bounding sphere is associated to the <code>Mesh</code>, it’s not a property of the <code>GameItem</code>. But, remember that we must operate in world coordinates, and the radius of the bounding sphere will be in model space. We will transform it to world space by applying the scale that has been set up for the <code>GameItem</code>, We are assuming also that the position of the <code>GameItem</code> is the centre of the sphere (in world space coordinates).</p> <p>The last method, is just a utility one, that accepts the map of meshes and filters all the <code>GameItem</code> instances contained in it.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Mesh</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">GameItem</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> mapMesh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Mesh</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">GameItem</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> mapMesh<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GameItem</span><span class="token punctuation">&gt;</span></span> gameItems <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">filter</span><span class="token punctuation">(</span>gameItems<span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBoundingRadius</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>And that’s it. We can use that class inside the rendering process. We just need to update the frustum planes, calculate which GameItems are visible and filter them out when drawing instanced and non instanced meshes.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>frustumFilter<span class="token punctuation">.</span><span class="token function">updateFrustum</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span><span class="token function">getProjectionMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> camera<span class="token punctuation">.</span><span class="token function">getViewMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
frustumFilter<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>scene<span class="token punctuation">.</span><span class="token function">getGameMeshes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
frustumFilter<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>scene<span class="token punctuation">.</span><span class="token function">getGameInstancedMeshes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>You can play with activating and deactivating the filtering and can check the increase and decrease in the FPS that you can achieve. Particles are not considered in the filtering, but it's trivial to add it. In any case, for particles, it may be better to just check the position of the emitter instead of checking every particle.</p> <h1 id="optimizations-frustum-culling-ii"><a href="#optimizations-frustum-culling-ii" class="header-anchor">#</a> Optimizations - Frustum Culling (II)</h1> <p>Once the basis of frustum culling has been explained, we can get advantage of more refined methods that the <a href="https://github.com/JOML-CI/JOML" title="JOML" target="_blank" rel="noopener noreferrer">JOML<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> library provides. In particular, it provides a class named <code>FrustumIntersection</code> which extracts the planes of the view frustum in a more efficient way as described in this <a href="http://gamedevs.org/uploads/fast-extraction-viewing-frustum-planes-from-world-view-projection-matrix.pdf" title="paper" target="_blank" rel="noopener noreferrer">paper<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Besides that, this class also provides methods for testing bounding boxes, points and spheres.</p> <p>So, let's change the <code>FrustumCullingFilter</code> class. The attributes and constructor are simplified like this:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FrustumCullingFilter</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Matrix4f</span> prjViewMatrix<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">FrustumIntersection</span> frustumInt<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">FrustumCullingFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        prjViewMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        frustumInt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FrustumIntersection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>The <code>updateFrustum</code> method just delegates the plane extraction to the <code>FrustumIntersection</code> instance.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateFrustum</span><span class="token punctuation">(</span><span class="token class-name">Matrix4f</span> projMatrix<span class="token punctuation">,</span> <span class="token class-name">Matrix4f</span> viewMatrix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Calculate projection view matrix</span>
    prjViewMatrix<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>projMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    prjViewMatrix<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>viewMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Update frustum intersection class</span>
    frustumInt<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>prjViewMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>And the method that <code>insideFrustum</code> method is even simpler:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">insideFrustum</span><span class="token punctuation">(</span><span class="token keyword">float</span> x0<span class="token punctuation">,</span> <span class="token keyword">float</span> y0<span class="token punctuation">,</span> <span class="token keyword">float</span> z0<span class="token punctuation">,</span> <span class="token keyword">float</span> boundingRadius<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> frustumInt<span class="token punctuation">.</span><span class="token function">testSphere</span><span class="token punctuation">(</span>x0<span class="token punctuation">,</span> y0<span class="token punctuation">,</span> z0<span class="token punctuation">,</span> boundingRadius<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>With this approach you will even be able to get a few more FPS. Besides that, a global flag has been added to the <code>Window</code> class to enable / disable frustum culling. The <code>GameItem</code> class also has a flag for enabling / disabling the filtering, because there may be some items for which frustum culling filtering does not make sense.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/CraftStarStudio/wjglbook-bookcontents-zh_CN/edit/master/chapter25/chapter25.md" target="_blank" rel="noopener noreferrer">帮助我们完善这个页面</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">最后更新 :</span> <span class="time">6/27/2021, 1:14:09 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/3d-game-development-with-lwjgl/chapter24/chapter24.html" class="prev">
        HUD Revisited - NanoVG
      </a></span> <span class="next"><a href="/3d-game-development-with-lwjgl/chapter26/chapter26.html">
        Cascaded Shadow Maps
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/3d-game-development-with-lwjgl/assets/js/app.519c1cc5.js" defer></script><script src="/3d-game-development-with-lwjgl/assets/js/2.e7870360.js" defer></script><script src="/3d-game-development-with-lwjgl/assets/js/34.7bde7785.js" defer></script>
  </body>
</html>
