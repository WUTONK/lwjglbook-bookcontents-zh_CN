<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Animations | 使用 LWJGL 3 开发 3D 游戏</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/3d-game-development-with-lwjgl/assets/css/0.styles.33e5fdc6.css" as="style"><link rel="preload" href="/3d-game-development-with-lwjgl/assets/js/app.519c1cc5.js" as="script"><link rel="preload" href="/3d-game-development-with-lwjgl/assets/js/2.e7870360.js" as="script"><link rel="preload" href="/3d-game-development-with-lwjgl/assets/js/28.e559af67.js" as="script"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/10.7296f99c.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/11.a42afaf0.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/12.b7fdae6a.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/13.01b80f30.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/14.06f37286.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/15.c4635c97.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/16.f4253e97.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/17.c7f6896c.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/18.8a24c215.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/19.ab6ce5f4.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/20.9046ed34.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/21.3cb4242e.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/22.b2fa78a0.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/23.a9e504af.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/24.12580511.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/25.a115cf89.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/26.7193040d.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/27.4fa5cc0d.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/29.d5befc6c.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/3.8fb1d8aa.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/30.ee00c5df.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/31.0effa8ac.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/32.c13100cf.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/33.c9fbfcdb.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/34.7bde7785.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/35.604c8847.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/36.ccd3a84c.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/37.ec274013.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/38.66d82b73.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/4.e1b9ee22.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/5.75c3f2db.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/6.601d5460.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/7.1f9c2020.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/8.be9c92d8.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/9.048bb756.js">
    <link rel="stylesheet" href="/3d-game-development-with-lwjgl/assets/css/0.styles.33e5fdc6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/3d-game-development-with-lwjgl/" class="home-link router-link-active"><!----> <span class="site-name">使用 LWJGL 3 开发 3D 游戏</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/3d-game-development-with-lwjgl/" aria-current="page" class="sidebar-link">封面</a></li><li><a href="/3d-game-development-with-lwjgl/INTRODUCTION.html" class="sidebar-link">简介</a></li><li><a href="/3d-game-development-with-lwjgl/chapter01/chapter1.html" class="sidebar-link">第一步</a></li><li><a href="/3d-game-development-with-lwjgl/chapter02/chapter2.html" class="sidebar-link">The Game Loop</a></li><li><a href="/3d-game-development-with-lwjgl/chapter03/chapter3.html" class="sidebar-link">A brief about coordinates</a></li><li><a href="/3d-game-development-with-lwjgl/chapter04/chapter4.html" class="sidebar-link">Rendering</a></li><li><a href="/3d-game-development-with-lwjgl/chapter05/chapter5.html" class="sidebar-link">More on Rendering</a></li><li><a href="/3d-game-development-with-lwjgl/chapter06/chapter6.html" class="sidebar-link">Transformations</a></li><li><a href="/3d-game-development-with-lwjgl/chapter07/chapter7.html" class="sidebar-link">Textures</a></li><li><a href="/3d-game-development-with-lwjgl/chapter08/chapter8.html" class="sidebar-link">Camera</a></li><li><a href="/3d-game-development-with-lwjgl/chapter09/chapter9.html" class="sidebar-link">Loading more complex models</a></li><li><a href="/3d-game-development-with-lwjgl/chapter10/chapter10.html" class="sidebar-link">Let there be light</a></li><li><a href="/3d-game-development-with-lwjgl/chapter11/chapter11.html" class="sidebar-link">Let there be even more light</a></li><li><a href="/3d-game-development-with-lwjgl/chapter12/chapter12.html" class="sidebar-link">Game HUD</a></li><li><a href="/3d-game-development-with-lwjgl/chapter13/chapter13.html" class="sidebar-link">Sky Box and some optimizations</a></li><li><a href="/3d-game-development-with-lwjgl/chapter14/chapter14.html" class="sidebar-link">Height Maps</a></li><li><a href="/3d-game-development-with-lwjgl/chapter15/chapter15.html" class="sidebar-link">Terrain Collisions</a></li><li><a href="/3d-game-development-with-lwjgl/chapter16/chapter16.html" class="sidebar-link">Fog</a></li><li><a href="/3d-game-development-with-lwjgl/chapter17/chapter17.html" class="sidebar-link">Normal Mapping</a></li><li><a href="/3d-game-development-with-lwjgl/chapter18/chapter18.html" class="sidebar-link">Shadows</a></li><li><a href="/3d-game-development-with-lwjgl/chapter19/chapter19.html" aria-current="page" class="active sidebar-link">Animations</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/3d-game-development-with-lwjgl/chapter19/chapter19.html#introduction" class="sidebar-link">Introduction</a></li><li class="sidebar-sub-header"><a href="/3d-game-development-with-lwjgl/chapter19/chapter19.html#animate-the-model" class="sidebar-link">Animate the model</a></li><li class="sidebar-sub-header"><a href="/3d-game-development-with-lwjgl/chapter19/chapter19.html#correcting-animation-issues" class="sidebar-link">Correcting animation issues</a></li></ul></li><li><a href="/3d-game-development-with-lwjgl/chapter20/chapter20.html" class="sidebar-link">Particles</a></li><li><a href="/3d-game-development-with-lwjgl/chapter21/chapter21.html" class="sidebar-link">Instanced Rendering</a></li><li><a href="/3d-game-development-with-lwjgl/chapter22/chapter22.html" class="sidebar-link">Audio</a></li><li><a href="/3d-game-development-with-lwjgl/chapter23/chapter23.html" class="sidebar-link">3D Object Picking</a></li><li><a href="/3d-game-development-with-lwjgl/chapter24/chapter24.html" class="sidebar-link">HUD Revisited - NanoVG</a></li><li><a href="/3d-game-development-with-lwjgl/chapter25/chapter25.html" class="sidebar-link">Optimizations - Frustum Culling \(I\)</a></li><li><a href="/3d-game-development-with-lwjgl/chapter26/chapter26.html" class="sidebar-link">Cascaded Shadow Maps</a></li><li><a href="/3d-game-development-with-lwjgl/chapter27/chapter27.html" class="sidebar-link">Assimp</a></li><li><a href="/3d-game-development-with-lwjgl/chapter28/chapter28.html" class="sidebar-link">Deferred Shading</a></li><li><a href="/3d-game-development-with-lwjgl/appendixa/appendixa.html" class="sidebar-link">Appendix A - OpenGL Debugging</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="animations"><a href="#animations" class="header-anchor">#</a> Animations</h1> <h2 id="introduction"><a href="#introduction" class="header-anchor">#</a> Introduction</h2> <p>Until now we have only loaded static 3D models, but in this chapter we will learn how to animate them. When thinking about animations the first approach is to create different meshes for each model positions, load them up into the GPU and draw them sequentially to create the illusion of movement. Although this approach is perfect for some games, it's not very efficient in terms of memory consumption.</p> <p>This where skeletal animation comes to play. In skeletal animation the way a model animates is defined by its underlying skeleton. A skeleton is defined by a hierarchy of special points called joints. These joints are defined by their position and rotation. We have said also that it's a hierarchy, which means that the final position for each joint is affected by the position of their parents. For instance, think of a wrist: the position of a wrist is modified if a character moves the elbow and also if it moves the shoulder.</p> <p>Joints do not need to represent a physical bone or articulation: they are artifacts that allow the creatives to model an animation. In addition to joints we still have vertices, the points that define the triangles that compose a 3D model. But in skeletal animation, vertices are drawn based on the position of the joints they relate to.</p> <p>In this chapter we will use the MD5 format to load animated models. MD5 was created by ID Software, the creators of Doom, and it’s basically a text based file format which is well understood. Another approach would be to use the <a href="https://en.wikipedia.org/wiki/COLLADA" target="_blank" rel="noopener noreferrer">Collada<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> format, which is a public standard supported by many tools. Collada is an XML based format but as a downside it’s very complex (the specification for the 1.5 version has more than 500 pages). So, we will stick to a much more simple format, MD5, that will allow us to focus on the concepts of the skeletal animation and to create a working sample.</p> <p>You can also export some models from Blender to MD5 format via specific addons that you can find on the Internet (<a href="">http://www.katsbits.com/tools/#md5</a>)</p> <p>In this chapter I’ve consulted many different sources, but I  have found two that provide a very good explanation about how to create an animated model using MD5 files. Theses sources can be consulted at:</p> <ul><li><a href="http://www.3dgep.com/gpu-skinning-of-md5-models-in-opengl-and-cg/" target="_blank" rel="noopener noreferrer">http://www.3dgep.com/gpu-skinning-of-md5-models-in-opengl-and-cg/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://ogldev.atspace.co.uk/www/tutorial38/tutorial38.html" target="_blank" rel="noopener noreferrer">http://ogldev.atspace.co.uk/www/tutorial38/tutorial38.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>So let’s start by writing the code that parses MD5 files. The MD5 format defines two types of files:</p> <ul><li>The mesh definition file: this defines the joints, the vertices and textures that compose the set of meshes that form the 3D model. This file usually has a extension named “.md5mesh”.</li> <li>The animation definition file: this defines the animations that can be applied to the model. This file usually has a extension named “.md5anim”.</li></ul> <p>An MD5 file is composed by a header and different sections contained between braces. Let’s start examining the mesh definition file. In the resources folder you will find several models in MD5 format. If you open one of them you can see a structure similar to this.</p> <p><img src="md5_model_structure.png" alt="MD5 Structure"></p> <p>The first structure that you can find in the mesh definition file is the header. You can see below the header content from one of the samples provided:</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>MD5Version 10
commandline &quot;&quot;

numJoints 33
numMeshes 6
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>The header defines the following attributes:</p> <ul><li>The version of the MD5 specification that it complies to.</li> <li>The command used to generate this file (from a 3D modelling tool).</li> <li>The number of Joints that are defined in the joints section.</li> <li>The number of Meshes (the number of meshes sections expected).</li></ul> <p>The Joints sections defines the joints, as it names states, their positions and their relationships. A fragment of the joints section of one of the sample models is shown below.</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>joints {
    &quot;origin&quot;    -1 ( -0.000000 0.016430 -0.006044 ) ( 0.707107 0.000000 0.707107 )        // 
    &quot;sheath&quot;    0 ( 11.004813 -3.177138 31.702473 ) ( 0.307041 -0.578614 0.354181 )        // origin
    &quot;sword&quot;    1 ( 9.809593 -9.361549 40.753730 ) ( 0.305557 -0.578155 0.353505 )        // sheath
    &quot;pubis&quot;    0 ( 0.014076 2.064442 26.144581 ) ( -0.466932 -0.531013 -0.466932 )        // origin
              ……
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>A Joint is defined by the following attributes:</p> <ul><li>Joint name, a textual attribute between quotes.</li> <li>Joint parent, using an index which points to the  parent joint using its position in the joints list. The root joint has a parent equals to -1.</li> <li>Joint position, defined in  model space coordinate system.</li> <li>Joint orientation, defined also in model space coordinate system. The orientation in fact is a quaternion whose w-component is not included.</li></ul> <p>Before continuing explaining the rest of the file let’s talk about quaternions. Quaternions are four component elements that are used to represent rotation. Up to now, we have been using Euler angles (yaw, pitch and roll) to define rotations, which basically define rotation around the x, y and z angles. However, Euler angles present some problems when working with rotations: specifically, you must be aware of the correct order of applying rotations and some operations can get very complex.</p> <p>This where quaternions come to help in order to solve this complexity. As it has been said before a quaternion is defined as a set of 4 numbers (x, y, z, w). Quaternions define a rotation axis and the rotation angle around that axis.</p> <p><img src="quaternion.png" alt="Quaternion"></p> <p>You can check in the web the mathematical definition of each of the components but the good news is that JOML, the math library we are using, provides support for them. We can construct rotation matrices based on quaternions and perform some transformation to vectors with them.</p> <p>Let’s get back to the joints definition, the $$w$$ component is missing but it can be easily calculated with the help of the rest of the values. You can check the source code to see how it's done.</p> <p>After the joints definition you can find the definition of the different meshes that compose a model. Below you can find a fragment of a Mesh definition from one of the samples.</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>mesh {
    shader &quot;/textures/bob/guard1_body.png&quot;

    numverts 494
    vert 0 ( 0.394531 0.513672 ) 0 1
    vert 1 ( 0.447266 0.449219 ) 1 2
    ...
    vert 493 ( 0.683594 0.455078 ) 864 3

    numtris 628
    tri 0 0 2 1
    tri 1 0 1 3
    ...
    tri 627 471 479 493

    numweights 867
    weight 0 5 1.000000 ( 6.175774 8.105262 -0.023020 )
    weight 1 5 0.500000 ( 4.880173 12.805251 4.196980 )
    ...
    weight 866 6 0.333333 ( 1.266308 -0.302701 8.949338 )
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>Let’s review the structure presented above:</p> <ul><li>A Mesh starts by defining a texture file. Keep in mind that the path that you will find here is the one used by the tool that created that model. That path may not match the one that is used to load those files. You have two approaches here, either you change the base path dynamically or either you change that path by hand. I’ve chosen the latter one, the simpler one.</li> <li>Next you can find the vertices definition. A vertex is defined by the following attributes:</li> <li><ul><li>Vertex index.</li></ul></li> <li><ul><li>Texture coordinates.</li></ul></li> <li><ul><li>The index of the first weight definition that affects this vertex.</li></ul></li> <li><ul><li>The number of weights to consider.</li></ul></li> <li>After the vertices, the triangles that form this mesh are defined. The triangles define the way that vertices are organized using their indices.</li> <li>Finally, the weights are defined. A Weight definition is composed by:</li> <li><ul><li>A Weight index.</li></ul></li> <li><ul><li>A Joint index, which points to the joint related to this weight.</li></ul></li> <li><ul><li>A bias factor, which is used to modulate the effect of this weight.</li></ul></li> <li><ul><li>A position of this weight.</li></ul></li></ul> <p>The following picture depicts the relation between the components described above using sample data.</p> <p><img src="mesh_elements.png" alt="Mesh elements"></p> <p>Now that we understand the mesh model file we can parse it. If you look at the source code you will see that a new package has been created to host parsers for model formats. There’s one for OBJ files under <code>org.lwjglb.engine.loaders.obj</code> and the code for MD5 files is under <code>org.lwjglb.engine.loaders.md5</code>.</p> <p>All the parsing code is based on regular expressions to extract the information from the MD5 text files. The parsers will create a hierarchy of objects that mimic the structure of the information components contained in the MD5 files. It may not be the most efficient parser in the world but I think it will serve to better understand the process.</p> <p>The starting class to parse a MD5 model file is <code>MD5Model</code> class. This class receives as a parameter in its parse method the contents of a MD5 file and creates a hierarchy that contains the header, the list of joints and the list of meshes with all the subelements. The code is very straightforward so, I won’t include it here.</p> <p>A few comments about the parsing code:</p> <ul><li>The subelements of a Mesh are defined as inner classes inside the <code>MD5Mesh</code> class.</li> <li>You can check how the fourth component of the joints orientation are calculated in the <code>calculateQuaternion</code> method form the <code>MD5Utils</code> class.</li></ul> <p>Now that we have parsed a file we must transform that object hierarchy into something that can be processed by the game Engine, we must create a <code>GameItem</code> instance. In order to do that we will  create a new class named <code>MD5Loader</code> that will take a <code>MD5Model</code> instance and will construct a <code>GameItem</code>.</p> <p>Before we start, as you noticed, a MD5 model has several Meshes, but our <code>GameItem</code> class only supports a single Mesh. We need to change this first, the class <code>GameItem</code> now looks like this.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>lwjglb<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>items</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>joml<span class="token punctuation">.</span></span><span class="token class-name">Vector3f</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>lwjglb<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>graph<span class="token punctuation">.</span></span><span class="token class-name">Mesh</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GameItem</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Mesh</span><span class="token punctuation">[</span><span class="token punctuation">]</span> meshes<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Vector3f</span> position<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">float</span> scale<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Vector3f</span> rotation<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">GameItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        position <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scale <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        rotation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">GameItem</span><span class="token punctuation">(</span><span class="token class-name">Mesh</span> mesh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>meshes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mesh</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>mesh<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">GameItem</span><span class="token punctuation">(</span><span class="token class-name">Mesh</span><span class="token punctuation">[</span><span class="token punctuation">]</span> meshes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>meshes <span class="token operator">=</span> meshes<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Vector3f</span> <span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> position<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token keyword">float</span> x<span class="token punctuation">,</span> <span class="token keyword">float</span> y<span class="token punctuation">,</span> <span class="token keyword">float</span> z<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>position<span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>position<span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>position<span class="token punctuation">.</span>z <span class="token operator">=</span> z<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">float</span> <span class="token function">getScale</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> scale<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setScale</span><span class="token punctuation">(</span><span class="token keyword">float</span> scale<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>scale <span class="token operator">=</span> scale<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Vector3f</span> <span class="token function">getRotation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> rotation<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRotation</span><span class="token punctuation">(</span><span class="token keyword">float</span> x<span class="token punctuation">,</span> <span class="token keyword">float</span> y<span class="token punctuation">,</span> <span class="token keyword">float</span> z<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rotation<span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rotation<span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rotation<span class="token punctuation">.</span>z <span class="token operator">=</span> z<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Mesh</span> <span class="token function">getMesh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> meshes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Mesh</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getMeshes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> meshes<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMeshes</span><span class="token punctuation">(</span><span class="token class-name">Mesh</span><span class="token punctuation">[</span><span class="token punctuation">]</span> meshes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>meshes <span class="token operator">=</span> meshes<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMesh</span><span class="token punctuation">(</span><span class="token class-name">Mesh</span> mesh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>meshes <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Mesh</span> currMesh <span class="token operator">:</span> meshes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                currMesh<span class="token punctuation">.</span><span class="token function">cleanUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>meshes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mesh</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>mesh<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br></div></div><p>With the modification above we can now define the contents for the <code>MD5Loader</code> class. This class will have a method named <code>process</code> that will receive a <code>MD5Model</code> instance and a default colour (for the meshes that do not define a texture) and will return a <code>GameItem</code> instance. The body of that method is shown below.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">GameItem</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">MD5Model</span> md5Model<span class="token punctuation">,</span> <span class="token class-name">Vector4f</span> defaultColour<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MD5Mesh</span><span class="token punctuation">&gt;</span></span> md5MeshList <span class="token operator">=</span> md5Model<span class="token punctuation">.</span><span class="token function">getMeshes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Mesh</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MD5Mesh</span> md5Mesh <span class="token operator">:</span> md5Model<span class="token punctuation">.</span><span class="token function">getMeshes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Mesh</span> mesh <span class="token operator">=</span> <span class="token function">generateMesh</span><span class="token punctuation">(</span>md5Model<span class="token punctuation">,</span> md5Mesh<span class="token punctuation">,</span> defaultColour<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">handleTexture</span><span class="token punctuation">(</span>mesh<span class="token punctuation">,</span> md5Mesh<span class="token punctuation">,</span> defaultColour<span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mesh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Mesh</span><span class="token punctuation">[</span><span class="token punctuation">]</span> meshes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mesh</span><span class="token punctuation">[</span>list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    meshes <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>meshes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">GameItem</span> gameItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GameItem</span><span class="token punctuation">(</span>meshes<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> gameItem<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>As you can see we just iterate over the meshes defined into the <code>MD5Model</code> class and transform them into instances of the class <code>org.lwjglb.engine.graph.Mesh</code> by using the <code>generateMesh</code> method which is the one that really does the work. Before we examine that method we will create an inner class that will serve us to build the positions and normals array.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">VertexInfo</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">Vector3f</span> position<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Vector3f</span> normal<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">VertexInfo</span><span class="token punctuation">(</span><span class="token class-name">Vector3f</span> position<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>position <span class="token operator">=</span> position<span class="token punctuation">;</span>
        normal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">VertexInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        position <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        normal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">toPositionsArr</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VertexInfo</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> length <span class="token operator">=</span> list <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">float</span><span class="token punctuation">[</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">VertexInfo</span> v <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">.</span>position<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
            result<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">.</span>position<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
            result<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">.</span>position<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
            i <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">toNormalArr</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VertexInfo</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> length <span class="token operator">=</span> list <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">float</span><span class="token punctuation">[</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">VertexInfo</span> v <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">.</span>normal<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
            result<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">.</span>normal<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
            result<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">.</span>normal<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
            i <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>Let’s get back to the <code>generateMesh</code> method, the first we do is get the mesh vertices information, the weights and the structure of the joints.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Mesh</span> <span class="token function">generateMesh</span><span class="token punctuation">(</span><span class="token class-name">MD5Model</span> md5Model<span class="token punctuation">,</span> <span class="token class-name">MD5Mesh</span> md5Mesh<span class="token punctuation">,</span> <span class="token class-name">Vector4f</span> defaultColour<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VertexInfo</span><span class="token punctuation">&gt;</span></span> vertexInfoList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Float</span><span class="token punctuation">&gt;</span></span> textCoords <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> indices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MD5Mesh<span class="token punctuation">.</span>MD5Vertex</span><span class="token punctuation">&gt;</span></span> vertices <span class="token operator">=</span> md5Mesh<span class="token punctuation">.</span><span class="token function">getVertices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MD5Mesh<span class="token punctuation">.</span>MD5Weight</span><span class="token punctuation">&gt;</span></span> weights <span class="token operator">=</span> md5Mesh<span class="token punctuation">.</span><span class="token function">getWeights</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MD5JointInfo<span class="token punctuation">.</span>MD5JointData</span><span class="token punctuation">&gt;</span></span> joints <span class="token operator">=</span> md5Model<span class="token punctuation">.</span><span class="token function">getJointInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getJoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>Then we need to calculate the vertices position based on the information contained in the weights and joints. This is done in the following block:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MD5Mesh<span class="token punctuation">.</span>MD5Vertex</span> vertex <span class="token operator">:</span> vertices<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Vector3f</span> vertexPos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Vector2f</span> vertexTextCoords <span class="token operator">=</span> vertex<span class="token punctuation">.</span><span class="token function">getTextCoords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        textCoords<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vertexTextCoords<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
        textCoords<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vertexTextCoords<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> startWeight <span class="token operator">=</span> vertex<span class="token punctuation">.</span><span class="token function">getStartWeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> numWeights <span class="token operator">=</span> vertex<span class="token punctuation">.</span><span class="token function">getWeightCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> startWeight<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> startWeight <span class="token operator">+</span> numWeights<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">MD5Mesh<span class="token punctuation">.</span>MD5Weight</span> weight <span class="token operator">=</span> weights<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">MD5JointInfo<span class="token punctuation">.</span>MD5JointData</span> joint <span class="token operator">=</span> joints<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>weight<span class="token punctuation">.</span><span class="token function">getJointIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Vector3f</span> rotatedPos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span>weight<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rotate</span><span class="token punctuation">(</span>joint<span class="token punctuation">.</span><span class="token function">getOrientation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Vector3f</span> acumPos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span>joint<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rotatedPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
            acumPos<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>weight<span class="token punctuation">.</span><span class="token function">getBias</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            vertexPos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>acumPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

       vertexInfoList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">VertexInfo</span><span class="token punctuation">(</span>vertexPos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>Let’s examine what we are doing here. We iterate over the vertices information and store the texture coordinates in a list, no need to apply any transformation here. Then we get the starting and total number of weights to consider to calculate the vertex position.</p> <p>The vertex position is calculated by using all the weights that is related to. Each weights has a position and a bias. The sum of all bias of the weights associated to each vertex must be equal to 1.0. Each weight also has a position which is defined in the joint’s local space, so we need to transform it to model space coordinates using the joint’s orientation and position (as if it were a transformation matrix) to which it refers to.</p> <p>To sum up, the vertex position can be expressed by this formula:</p> <p>$$Vpos = \sum\limits_{i=ws}^{ws + wc} (Jt_{i} \times Wp_{i}) \dot Wb_{i}$$</p> <p>Where:</p> <ul><li>The summation starts from $$ws$$ (Weight start) up to $$wc$$ (Weight count) weights.</li> <li>$$Jt_{i}$$ is the joint’s transformation matrix associated to the weight $$W_{i}$$.</li> <li>$$Wp_{i}$$ is the weight position.</li> <li>$$Wb_{i}$$ is the weight bias.</li></ul> <p>This equation is what we implement in the body of the loop (we do not have the transformation matrix since we have the joint position and rotation separately but the result is the same).</p> <p>With the code above we will be able to construct the positions and texture coordinates data but we still need to build up the indices and the normals. Indices can be calculated by using the triangles information, just by iterating through the list that holds those triangles.</p> <p>Normals can be calculated also using triangles information. Let $$V_{0}$$, $$V_{1}$$ and $$V_{2}$$ be the triangle vertices (in object’s model space). The normal for the triangle can be calculated according to this formula:</p> <p>$$N=(V_{2}-V_{0})\times(V_{1}-V_{0})$$</p> <p>Where N should be normalized after. The following figure shows the geometric interpretation of the formula above.</p> <p><img src="nomal_calculation.png" alt="Normal calculation"></p> <p>For each vertex we compute its normal by the normalized sum of all the normals of the triangles it belongs to. The code that performs those calculations is shown below.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MD5Mesh<span class="token punctuation">.</span>MD5Triangle</span> tri <span class="token operator">:</span> md5Mesh<span class="token punctuation">.</span><span class="token function">getTriangles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        indices<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tri<span class="token punctuation">.</span><span class="token function">getVertex0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        indices<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tri<span class="token punctuation">.</span><span class="token function">getVertex1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        indices<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tri<span class="token punctuation">.</span><span class="token function">getVertex2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Normals</span>
        <span class="token class-name">VertexInfo</span> v0 <span class="token operator">=</span> vertexInfoList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>tri<span class="token punctuation">.</span><span class="token function">getVertex0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">VertexInfo</span> v1 <span class="token operator">=</span> vertexInfoList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>tri<span class="token punctuation">.</span><span class="token function">getVertex1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">VertexInfo</span> v2 <span class="token operator">=</span> vertexInfoList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>tri<span class="token punctuation">.</span><span class="token function">getVertex2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Vector3f</span> pos0 <span class="token operator">=</span> v0<span class="token punctuation">.</span>position<span class="token punctuation">;</span>
        <span class="token class-name">Vector3f</span> pos1 <span class="token operator">=</span> v1<span class="token punctuation">.</span>position<span class="token punctuation">;</span>
        <span class="token class-name">Vector3f</span> pos2 <span class="token operator">=</span> v2<span class="token punctuation">.</span>position<span class="token punctuation">;</span>

        <span class="token class-name">Vector3f</span> normal <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span>pos2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>pos0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cross</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span>pos1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>pos0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        v0<span class="token punctuation">.</span>normal<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>normal<span class="token punctuation">)</span><span class="token punctuation">;</span>
        v1<span class="token punctuation">.</span>normal<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>normal<span class="token punctuation">)</span><span class="token punctuation">;</span>
        v2<span class="token punctuation">.</span>normal<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>normal<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

     <span class="token comment">// Once the contributions have been added, normalize the result</span>
     <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">VertexInfo</span> v <span class="token operator">:</span> vertexInfoList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        v<span class="token punctuation">.</span>normal<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>Then we just need to transform the Lists to arrays and process the texture information.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>     <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> positionsArr <span class="token operator">=</span> <span class="token class-name">VertexInfo</span><span class="token punctuation">.</span><span class="token function">toPositionsArr</span><span class="token punctuation">(</span>vertexInfoList<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> textCoordsArr <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">listToArray</span><span class="token punctuation">(</span>textCoords<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> normalsArr <span class="token operator">=</span> <span class="token class-name">VertexInfo</span><span class="token punctuation">.</span><span class="token function">toNormalArr</span><span class="token punctuation">(</span>vertexInfoList<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> indicesArr <span class="token operator">=</span> indices<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mapToInt</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token class-name">Mesh</span> mesh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mesh</span><span class="token punctuation">(</span>positionsArr<span class="token punctuation">,</span> textCoordsArr<span class="token punctuation">,</span> normalsArr<span class="token punctuation">,</span> indicesArr<span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token keyword">return</span> mesh<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>Going back to the <code>process</code> method you can see that there's a method named <code>handleTexture</code>, which is responsible for loading textures. This is the definition of that method:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">handleTexture</span><span class="token punctuation">(</span><span class="token class-name">Mesh</span> mesh<span class="token punctuation">,</span> <span class="token class-name">MD5Mesh</span> md5Mesh<span class="token punctuation">,</span> <span class="token class-name">Vector4f</span> defaultColour<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> texturePath <span class="token operator">=</span> md5Mesh<span class="token punctuation">.</span><span class="token function">getTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>texturePath <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> texturePath<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Texture</span> texture <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Texture</span><span class="token punctuation">(</span>texturePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Material</span> material <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Material</span><span class="token punctuation">(</span>texture<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Handle normal Maps;</span>
        <span class="token keyword">int</span> pos <span class="token operator">=</span> texturePath<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pos <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> basePath <span class="token operator">=</span> texturePath<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> extension <span class="token operator">=</span> texturePath<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> texturePath<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> normalMapFileName <span class="token operator">=</span> basePath <span class="token operator">+</span> NORMAL_FILE_SUFFIX <span class="token operator">+</span> extension<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">existsResourceFile</span><span class="token punctuation">(</span>normalMapFileName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Texture</span> normalMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Texture</span><span class="token punctuation">(</span>normalMapFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                material<span class="token punctuation">.</span><span class="token function">setNormalMap</span><span class="token punctuation">(</span>normalMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        mesh<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span>material<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        mesh<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Material</span><span class="token punctuation">(</span>defaultColour<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>The implementation is very straightforward. The only peculiarity is that if a mesh defines a texture named “texture.png” its normal texture map will be defined in a file “texture_normal.png”. We need to check if that file exists and load it accordingly.</p> <p>We can now load a MD5 file and render it as we render other GameItems, but before doing that we need to disable cull face in order to render it properly since not all the triangles will be drawn in the correct direction. We will add support to the Window class to set these parameters at runtime (you can check it in the source code the changes).</p> <p>If you load some of the sample models you will get something like this.</p> <p><img src="binding_pose.png" alt="Binding pose"></p> <p>What you see here is the binding pose, it’s the static representation of the MD5 model used for the animators  to model them easily.  In order to get animation to work we must process the animation definition file.</p> <h2 id="animate-the-model"><a href="#animate-the-model" class="header-anchor">#</a> Animate the model</h2> <p>A MD5 animation definition file, like the model definition one, is composed by a header and different sections contained between braces. If you open one of those files you can see a structure similar like this.</p> <p><img src="md5_animation_structure.png" alt="MD5 Animation structure"><br>
The first structure that you can find in the animation file, as in the case of the mesh definition file, is the header. You can see below header’s content from one of the samples provided:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>MD5Version 10
commandline &quot;&quot;

numFrames 140
numJoints 33
frameRate 24
numAnimatedComponents 198
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>The header defines the following attributes:</p> <ul><li>The version of the MD5 specification that it complies to.</li> <li>The command used to generate this file (from a 3D modelling tool).</li> <li>The number frames defined in the file.</li> <li>The number of joints defined in the hierarchy section.</li> <li>The frame rate, frames per second, that was used while creating this animation. This parameter can be used to calculate the time between frames.</li> <li>The number of components that each frame defines.</li></ul> <p>The hierarchy section is the one that comes first and defines the joints for this animation. You can see a fragment below:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>hierarchy {
    &quot;origin&quot;    -1 0 0    //
    &quot;body&quot;    0 63 0    // origin ( Tx Ty Tz Qx Qy Qz )
    &quot;body2&quot;    1 0 0    // body
    &quot;SPINNER&quot;    2 56 6    // body2 ( Qx Qy Qz )
    ....
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>A joint. In the hierarchy section, is defined by the following attributes:</p> <ul><li>Joint name, a textual attribute between quotes.</li> <li>Joint parent, using an index which points to the  parent joint using its position in the joints list. The root joint has a parent equals to -1.</li> <li>Joint flags, which set how this joint's position and orientation will be changed according to the data defined in each animation frame.</li> <li>The start index, inside the animation data of each frame that is used when applying the flags.</li></ul> <p>The next section is the bounds one. This section defines a bounding box which contains the model for each animation frame. It will contain a line for each of the animation frames and it looks like this:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>bounds {
    ( -24.3102264404 -44.2608566284 -0.181215778 ) ( 31.0861988068 38.7131576538 117.7417449951 )
    ( -24.3102283478 -44.1887664795 -0.1794649214 ) ( 31.1800289154 38.7173080444 117.7729110718 )
    ( -24.3102359772 -44.1144447327 -0.1794776917 ) ( 31.2042789459 38.7091217041 117.8352737427 )
    ....
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Each bounding box is defined by two 3 component vectors in model space coordinates. The first vector defines the minimum bound  and the second one the maximum.</p> <p>The next section is the base frame data. In this section, the position and orientation of each joint is set up before the deformations of each animation frame are applied. You can see a fragment below:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>baseframe {
    ( 0 0 0 ) ( -0.5 -0.5 -0.5 )
    ( -0.8947336078 70.7142486572 -6.5027675629 ) ( -0.3258574307 -0.0083037354 0.0313780755 )
    ( 0.0000001462 0.0539700091 -0.0137935728 ) ( 0 0 0 )
    ....
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Each line is associated to a joint and define the following attributes:</p> <ul><li>Position of the joint, as a three components vector.</li> <li>Orientation of the joint, as the three components of a quaternion (as in the model file).</li></ul> <p>After that you will find several frame definitions, as many as the value assigned to the numFrames header attribute. Each frame section is like a huge array of floats that will be used by the joints when applying the transformations for each frame. You can see a fragment below.</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>frame 1 {
     -0.9279100895 70.682762146 -6.3709330559 -0.3259022534 -0.0100501738 0.0320306309
     0.3259022534 0.0100501738 -0.0320306309
     -0.1038384438 -0.1639953405 -0.0152553488 0.0299418624
     ....
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>The base class that parses a MD5 animation file is named <code>MD5AnimModel</code>. This class creates all the objects hierarchy that maps the contents of that file and you can check the source code for the details. The structure is similar to the MD5 model definition file.  Now that we are able to load that information we will use it to generate an animation.</p> <p>We will generate the animation in the shader, so instead of pre-calculating all the positions for each frame we need to prepare the data we need so in the vertex shader we can compute the final positions.<br>
Let’s get back to the process method in the <code>MD5Loader</code> class, we need to modify it to take into consideration the animation information. The new definition for that method is shown below:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">AnimGameItem</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">MD5Model</span> md5Model<span class="token punctuation">,</span> <span class="token class-name">MD5AnimModel</span> animModel<span class="token punctuation">,</span> <span class="token class-name">Vector4f</span> defaultColour<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Matrix4f</span><span class="token punctuation">&gt;</span></span> invJointMatrices <span class="token operator">=</span> <span class="token function">calcInJointMatrices</span><span class="token punctuation">(</span>md5Model<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AnimatedFrame</span><span class="token punctuation">&gt;</span></span> animatedFrames <span class="token operator">=</span> <span class="token function">processAnimationFrames</span><span class="token punctuation">(</span>md5Model<span class="token punctuation">,</span> animModel<span class="token punctuation">,</span> invJointMatrices<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Mesh</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MD5Mesh</span> md5Mesh <span class="token operator">:</span> md5Model<span class="token punctuation">.</span><span class="token function">getMeshes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Mesh</span> mesh <span class="token operator">=</span> <span class="token function">generateMesh</span><span class="token punctuation">(</span>md5Model<span class="token punctuation">,</span> md5Mesh<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">handleTexture</span><span class="token punctuation">(</span>mesh<span class="token punctuation">,</span> md5Mesh<span class="token punctuation">,</span> defaultColour<span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mesh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Mesh</span><span class="token punctuation">[</span><span class="token punctuation">]</span> meshes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mesh</span><span class="token punctuation">[</span>list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    meshes <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>meshes<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">AnimGameItem</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnimGameItem</span><span class="token punctuation">(</span>meshes<span class="token punctuation">,</span> animatedFrames<span class="token punctuation">,</span> invJointMatrices<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>There are some changes here, the most obvious is that the method now receives a <code>MD5AnimModel</code> instance. The next one is that we do not return a <code>GameItem</code> instance but an <code>AnimGameItem</code> one. This class inherits from the <code>GameItem</code> class but adds support for animations. We will see why this was done this way later.</p> <p>If we continue with the process method, the first thing we do is calling the <code>calcInJointMatrices</code> method, which is defined like this:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Matrix4f</span><span class="token punctuation">&gt;</span></span> <span class="token function">calcInJointMatrices</span><span class="token punctuation">(</span><span class="token class-name">MD5Model</span> md5Model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Matrix4f</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MD5JointInfo<span class="token punctuation">.</span>MD5JointData</span><span class="token punctuation">&gt;</span></span> joints <span class="token operator">=</span> md5Model<span class="token punctuation">.</span><span class="token function">getJointInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getJoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">MD5JointInfo<span class="token punctuation">.</span>MD5JointData</span> joint <span class="token operator">:</span> joints<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Matrix4f</span> translateMat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>joint<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Matrix4f</span> rotationMat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rotate</span><span class="token punctuation">(</span>joint<span class="token punctuation">.</span><span class="token function">getOrientation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Matrix4f</span> mat <span class="token operator">=</span> translateMat<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>rotationMat<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mat<span class="token punctuation">.</span><span class="token function">invert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mat<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>This method iterates over the joints contained in the MD5 model definition file, calculates the transformation matrix associated to each joint and then it gets the inverse of those matrices. This information is used to construct the AnimationGameItem instance.</p> <p>Let’s continue with the <code>process</code> method, the next thing we do is process the animation frames by calling the <code>processAnimationFrames</code> method:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AnimatedFrame</span><span class="token punctuation">&gt;</span></span> <span class="token function">processAnimationFrames</span><span class="token punctuation">(</span><span class="token class-name">MD5Model</span> md5Model<span class="token punctuation">,</span> <span class="token class-name">MD5AnimModel</span> animModel<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Matrix4f</span><span class="token punctuation">&gt;</span></span> invJointMatrices<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AnimatedFrame</span><span class="token punctuation">&gt;</span></span> animatedFrames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MD5Frame</span><span class="token punctuation">&gt;</span></span> frames <span class="token operator">=</span> animModel<span class="token punctuation">.</span><span class="token function">getFrames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">MD5Frame</span> frame <span class="token operator">:</span> frames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AnimatedFrame</span> data <span class="token operator">=</span> <span class="token function">processAnimationFrame</span><span class="token punctuation">(</span>md5Model<span class="token punctuation">,</span> animModel<span class="token punctuation">,</span> frame<span class="token punctuation">,</span> invJointMatrices<span class="token punctuation">)</span><span class="token punctuation">;</span>
        animatedFrames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> animatedFrames<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>This method process each animation frame, defined in the MD5 animation definition file, and returns a list of <code>AnimatedFrame</code> instances. The real work is done in the <code>processAnimationFrame</code> method. Let’s explain what this method will do.</p> <p>We first iterate over the joints defined in the hierarchy section in the MD5 animation file.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">AnimatedFrame</span> <span class="token function">processAnimationFrame</span><span class="token punctuation">(</span><span class="token class-name">MD5Model</span> md5Model<span class="token punctuation">,</span> <span class="token class-name">MD5AnimModel</span> animModel<span class="token punctuation">,</span> <span class="token class-name">MD5Frame</span> frame<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Matrix4f</span><span class="token punctuation">&gt;</span></span> invJointMatrices<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">AnimatedFrame</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnimatedFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">MD5BaseFrame</span> baseFrame <span class="token operator">=</span> animModel<span class="token punctuation">.</span><span class="token function">getBaseFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MD5Hierarchy<span class="token punctuation">.</span>MD5HierarchyData</span><span class="token punctuation">&gt;</span></span> hierarchyList <span class="token operator">=</span> animModel<span class="token punctuation">.</span><span class="token function">getHierarchy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHierarchyDataList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MD5JointInfo<span class="token punctuation">.</span>MD5JointData</span><span class="token punctuation">&gt;</span></span> joints <span class="token operator">=</span> md5Model<span class="token punctuation">.</span><span class="token function">getJointInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getJoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> numJoints <span class="token operator">=</span> joints<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> frameData <span class="token operator">=</span> frame<span class="token punctuation">.</span><span class="token function">getFrameData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numJoints<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MD5JointInfo<span class="token punctuation">.</span>MD5JointData</span> joint <span class="token operator">=</span> joints<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>We get the position and orientation of the base frame element associated to each joint.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>        <span class="token class-name">MD5BaseFrame<span class="token punctuation">.</span>MD5BaseFrameData</span> baseFrameData <span class="token operator">=</span> baseFrame<span class="token punctuation">.</span><span class="token function">getFrameDataList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Vector3f</span> position <span class="token operator">=</span> baseFrameData<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Quaternionf</span> orientation <span class="token operator">=</span> baseFrameData<span class="token punctuation">.</span><span class="token function">getOrientation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>In principle, that information should be assigned to the joint’s position and orientation, but it needs to be transformed according to the joint’s flag. If you recall, when the structure of the animation file was presented, each joint in the hierarchy section defines a flag. That flag models how the position and orientation information should be changed according to the information defined in each animation frame.</p> <p>If the first bit of that flag field is equal to 1, we should change the x component of the base frame position with the data contained in the animation frame we are processing. That animation frame defines a big float array, so which elements should we take? The answer is also in the joints definition which includes a startIndex attribute. If the second bit of the flag is equal to 1, we should change the y component of the base frame position with the value at startIndex + 1, and so on. The next bits are for the z position, and the x, y and z components of the orientation.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>        <span class="token keyword">int</span> flags <span class="token operator">=</span> hierarchyList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> startIndex <span class="token operator">=</span> hierarchyList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStartIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            position<span class="token punctuation">.</span>x <span class="token operator">=</span> frameData<span class="token punctuation">[</span>startIndex<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            position<span class="token punctuation">.</span>y <span class="token operator">=</span> frameData<span class="token punctuation">[</span>startIndex<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            position<span class="token punctuation">.</span>z <span class="token operator">=</span> frameData<span class="token punctuation">[</span>startIndex<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            orientation<span class="token punctuation">.</span>x <span class="token operator">=</span> frameData<span class="token punctuation">[</span>startIndex<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            orientation<span class="token punctuation">.</span>y <span class="token operator">=</span> frameData<span class="token punctuation">[</span>startIndex<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            orientation<span class="token punctuation">.</span>z <span class="token operator">=</span> frameData<span class="token punctuation">[</span>startIndex<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Update Quaternion's w component</span>
        orientation <span class="token operator">=</span> <span class="token class-name">MD5Utils</span><span class="token punctuation">.</span><span class="token function">calculateQuaternion</span><span class="token punctuation">(</span>orientation<span class="token punctuation">.</span>x<span class="token punctuation">,</span> orientation<span class="token punctuation">.</span>y<span class="token punctuation">,</span> orientation<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>Now we have all information needed to calculate the transformation matrices to get the final position for each joint for the current animation frame. But there’s another thing that we must consider, the position of each joint is relative to its parent position, so we need to get the transformation matrix associated to each parent and use it in order to get a transformation matrix that is in model space coordinates.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>        <span class="token comment">// Calculate translation and rotation matrices for this joint</span>
        <span class="token class-name">Matrix4f</span> translateMat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Matrix4f</span> rotationMat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rotate</span><span class="token punctuation">(</span>orientation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Matrix4f</span> jointMat <span class="token operator">=</span> translateMat<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>rotationMat<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Joint position is relative to joint's parent index position. Use parent matrices</span>
        <span class="token comment">// to transform it to model space</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> joint<span class="token punctuation">.</span><span class="token function">getParentIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Matrix4f</span> parentMatrix <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getLocalJointMatrices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>joint<span class="token punctuation">.</span><span class="token function">getParentIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            jointMat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4f</span><span class="token punctuation">(</span>parentMatrix<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>jointMat<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        result<span class="token punctuation">.</span><span class="token function">setMatrix</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> jointMat<span class="token punctuation">,</span> invJointMatrices<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>You can see that we create an instance of the AnimatedFrame class that holds the information that will be used during animation. This class also uses the inverse matrices, we will see later on why this done this way. An important thing to note is that the setMatrix method of the AnimatedFrame is defined like this.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMatrix</span><span class="token punctuation">(</span><span class="token keyword">int</span> pos<span class="token punctuation">,</span> <span class="token class-name">Matrix4f</span> localJointMatrix<span class="token punctuation">,</span> <span class="token class-name">Matrix4f</span> invJointMatrix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    localJointMatrices<span class="token punctuation">[</span>pos<span class="token punctuation">]</span> <span class="token operator">=</span> localJointMatrix<span class="token punctuation">;</span>
    <span class="token class-name">Matrix4f</span> mat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4f</span><span class="token punctuation">(</span>localJointMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mat<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>invJointMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    jointMatrices<span class="token punctuation">[</span>pos<span class="token punctuation">]</span> <span class="token operator">=</span> mat<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>The variable <code>localJointMatrix</code> stores the transformation matrix for the joint that occupies the position “i” for the current frame. The <code>invJointMatrix</code> holds the inverse transformation matrix for the joint that occupies the position “i” for the binding pose. We store the result of multiplying the <code>localJointMatrix</code> by the <code>invJointMatrix</code>. This result will be used later to compute the final positions. We store also the original joint transformation matrix, the variable <code>localJointMatrix</code>, so we can use it to calculate this joint children's transformation matrices.</p> <p>Let's get back to the MD5Loader class. The <code>generateMesh</code> method also has changed, we calculate the positions of the binding pose as it has been explained before, but for each vertex we store two arrays:</p> <ul><li>An array that holds the weight bias associated to this vertex.</li> <li>An array that holds the joint indices associated to this vertex (through the weights).</li></ul> <p>We limit the size of those arrays to a value of 4. The <code>Mesh</code> class has also been modified to receive those parameters and include it in the VAO information processed by the shaders. You can check the details in the source code, but let’s recap what we have done:</p> <ul><li>We are still loading the binding pose with their final positions calculated as the sum of the joints positions and orientations through the weights information.</li> <li>That information is loaded in the shaders as VBOs but it’s complemented by the bias of the weights associated to each vertex and the indices of the joints that affect it. This information is common to all the animation frames, since it’s defined in the MD5 definition file. This is the reason why we limit the size of the bias and joint indices arrays, they will be loaded as VBOs once when the model is sent to the GPU.</li> <li>For each animation frame we store the transformation matrices to be applied to each joint according to the positions and orientations defined in the base frame.</li> <li>We also have calculated the inverse matrices of the transformation matrices associated to the joints that define the binding pose. That is, we know how to undo the transformations done in the binding pose. We will see how this will be applied later.</li></ul> <p><img src="static_vao_vs_animation_vao.png" alt="Static VAO vs animation VAO"></p> <p>Now that we have all the pieces to solve the puzzle we just need to use them in the shader. We first need to modify the input data to receive the weights and the joint indices.</p> <div class="language-glsl line-numbers-mode"><pre class="language-glsl"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span></span></span>

<span class="token keyword">const</span> <span class="token keyword">int</span> MAX_WEIGHTS <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">int</span> MAX_JOINTS <span class="token operator">=</span> <span class="token number">150</span><span class="token punctuation">;</span>

<span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> position<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> texCoord<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> vertexNormal<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec4</span> jointWeights<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">ivec4</span> jointIndices<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>We have defined two constants:</p> <ul><li><code>MAX_WEIGHTS</code>, defines the maximum number of weights that come in the weights VBO (an solo the joint indices)</li> <li><code>MAX_JOINTS</code>, defines the maximum number of joints we are going to support (more on this later).</li></ul> <p>Then we define the output data and the uniforms.</p> <div class="language-glsl line-numbers-mode"><pre class="language-glsl"><code><span class="token keyword">out</span> <span class="token keyword">vec2</span> outTexCoord<span class="token punctuation">;</span>
<span class="token keyword">out</span> <span class="token keyword">vec3</span> mvVertexNormal<span class="token punctuation">;</span>
<span class="token keyword">out</span> <span class="token keyword">vec3</span> mvVertexPos<span class="token punctuation">;</span>
<span class="token keyword">out</span> <span class="token keyword">vec4</span> mlightviewVertexPos<span class="token punctuation">;</span>
<span class="token keyword">out</span> <span class="token keyword">mat4</span> outModelViewMatrix<span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> jointsMatrix<span class="token punctuation">[</span>MAX_JOINTS<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> modelViewMatrix<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> projectionMatrix<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> modelLightViewMatrix<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> orthoProjectionMatrix<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>You can see that we have a new uniform named <code>jointsMatrix</code> which is an array of matrices (with a maximum length set by the <code>MAX_JOINTS</code> constant). That array of matrices holds the joint matrices calculated for all the joints in the present frame, and was calculated in the <code>MD5Loader</code> class when processing a frame. Thus, that array holds the transformations that need to be applied to a joint in the present animation frame and will serve as the basis for calculating the vertex final position.</p> <p>With the new data in the VBOs and this uniform we will transform the binding pose position.  This is done in the following block.</p> <div class="language-glsl line-numbers-mode"><pre class="language-glsl"><code>    <span class="token keyword">vec4</span> initPos <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_WEIGHTS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">float</span> weight <span class="token operator">=</span> jointWeights<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>weight <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            count<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> jointIndex <span class="token operator">=</span> jointIndices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">vec4</span> tmpPos <span class="token operator">=</span> jointsMatrix<span class="token punctuation">[</span>jointIndex<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            initPos <span class="token operator">+=</span> weight <span class="token operator">*</span> tmpPos<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        initPos <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>First of all, we get the binding pose position, we iterate over the weights associated to this vertex and modify the position using the weights and the joint matrices for this frame (stored in the jointsMatrix uniform) by using the index that is stored in the input.</p> <p><img src="relation_to_joints_matrix.png" alt="Relation to jointsMatrix"></p> <p>So, given a vertex position, we are calculating its frame position as:</p> <p>$$Vfp = \sum\limits_{i=0}^{MAX WEIGTHS} Wb_{i} \dot (Jfp_{i} \times Jt^{-1}_{i}) \times Vpos$$</p> <p>where:</p> <ul><li>$$Wfvp$$ is the vertex final position</li> <li>$$Wb$$ is the vertex weight</li> <li>$$Jfp$$ is the joint matrix transformation matrix for this frame</li> <li>$$Jt^{-1}$$ is the inverse of the joint transformation matrix for the binding pose. The multiplication of this matrix and $$Jfp$$ is what's contained in the <code>jointsMatrix</code> uniform.</li> <li>$$Vpos$$ is the vertex position in the binding position.</li></ul> <p>$$Vpos$$ is calculated by using the $$Jt$$ matrix, which is the matrix of the joint transformation matrix for the binding pose. So, at the end we are somehow undoing the modifications of the binding pose to apply the transformations for this frame. This is the reason why we need the inverse binding pose matrix.</p> <p>The shader supports vertices with variable number of weights, up to a maximum of 4, and also supports the rendering of non animated items. In this case, the weights will be equal to 0 and we will get the original position.</p> <p>The rest of the shader stays more or less the same, we just use the updated position and pass the correct values to be used by the fragment shader.</p> <div class="language-glsl line-numbers-mode"><pre class="language-glsl"><code>    <span class="token keyword">vec4</span> mvPos <span class="token operator">=</span> modelViewMatrix <span class="token operator">*</span> initPos<span class="token punctuation">;</span>
    gl_Position <span class="token operator">=</span> projectionMatrix <span class="token operator">*</span> mvPos<span class="token punctuation">;</span>
    outTexCoord <span class="token operator">=</span> texCoord<span class="token punctuation">;</span>
    mvVertexNormal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>modelViewMatrix <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>vertexNormal<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
    mvVertexPos <span class="token operator">=</span> mvPos<span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
    mlightviewVertexPos <span class="token operator">=</span> orthoProjectionMatrix <span class="token operator">*</span> modelLightViewMatrix <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    outModelViewMatrix <span class="token operator">=</span> modelViewMatrix<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>So, in order to test the animation we just need to pass the <code>jointsMatrix</code> to the shader. Since this information is stored only in instances of the <code>AnimGameItem</code> class, the code is very simple.  In the loop that renders the Meshes, we add this fragment.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span> gameItem <span class="token keyword">instanceof</span> <span class="token class-name">AnimGameItem</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">AnimGameItem</span> animGameItem <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AnimGameItem</span><span class="token punctuation">)</span>gameItem<span class="token punctuation">;</span>
    <span class="token class-name">AnimatedFrame</span> frame <span class="token operator">=</span> animGameItem<span class="token punctuation">.</span><span class="token function">getCurrentFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sceneShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;jointsMatrix&quot;</span><span class="token punctuation">,</span> frame<span class="token punctuation">.</span><span class="token function">getJointMatrices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>Of course, you will need to create the uniform before using it, you can check the source code for that. If you run the example you will be able to see how the model animates by pressing the space bar (each time the key is pressed a new frame is set and the jointsMatrix uniform changes).</p> <p>You will see something like this.</p> <p><img src="Animation.png" alt="First animation"></p> <p>Although the animation is smooth, the sample presents some problems. First of all, light is not correctly applied and the shadow represents the binding pose but not the current frame. We will solve all these problems now.</p> <h2 id="correcting-animation-issues"><a href="#correcting-animation-issues" class="header-anchor">#</a> Correcting animation issues</h2> <p>The first issue we address is the light problem. You may have already noticed the case, it's due to the fact that we are not transforming normals. Thus, the normals that are used in the fragment shader are the ones that correspond to the binding pose. We need to transform them in the same way as the positions.</p> <p>This issue is easy to solve, we just need to include the normals in the loop that iterates over the weights in the vertex shader.</p> <div class="language-glsl line-numbers-mode"><pre class="language-glsl"><code>    <span class="token keyword">vec4</span> initPos <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec4</span> initNormal <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_WEIGHTS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">float</span> weight <span class="token operator">=</span> jointWeights<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>weight <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            count<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> jointIndex <span class="token operator">=</span> jointIndices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">vec4</span> tmpPos <span class="token operator">=</span> jointsMatrix<span class="token punctuation">[</span>jointIndex<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            initPos <span class="token operator">+=</span> weight <span class="token operator">*</span> tmpPos<span class="token punctuation">;</span>

            <span class="token keyword">vec4</span> tmpNormal <span class="token operator">=</span> jointsMatrix<span class="token punctuation">[</span>jointIndex<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>vertexNormal<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            initNormal <span class="token operator">+=</span> weight <span class="token operator">*</span> tmpNormal<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        initPos <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        initNormal <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>vertexNormal<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>Then we just calculate the output vertex normal as always:</p> <div class="language-glsl line-numbers-mode"><pre class="language-glsl"><code>mvVertexNormal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>modelViewMatrix <span class="token operator">*</span> initNormal<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>The next issue is the shadow problem. If you recall from the shadows chapter, we are using shadow maps to draw shadows. We are rendering the scene from the light perspective in order to create a depth map that tells us if a point is in shadow or not. But, as in the case of the normals, we are just passing the binding pose coordinates and not changing them according to the current frame. This is the reason why the shadow does not corresponds to the current position.</p> <p>The solution is easy, we just need to modify the depth vertex shader to use the <code>jointsMatrix</code> and the weights and joint indices to transform the position. This is how the depth vertex shader looks like.</p> <div class="language-glsl line-numbers-mode"><pre class="language-glsl"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span></span></span>

<span class="token keyword">const</span> <span class="token keyword">int</span> MAX_WEIGHTS <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">int</span> MAX_JOINTS <span class="token operator">=</span> <span class="token number">150</span><span class="token punctuation">;</span>

<span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> position<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> texCoord<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> vertexNormal<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec4</span> jointWeights<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">ivec4</span> jointIndices<span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> jointsMatrix<span class="token punctuation">[</span>MAX_JOINTS<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> modelLightViewMatrix<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> orthoProjectionMatrix<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">vec4</span> initPos <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_WEIGHTS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">float</span> weight <span class="token operator">=</span> jointWeights<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>weight <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            count<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> jointIndex <span class="token operator">=</span> jointIndices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">vec4</span> tmpPos <span class="token operator">=</span> jointsMatrix<span class="token punctuation">[</span>jointIndex<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            initPos <span class="token operator">+=</span> weight <span class="token operator">*</span> tmpPos<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        initPos <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    gl_Position <span class="token operator">=</span> orthoProjectionMatrix <span class="token operator">*</span> modelLightViewMatrix <span class="token operator">*</span> initPos<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>You need to modify the <code>Renderer</code> class to set up the new uniforms for this shader, and the final result will be much better. The light will be applied correctly and the shadow will change for each animation frame as shown in the next figure.</p> <p><img src="animation_refined.png" alt="Animation refined"></p> <p>And that's all, you have now a working example that animates MD5 models. The source code can still be improved and you can modify the matrices that are loaded in each render cycle to interpolate between frames positions. You can check the sources used for this chapter to see how this can be done.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/CraftStarStudio/wjglbook-bookcontents-zh_CN/edit/master/chapter19/chapter19.md" target="_blank" rel="noopener noreferrer">帮助我们完善这个页面</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">最后更新 :</span> <span class="time">6/27/2021, 1:14:09 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/3d-game-development-with-lwjgl/chapter18/chapter18.html" class="prev">
        Shadows
      </a></span> <span class="next"><a href="/3d-game-development-with-lwjgl/chapter20/chapter20.html">
        Particles
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/3d-game-development-with-lwjgl/assets/js/app.519c1cc5.js" defer></script><script src="/3d-game-development-with-lwjgl/assets/js/2.e7870360.js" defer></script><script src="/3d-game-development-with-lwjgl/assets/js/28.e559af67.js" defer></script>
  </body>
</html>
