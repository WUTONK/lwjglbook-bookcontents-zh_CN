<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Fog | 使用 LWJGL 3 开发 3D 游戏</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/3d-game-development-with-lwjgl/assets/css/0.styles.33e5fdc6.css" as="style"><link rel="preload" href="/3d-game-development-with-lwjgl/assets/js/app.519c1cc5.js" as="script"><link rel="preload" href="/3d-game-development-with-lwjgl/assets/js/2.e7870360.js" as="script"><link rel="preload" href="/3d-game-development-with-lwjgl/assets/js/25.a115cf89.js" as="script"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/10.7296f99c.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/11.a42afaf0.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/12.b7fdae6a.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/13.01b80f30.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/14.06f37286.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/15.c4635c97.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/16.f4253e97.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/17.c7f6896c.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/18.8a24c215.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/19.ab6ce5f4.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/20.9046ed34.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/21.3cb4242e.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/22.b2fa78a0.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/23.a9e504af.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/24.12580511.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/26.7193040d.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/27.4fa5cc0d.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/28.e559af67.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/29.d5befc6c.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/3.8fb1d8aa.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/30.ee00c5df.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/31.0effa8ac.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/32.c13100cf.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/33.c9fbfcdb.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/34.7bde7785.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/35.604c8847.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/36.ccd3a84c.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/37.ec274013.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/38.66d82b73.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/4.e1b9ee22.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/5.75c3f2db.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/6.601d5460.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/7.1f9c2020.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/8.be9c92d8.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/9.048bb756.js">
    <link rel="stylesheet" href="/3d-game-development-with-lwjgl/assets/css/0.styles.33e5fdc6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/3d-game-development-with-lwjgl/" class="home-link router-link-active"><!----> <span class="site-name">使用 LWJGL 3 开发 3D 游戏</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/3d-game-development-with-lwjgl/" aria-current="page" class="sidebar-link">封面</a></li><li><a href="/3d-game-development-with-lwjgl/INTRODUCTION.html" class="sidebar-link">简介</a></li><li><a href="/3d-game-development-with-lwjgl/chapter01/chapter1.html" class="sidebar-link">第一步</a></li><li><a href="/3d-game-development-with-lwjgl/chapter02/chapter2.html" class="sidebar-link">The Game Loop</a></li><li><a href="/3d-game-development-with-lwjgl/chapter03/chapter3.html" class="sidebar-link">A brief about coordinates</a></li><li><a href="/3d-game-development-with-lwjgl/chapter04/chapter4.html" class="sidebar-link">Rendering</a></li><li><a href="/3d-game-development-with-lwjgl/chapter05/chapter5.html" class="sidebar-link">More on Rendering</a></li><li><a href="/3d-game-development-with-lwjgl/chapter06/chapter6.html" class="sidebar-link">Transformations</a></li><li><a href="/3d-game-development-with-lwjgl/chapter07/chapter7.html" class="sidebar-link">Textures</a></li><li><a href="/3d-game-development-with-lwjgl/chapter08/chapter8.html" class="sidebar-link">Camera</a></li><li><a href="/3d-game-development-with-lwjgl/chapter09/chapter9.html" class="sidebar-link">Loading more complex models</a></li><li><a href="/3d-game-development-with-lwjgl/chapter10/chapter10.html" class="sidebar-link">Let there be light</a></li><li><a href="/3d-game-development-with-lwjgl/chapter11/chapter11.html" class="sidebar-link">Let there be even more light</a></li><li><a href="/3d-game-development-with-lwjgl/chapter12/chapter12.html" class="sidebar-link">Game HUD</a></li><li><a href="/3d-game-development-with-lwjgl/chapter13/chapter13.html" class="sidebar-link">Sky Box and some optimizations</a></li><li><a href="/3d-game-development-with-lwjgl/chapter14/chapter14.html" class="sidebar-link">Height Maps</a></li><li><a href="/3d-game-development-with-lwjgl/chapter15/chapter15.html" class="sidebar-link">Terrain Collisions</a></li><li><a href="/3d-game-development-with-lwjgl/chapter16/chapter16.html" aria-current="page" class="active sidebar-link">Fog</a></li><li><a href="/3d-game-development-with-lwjgl/chapter17/chapter17.html" class="sidebar-link">Normal Mapping</a></li><li><a href="/3d-game-development-with-lwjgl/chapter18/chapter18.html" class="sidebar-link">Shadows</a></li><li><a href="/3d-game-development-with-lwjgl/chapter19/chapter19.html" class="sidebar-link">Animations</a></li><li><a href="/3d-game-development-with-lwjgl/chapter20/chapter20.html" class="sidebar-link">Particles</a></li><li><a href="/3d-game-development-with-lwjgl/chapter21/chapter21.html" class="sidebar-link">Instanced Rendering</a></li><li><a href="/3d-game-development-with-lwjgl/chapter22/chapter22.html" class="sidebar-link">Audio</a></li><li><a href="/3d-game-development-with-lwjgl/chapter23/chapter23.html" class="sidebar-link">3D Object Picking</a></li><li><a href="/3d-game-development-with-lwjgl/chapter24/chapter24.html" class="sidebar-link">HUD Revisited - NanoVG</a></li><li><a href="/3d-game-development-with-lwjgl/chapter25/chapter25.html" class="sidebar-link">Optimizations - Frustum Culling \(I\)</a></li><li><a href="/3d-game-development-with-lwjgl/chapter26/chapter26.html" class="sidebar-link">Cascaded Shadow Maps</a></li><li><a href="/3d-game-development-with-lwjgl/chapter27/chapter27.html" class="sidebar-link">Assimp</a></li><li><a href="/3d-game-development-with-lwjgl/chapter28/chapter28.html" class="sidebar-link">Deferred Shading</a></li><li><a href="/3d-game-development-with-lwjgl/appendixa/appendixa.html" class="sidebar-link">Appendix A - OpenGL Debugging</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="fog"><a href="#fog" class="header-anchor">#</a> Fog</h1> <p>Before we deal with more complex topics, we will review how to create a fog effect in our game engine. With that effect, we will simulate how distant objects get dimmed and seem to vanish into a dense fog.</p> <p>Let us first examine the attributes that define fog. The first one is the fog colour. In the real world, the fog has a gray colour, but we can use this effect to simulate wide areas invaded by a fog with different colours. The attribute is the fog's density.</p> <p>Thus, in order to apply the fog effect, we need to find a way to fade our 3D scene objects into the fog colour as long as they get far away from the camera. Objects that are close to the camera will not be affected by the fog, but objects that are far away will not be distinguishable. So we need to be able to calculate a factor that can be used to blend the fog colour and each fragment colour in order to simulate that effect. That factor will need to be dependent on the distance to the camera.</p> <p>Let’s call that factor $$fogFactor$$, and set its range from 0 to 1. When the $$fogFactor$$ is 1, it means that the object will not be affected by fog, that is, it’s a nearby object. When the $$fogFactor$$ takes the 0 value, it means that the objects will be completely hidden in the fog.</p> <p>Therefore, the equation needed to calculate the fog colour is:</p> <p>$$finalColour = (1 - fogFactor) \cdot fogColour + fogFactor \cdot framentColour$$</p> <ul><li>$$finalColour$$ is the colour that results from applying the fog effect.</li> <li>$$fogFactor$$ is the parameters that controls how the fog colour and the fragment colour are blended. It basically controls the object visibility.</li> <li>$$fogColour$$ is the colour of the fog.</li> <li>$$fragmentColour$$ is the colour of the fragment without applying any fog effect on it.</li></ul> <p>Now we need to find a way to calculate $$fogFactor$$ depending on the distance. We can choose different models, and the first one could be to use a linear model. This is a model that, given a distance, changes the fogFactor value in a linear way.</p> <p>The linear model can be defined by the following parameters:</p> <ul><li>$$fogStart$$: The distance at where fog effects starts to be applied.</li> <li>$$fogFinish$$: The distance at where fog effects reach its maximum value.</li> <li>$$distance$$: Distance to the camera.</li></ul> <p>With those parameters, the equation to be applied is:</p> <p>$$\displaystyle fogFactor = \frac{(fogFinish - distance)}{(fogFinish - fogStart)}$$</p> <p>For objects at distance lower than $$fogStart$$ we just simply set the $$fogFactor$$ to $$1$$. The following graph shows how the $$fogFactor$$ changes with the distance.</p> <p><img src="linear_model.png" alt="Linear model"></p> <p>The linear model is easy to calculate but it is not very realistic and it does not take into consideration the fog density. In reality, fog tends to grow in a smoother way. So the next suitable model is an exponential one. The equation for that model is as follows:</p> <p>$$\displaystyle fogFactor = e^{-(distance \cdot fogDensity)^{exponent}} = \frac{1}{e^{(distance \cdot fogDensity)^{exponent}}}$$</p> <p>The new variables that come into play are:</p> <ul><li>$$fogDensity$$ which models the thickness or density of the fog.</li> <li>$$exponent$$ which is used to control how fast the fog increases with distance.</li></ul> <p>The following picture shows two graphs for the equation above for different values of the exponent ($$2$$ for the blue line and $$4$$ for the red one).</p> <p><img src="exponential_model.png" alt="Exponential model"></p> <p>In our code, we will use a formula that sets a value of two for the exponent (you can easily modify the example to use different values).</p> <p>Now that the theory has been explained we can put it into practice. We will implement the effect in the scene fragment shader since we have there all the variables we need. We will start by defining a struct that models the fog attributes.</p> <div class="language-glsl line-numbers-mode"><pre class="language-glsl"><code><span class="token keyword">struct</span> <span class="token class-name">Fog</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> <span class="token keyword">active</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> colour<span class="token punctuation">;</span>
    <span class="token keyword">float</span> density<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>The <code>active</code> attribute will be used to activate or deactivate the fog effect. The fog will be passed to the shader through another uniform named <code>fog</code>.</p> <div class="language-glsl line-numbers-mode"><pre class="language-glsl"><code><span class="token keyword">uniform</span> Fog fog<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>We will create also a new class named <code>Fog</code> which is another POJO (Plain Old Java Object) that contains the fog attributes.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>lwjglb<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>graph<span class="token punctuation">.</span>weather</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>joml<span class="token punctuation">.</span></span><span class="token class-name">Vector3f</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Fog</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> active<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Vector3f</span> colour<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">float</span> density<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Fog</span> NOFOG <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Fog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Fog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>colour <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>density <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Fog</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> active<span class="token punctuation">,</span> <span class="token class-name">Vector3f</span> colour<span class="token punctuation">,</span> <span class="token keyword">float</span> density<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>colour <span class="token operator">=</span> colour<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>density <span class="token operator">=</span> density<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>active <span class="token operator">=</span> active<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

   <span class="token comment">// Getters and setters here….</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>We will add a <code>Fog</code> instance in the <code>Scene</code> class. As a default, the <code>Scene</code> class will initialize the <code>Fog</code> instance to the constant <code>NOFOG</code> which models a deactivated instance.</p> <p>Since we have added a new uniform type, we need to modify the <code>ShaderProgram</code> class to create and initialize the fog uniform.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createFogUniform</span><span class="token punctuation">(</span><span class="token class-name">String</span> uniformName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token function">createUniform</span><span class="token punctuation">(</span>uniformName <span class="token operator">+</span> <span class="token string">&quot;.active&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">createUniform</span><span class="token punctuation">(</span>uniformName <span class="token operator">+</span> <span class="token string">&quot;.colour&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">createUniform</span><span class="token punctuation">(</span>uniformName <span class="token operator">+</span> <span class="token string">&quot;.density&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token class-name">String</span> uniformName<span class="token punctuation">,</span> <span class="token class-name">Fog</span> fog<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setUniform</span><span class="token punctuation">(</span>uniformName <span class="token operator">+</span> <span class="token string">&quot;.activeFog&quot;</span><span class="token punctuation">,</span> fog<span class="token punctuation">.</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setUniform</span><span class="token punctuation">(</span>uniformName <span class="token operator">+</span> <span class="token string">&quot;.colour&quot;</span><span class="token punctuation">,</span> fog<span class="token punctuation">.</span><span class="token function">getColour</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setUniform</span><span class="token punctuation">(</span>uniformName <span class="token operator">+</span> <span class="token string">&quot;.density&quot;</span><span class="token punctuation">,</span> fog<span class="token punctuation">.</span><span class="token function">getDensity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>In the <code>Renderer</code> class we just need to create the uniform in the <code>setupSceneShader</code> method:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>sceneShaderProgram<span class="token punctuation">.</span><span class="token function">createFogUniform</span><span class="token punctuation">(</span><span class="token string">&quot;fog&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>And use it in the <code>renderScene</code> method:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>sceneShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;fog&quot;</span><span class="token punctuation">,</span> scene<span class="token punctuation">.</span><span class="token function">getFog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>We are now able to define fog characteristics in our game, but we need to get back to the fragment shader in order to apply the fog effect. We will create a function named <code>calcFog</code> which is defined as this.</p> <div class="language-glsl line-numbers-mode"><pre class="language-glsl"><code><span class="token keyword">vec4</span> <span class="token function">calcFog</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> pos<span class="token punctuation">,</span> <span class="token keyword">vec4</span> colour<span class="token punctuation">,</span> Fog fog<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">float</span> distance <span class="token operator">=</span> <span class="token function">length</span><span class="token punctuation">(</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> fogFactor <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token function">exp</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>distance <span class="token operator">*</span> fog<span class="token punctuation">.</span>density<span class="token punctuation">)</span><span class="token operator">*</span> <span class="token punctuation">(</span>distance <span class="token operator">*</span> fog<span class="token punctuation">.</span>density<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fogFactor <span class="token operator">=</span> <span class="token function">clamp</span><span class="token punctuation">(</span> fogFactor<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">vec3</span> resultColour <span class="token operator">=</span> <span class="token function">mix</span><span class="token punctuation">(</span>fog<span class="token punctuation">.</span>colour<span class="token punctuation">,</span> colour<span class="token punctuation">.</span>xyz<span class="token punctuation">,</span> fogFactor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>resultColour<span class="token punctuation">.</span>xyz<span class="token punctuation">,</span> colour<span class="token punctuation">.</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>As you can see, we first calculate the distance to the vertex. The vertex coordinates are defined in the <code>pos</code> variable and we just need to calculate the length. Then we calculate the fog factor using the exponential model with an exponent of two (which is equivalent to multiply it twice). We clamp the <code>fogFactor</code> to a range between $$0$$ and $$1$$ and use the <code>mix</code> function. In GLSL, the <code>mix</code> function is used to blend the fog colour and the fragment colour (defined by variable <code>colour</code>). It's equivalent to applying this equation:</p> <p>$$resultColour = (1 - fogFactor) \cdot fog.colour + fogFactor \cdot colour$$</p> <p>We also preserve the w component, the transparency, of the original colour. We don't want this component to be affected, as the fragment should maintain its transparency level.</p> <p>At the end of the fragment shader, after applying all the light effects, we just simply assign the returned value to the fragment colour if the fog is active.</p> <div class="language-glsl line-numbers-mode"><pre class="language-glsl"><code><span class="token keyword">if</span> <span class="token punctuation">(</span> fog<span class="token punctuation">.</span>activeFog <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    fragColor <span class="token operator">=</span> <span class="token function">calcFog</span><span class="token punctuation">(</span>mvVertexPos<span class="token punctuation">,</span> fragColor<span class="token punctuation">,</span> fog<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>With all that code completed, we can set up a Fog with the following data:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>scene<span class="token punctuation">.</span><span class="token function">setFog</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Fog</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span><span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.15f</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>And we will get an effect like this:</p> <p><img src="fog_effect.png" alt="Fog effect"></p> <p>You will see that distant objects get faded in the distance and that fog starts to disappear when you approach to them. There’s a problem, though, with the skybox: it looks a little bit weird that the horizon is not affected by the fog. There are several ways to solve this:</p> <ul><li>Use a different skybox in which you only see a sky.</li> <li>Remove the skybox, since you have a dense fog, you should not be able to see a background.</li></ul> <p>Maybe none of the two solutions fits you, and you can try to match the fog colour to the skybox background but you will end up doing complex calculations and the result will not be much better.</p> <p>If you let the example run you will see how directional light gets dimmed and the scene darkens, but there’s a problem with the fog, it is not affected by light and you will get something like this.</p> <p><img src="glowing_fog.png" alt="Glowing fog"></p> <p>Distant objects are set to the fog colour, which is a constant and not affected by light. This fact produces a glowing in the dark effect (which may be OK for you or not). We need to change the function that calculates the fog to take into consideration the light. The function will receive the ambient light and the directional light to modulate the fog colour.</p> <div class="language-glsl line-numbers-mode"><pre class="language-glsl"><code><span class="token keyword">vec4</span> <span class="token function">calcFog</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> pos<span class="token punctuation">,</span> <span class="token keyword">vec4</span> colour<span class="token punctuation">,</span> Fog fog<span class="token punctuation">,</span> <span class="token keyword">vec3</span> ambientLight<span class="token punctuation">,</span> DirectionalLight dirLight<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">vec3</span> fogColor <span class="token operator">=</span> fog<span class="token punctuation">.</span>colour <span class="token operator">*</span> <span class="token punctuation">(</span>ambientLight <span class="token operator">+</span> dirLight<span class="token punctuation">.</span>colour <span class="token operator">*</span> dirLight<span class="token punctuation">.</span>intensity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> distance <span class="token operator">=</span> <span class="token function">length</span><span class="token punctuation">(</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> fogFactor <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token function">exp</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>distance <span class="token operator">*</span> fog<span class="token punctuation">.</span>density<span class="token punctuation">)</span><span class="token operator">*</span> <span class="token punctuation">(</span>distance <span class="token operator">*</span> fog<span class="token punctuation">.</span>density<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fogFactor <span class="token operator">=</span> <span class="token function">clamp</span><span class="token punctuation">(</span> fogFactor<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">vec3</span> resultColour <span class="token operator">=</span> <span class="token function">mix</span><span class="token punctuation">(</span>fogColor<span class="token punctuation">,</span> colour<span class="token punctuation">.</span>xyz<span class="token punctuation">,</span> fogFactor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>resultColour<span class="token punctuation">.</span>xyz<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>As you can see, with the directional light we just use the colour and the intensity, we are not interested in the direction. With that modification we just need to slightly modify the call to the function like this:</p> <div class="language-glsl line-numbers-mode"><pre class="language-glsl"><code><span class="token keyword">if</span> <span class="token punctuation">(</span> fog<span class="token punctuation">.</span><span class="token keyword">active</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    fragColor <span class="token operator">=</span> <span class="token function">calcFog</span><span class="token punctuation">(</span>mvVertexPos<span class="token punctuation">,</span> fragColor<span class="token punctuation">,</span> fog<span class="token punctuation">,</span> ambientLight<span class="token punctuation">,</span> directionalLight<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>And we will get something like this when night falls.</p> <p><img src="fog_at_night.png" alt="Fog at night"></p> <p>One important thing to highlight is that we must choose wisely the fog colour. This is even more important when we have no skybox but a fixed colour background. We should set up the fog colour to be equal to the clear colour. If you uncomment the code that render the skybox and rerun the example you will get something like this.</p> <p><img src="fog_clear_colour_black.png" alt="Black clear colour"></p> <p>But if we modify the clear colour to be equal to <code>(0.5, 0.5, 0.5)</code> the result will be like this.</p> <p><img src="fog_clear_colour_grey.png" alt=""></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/CraftStarStudio/wjglbook-bookcontents-zh_CN/edit/master/chapter16/chapter16.md" target="_blank" rel="noopener noreferrer">帮助我们完善这个页面</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">最后更新 :</span> <span class="time">6/27/2021, 1:14:09 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/3d-game-development-with-lwjgl/chapter15/chapter15.html" class="prev">
        Terrain Collisions
      </a></span> <span class="next"><a href="/3d-game-development-with-lwjgl/chapter17/chapter17.html">
        Normal Mapping
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/3d-game-development-with-lwjgl/assets/js/app.519c1cc5.js" defer></script><script src="/3d-game-development-with-lwjgl/assets/js/2.e7870360.js" defer></script><script src="/3d-game-development-with-lwjgl/assets/js/25.a115cf89.js" defer></script>
  </body>
</html>
