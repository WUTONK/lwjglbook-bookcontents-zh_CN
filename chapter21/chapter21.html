<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Instanced Rendering | 使用 LWJGL 3 开发 3D 游戏</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/3d-game-development-with-lwjgl/assets/css/0.styles.33e5fdc6.css" as="style"><link rel="preload" href="/3d-game-development-with-lwjgl/assets/js/app.519c1cc5.js" as="script"><link rel="preload" href="/3d-game-development-with-lwjgl/assets/js/2.e7870360.js" as="script"><link rel="preload" href="/3d-game-development-with-lwjgl/assets/js/30.ee00c5df.js" as="script"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/10.7296f99c.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/11.a42afaf0.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/12.b7fdae6a.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/13.01b80f30.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/14.06f37286.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/15.c4635c97.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/16.f4253e97.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/17.c7f6896c.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/18.8a24c215.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/19.ab6ce5f4.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/20.9046ed34.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/21.3cb4242e.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/22.b2fa78a0.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/23.a9e504af.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/24.12580511.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/25.a115cf89.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/26.7193040d.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/27.4fa5cc0d.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/28.e559af67.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/29.d5befc6c.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/3.8fb1d8aa.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/31.0effa8ac.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/32.c13100cf.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/33.c9fbfcdb.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/34.7bde7785.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/35.604c8847.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/36.ccd3a84c.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/37.ec274013.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/38.66d82b73.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/4.e1b9ee22.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/5.75c3f2db.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/6.601d5460.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/7.1f9c2020.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/8.be9c92d8.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/9.048bb756.js">
    <link rel="stylesheet" href="/3d-game-development-with-lwjgl/assets/css/0.styles.33e5fdc6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/3d-game-development-with-lwjgl/" class="home-link router-link-active"><!----> <span class="site-name">使用 LWJGL 3 开发 3D 游戏</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/3d-game-development-with-lwjgl/" aria-current="page" class="sidebar-link">封面</a></li><li><a href="/3d-game-development-with-lwjgl/INTRODUCTION.html" class="sidebar-link">简介</a></li><li><a href="/3d-game-development-with-lwjgl/chapter01/chapter1.html" class="sidebar-link">第一步</a></li><li><a href="/3d-game-development-with-lwjgl/chapter02/chapter2.html" class="sidebar-link">The Game Loop</a></li><li><a href="/3d-game-development-with-lwjgl/chapter03/chapter3.html" class="sidebar-link">A brief about coordinates</a></li><li><a href="/3d-game-development-with-lwjgl/chapter04/chapter4.html" class="sidebar-link">Rendering</a></li><li><a href="/3d-game-development-with-lwjgl/chapter05/chapter5.html" class="sidebar-link">More on Rendering</a></li><li><a href="/3d-game-development-with-lwjgl/chapter06/chapter6.html" class="sidebar-link">Transformations</a></li><li><a href="/3d-game-development-with-lwjgl/chapter07/chapter7.html" class="sidebar-link">Textures</a></li><li><a href="/3d-game-development-with-lwjgl/chapter08/chapter8.html" class="sidebar-link">Camera</a></li><li><a href="/3d-game-development-with-lwjgl/chapter09/chapter9.html" class="sidebar-link">Loading more complex models</a></li><li><a href="/3d-game-development-with-lwjgl/chapter10/chapter10.html" class="sidebar-link">Let there be light</a></li><li><a href="/3d-game-development-with-lwjgl/chapter11/chapter11.html" class="sidebar-link">Let there be even more light</a></li><li><a href="/3d-game-development-with-lwjgl/chapter12/chapter12.html" class="sidebar-link">Game HUD</a></li><li><a href="/3d-game-development-with-lwjgl/chapter13/chapter13.html" class="sidebar-link">Sky Box and some optimizations</a></li><li><a href="/3d-game-development-with-lwjgl/chapter14/chapter14.html" class="sidebar-link">Height Maps</a></li><li><a href="/3d-game-development-with-lwjgl/chapter15/chapter15.html" class="sidebar-link">Terrain Collisions</a></li><li><a href="/3d-game-development-with-lwjgl/chapter16/chapter16.html" class="sidebar-link">Fog</a></li><li><a href="/3d-game-development-with-lwjgl/chapter17/chapter17.html" class="sidebar-link">Normal Mapping</a></li><li><a href="/3d-game-development-with-lwjgl/chapter18/chapter18.html" class="sidebar-link">Shadows</a></li><li><a href="/3d-game-development-with-lwjgl/chapter19/chapter19.html" class="sidebar-link">Animations</a></li><li><a href="/3d-game-development-with-lwjgl/chapter20/chapter20.html" class="sidebar-link">Particles</a></li><li><a href="/3d-game-development-with-lwjgl/chapter21/chapter21.html" aria-current="page" class="active sidebar-link">Instanced Rendering</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/3d-game-development-with-lwjgl/chapter21/chapter21.html#lots-of-instances" class="sidebar-link">Lots of Instances</a></li><li class="sidebar-sub-header"><a href="/3d-game-development-with-lwjgl/chapter21/chapter21.html#particles-revisited" class="sidebar-link">Particles revisited</a></li><li class="sidebar-sub-header"><a href="/3d-game-development-with-lwjgl/chapter21/chapter21.html#extra-bonus" class="sidebar-link">Extra bonus</a></li></ul></li><li><a href="/3d-game-development-with-lwjgl/chapter22/chapter22.html" class="sidebar-link">Audio</a></li><li><a href="/3d-game-development-with-lwjgl/chapter23/chapter23.html" class="sidebar-link">3D Object Picking</a></li><li><a href="/3d-game-development-with-lwjgl/chapter24/chapter24.html" class="sidebar-link">HUD Revisited - NanoVG</a></li><li><a href="/3d-game-development-with-lwjgl/chapter25/chapter25.html" class="sidebar-link">Optimizations - Frustum Culling \(I\)</a></li><li><a href="/3d-game-development-with-lwjgl/chapter26/chapter26.html" class="sidebar-link">Cascaded Shadow Maps</a></li><li><a href="/3d-game-development-with-lwjgl/chapter27/chapter27.html" class="sidebar-link">Assimp</a></li><li><a href="/3d-game-development-with-lwjgl/chapter28/chapter28.html" class="sidebar-link">Deferred Shading</a></li><li><a href="/3d-game-development-with-lwjgl/appendixa/appendixa.html" class="sidebar-link">Appendix A - OpenGL Debugging</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="instanced-rendering"><a href="#instanced-rendering" class="header-anchor">#</a> Instanced Rendering</h1> <h2 id="lots-of-instances"><a href="#lots-of-instances" class="header-anchor">#</a> Lots of Instances</h2> <p>When drawing a 3D scene it is common to have many models represented by the same mesh but with different transformations. In this case, although they may be simple objects with just a few triangles, performance can suffer. The cause behind this is the way we are rendering them.</p> <p>We are basically iterating through all the game items inside a loop and performing a call to the function <code>glDrawElements</code>. As it has been said in previous chapters, calls to OpenGL library should be minimized. Each call to the <code>glDrawElements</code> function imposes an overhead that is repeated again and again for each <code>GameItem</code> instance.</p> <p>When dealing with lots of similar objects it would be more efficient to render all of them using a single call. This technique is called instanced rendering. In order to accomplish that, OpenGL provides a set of functions named <code>glDrawXXXInstanced</code> to render a set of elements at once. In our case, since we are drawing elements we will use the function named <code>glDrawElementsInstanced</code>. This function receives the same arguments as the <code>glDrawElements</code> plus one additional parameter which sets the number of instances to be drawn.</p> <p>This is a sample of how the glDrawElements is used.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token function">glDrawElements</span><span class="token punctuation">(</span>GL_TRIANGLES<span class="token punctuation">,</span> numVertices<span class="token punctuation">,</span> GL_UNSIGNED_INT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>And this is how the instanced version can be used:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token function">glDrawElementsInstanced</span><span class="token punctuation">(</span>GL_TRIANGLES<span class="token punctuation">,</span> numVertices<span class="token punctuation">,</span> GL_UNSIGNED_INT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> numInstances<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>But you may be wondering now how can you set the different transformations for each of those instances. Now, before we draw each instance we pass the different transformations and instance related data using uniforms. Before a render call is made we need to setup the specific data for each item. How can we do this when rendering all of them at once?</p> <p>When using instanced rendering, in the vertex shader we can use an input variable that holds the index of the instance that is currently being drawn. With that built-in variable we can, for instance, pass an array of uniforms containing the transformations to be applied to each instance and use a single render call.</p> <p>The problem with this approach is that it still imposes too much overhead. In addition to that, the number of uniforms that we can pass is limited. Thus, we need to employ another approach, instead of using lists of uniforms we will use instanced arrays.</p> <p>If you recall from the first chapters, the data for each Mesh is defined by a set of arrays of data named VBOs. The data store in those VBOs is unique per Mesh instance.</p> <p><img src="vao_1.png" alt="VBOs"></p> <p>With standard VBOs, inside a shader, we can access the data associated to each vertex (its position, colour, texture, etc.). Whenever the shader is run, the input variables are set to point to the specific data associated to each vertex. With instanced arrays we can set up data that is changed per instance instead of per vertex. If we combine both types we can use regular VBOs to store per vertex information (position, texture coordinates) and VBOs that contain per instance data such as model view matrices.</p> <p>The next figure shows a Mesh composed by three per vertex VBOs defining the positions, textures and normals. The first index of each of those elements is the instance that it belongs to (in blue colour). The second index represents the vertex position inside a instance.</p> <p>The Mesh is also defined by two per instance VBOs. One for the model view matrix and the other one for the light view matrix. When rendering the vertices for the first instance (the 1X, ones), the model view and light view matrices will be the same (the 1). When vertices of the second instance are to be rendered the second model view and light view matrices will be used.</p> <p><img src="vao_2.png" alt="VBOs with instance attributes"></p> <p>Thus, when rendering the first vertex of the first instance, V11, T11 and N11 would be used for position, texture and normal data and MV1 would be used as a model view matrix. When rendering the second vertex of the same first instance, V12, T12 and N12 would be used for position, texture and normal data and MV1 would still be used as a model view matrix. MV2 and LV2 would not be used until second instance is rendered.</p> <p>In order to define per instance data we need to call the function <code>glVertexAttribDivisor</code> after defining vertex attributes. This function receives two parameters:</p> <ul><li><p>index: The index of the vertex attribute (as issued in the glVertexAttribPointer function).</p></li> <li><p>Divisor: If this is zero, the data is changed for each vertex while rendering. If it is set to one, the data changes once per instance. If it’s set to two it changes every two instances, etc.</p></li></ul> <p>So, in order to set data for a instance we need to perform this call after every attribute definition:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token function">glVertexAttribDivisor</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Let’s start changing our code base to support instanced rendering. The first step is to create a new class named <code>InstancedMesh</code> that inherits from the <code>Mesh</code> class. The constructor of this class will be similar to the similar to the <code>Mesh</code> one but with an extra parameter, the number of instances.</p> <p>In the constructor, besides relying on the superclass constructor, we will create two new VBOs, one for the model view matrix and another one for the light view matrix. The code for creating the model view matrix is presented below.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>modelViewVBO <span class="token operator">=</span> <span class="token function">glGenBuffers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
vboIdList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>modelViewVBO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>modelViewBuffer <span class="token operator">=</span> <span class="token class-name">MemoryUtil</span><span class="token punctuation">.</span><span class="token function">memAllocFloat</span><span class="token punctuation">(</span>numInstances <span class="token operator">*</span> MATRIX_SIZE_FLOATS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> modelViewVBO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> start <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">glVertexAttribPointer</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> GL_FLOAT<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> MATRIX_SIZE_BYTES<span class="token punctuation">,</span> i <span class="token operator">*</span> VECTOR4F_SIZE_BYTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glVertexAttribDivisor</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glEnableVertexAttribArray</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
    start<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>First we create a new VBO and a new <code>FloatBuffer</code> to store the data on it. The size of that buffer is measured in floats, so it will be equal to the number of instances multiplied by the size in floats of a 4x4 matrix, which is equal to 16.</p> <p>Once the VBO has been bound we start defining the attributes for it. You can see that this is done in a for loop that iterates four times. Each turn of the loop defines one vector the matrix. Why not simply defining a single attribute for the whole matrix? The reason for that is that a vertex attribute cannot contain more than four floats. Thus, we need to split the matrix definition into four pieces. Let’s refresh the parameters of the <code>glVertexAttribPointer</code>:</p> <ul><li>Index: The index of the element to be defined.</li> <li>Size: The number of components for this attribute. In this case it’s 4, 4 floats, which is the maximum accepted value.</li> <li>Type: The type of data (floats in our case).</li> <li>Normalize: If fixed-point data should be normalized or not.</li> <li>Stride: This is important to understand here, this sets the byte offsets between consecutive attributes. In this case, we need to set it to the whole size of a matrix in bytes. This acts like a mark that packs the data so it can be changed between vertex or instances.</li> <li>Pointer: The offset that this attribute definition applies to. In our case, we need to split the matrix definition into four calls. Each vector of the matrix increments the offset.</li></ul> <p>After defining the vertex attribute, we need to call the <code>glVertexAttribDivisor</code> using the same index.</p> <p>The definition of the light view matrix is similar to the previous one, you can check it in the source code. The <code>InstancedMesh</code> class defines a public method, named <code>renderListInstanced</code>, that renders a list of game items. This method splits the list of game items into chunks of size equal to the number of instances used to create the <code>InstancedMesh</code>. The real rendering method is called <code>renderChunkInstanced</code> and is defined like this.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">renderChunkInstanced</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GameItem</span><span class="token punctuation">&gt;</span></span> gameItems<span class="token punctuation">,</span> <span class="token keyword">boolean</span> depthMap<span class="token punctuation">,</span> <span class="token class-name">Transformation</span> transformation<span class="token punctuation">,</span> <span class="token class-name">Matrix4f</span> viewMatrix<span class="token punctuation">,</span> <span class="token class-name">Matrix4f</span> lightViewMatrix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>modelViewBuffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>modelLightViewBuffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">GameItem</span> gameItem <span class="token operator">:</span> gameItems<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Matrix4f</span> modelMatrix <span class="token operator">=</span> transformation<span class="token punctuation">.</span><span class="token function">buildModelMatrix</span><span class="token punctuation">(</span>gameItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depthMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Matrix4f</span> modelViewMatrix <span class="token operator">=</span> transformation<span class="token punctuation">.</span><span class="token function">buildModelViewMatrix</span><span class="token punctuation">(</span>modelMatrix<span class="token punctuation">,</span> viewMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
            modelViewMatrix<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>MATRIX_SIZE_FLOATS <span class="token operator">*</span> i<span class="token punctuation">,</span> modelViewBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Matrix4f</span> modelLightViewMatrix <span class="token operator">=</span> transformation<span class="token punctuation">.</span><span class="token function">buildModelLightViewMatrix</span><span class="token punctuation">(</span>modelMatrix<span class="token punctuation">,</span> lightViewMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
        modelLightViewMatrix<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>MATRIX_SIZE_FLOATS <span class="token operator">*</span> i<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modelLightViewBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> modelViewVBO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glBufferData</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> modelViewBuffer<span class="token punctuation">,</span> GL_DYNAMIC_DRAW<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> modelLightViewVBO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glBufferData</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> modelLightViewBuffer<span class="token punctuation">,</span> GL_DYNAMIC_DRAW<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glDrawElementsInstanced</span><span class="token punctuation">(</span>GL_TRIANGLES<span class="token punctuation">,</span> <span class="token function">getVertexCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GL_UNSIGNED_INT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gameItems<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>The method is quite simple: we iterate over the game items and calculate the model view and light view matrices. These matrices are dumped into their respective buffers. The contents of those buffers are sent to to the GPU and finally we render all of them with a single call to the <code>glDrawElementsInstanced</code> method.</p> <p>Going back to the shaders, we need to modify the vertex shader to support instanced rendering. We will first add new input parameters for the model and view matrices that will be passed when using instanced rendering.</p> <div class="language-glsl line-numbers-mode"><pre class="language-glsl"><code><span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">mat4</span> modelViewInstancedMatrix<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">mat4</span> modelLightViewInstancedMatrix<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>As you can see, the model view matrix starts at location 5. Since a matrix is defined by a set of four attributes (each one containing a vector), the light view matrix starts at location 9. Since we want to use a single shader for both non instanced and instanced rendering, we will maintain the uniforms for model and light view matrices. We only need to change their names.</p> <div class="language-glsl line-numbers-mode"><pre class="language-glsl"><code><span class="token keyword">uniform</span> <span class="token keyword">int</span> isInstanced<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> modelViewNonInstancedMatrix<span class="token punctuation">;</span>
…
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> modelLightViewNonInstancedMatrix<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>We have created another uniform to specify if we are using instanced rendering or not. In the case we are using instanced rendering the code is very simple, we just use the matrices from the input parameters.</p> <div class="language-glsl line-numbers-mode"><pre class="language-glsl"><code><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">vec4</span> initPos <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec4</span> initNormal <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">mat4</span> modelViewMatrix<span class="token punctuation">;</span>
    <span class="token keyword">mat4</span> lightViewMatrix<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> isInstanced <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        modelViewMatrix <span class="token operator">=</span> modelViewInstancedMatrix<span class="token punctuation">;</span>
        lightViewMatrix <span class="token operator">=</span> modelLightViewInstancedMatrix<span class="token punctuation">;</span>
        initPos <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        initNormal <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>vertexNormal<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>We don’t support animations for instanced rendering to simplify the example, but this technique can be perfectly used for this.
Finally, the shader just sets up appropriate values as usual.</p> <div class="language-glsl line-numbers-mode"><pre class="language-glsl"><code>    <span class="token keyword">vec4</span> mvPos <span class="token operator">=</span> modelViewMatrix <span class="token operator">*</span> initPos<span class="token punctuation">;</span>
    gl_Position <span class="token operator">=</span> projectionMatrix <span class="token operator">*</span> mvPos<span class="token punctuation">;</span>
    outTexCoord <span class="token operator">=</span> texCoord<span class="token punctuation">;</span>
    mvVertexNormal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>modelViewMatrix <span class="token operator">*</span> initNormal<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
    mvVertexPos <span class="token operator">=</span> mvPos<span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
    mlightviewVertexPos <span class="token operator">=</span> orthoProjectionMatrix <span class="token operator">*</span> lightViewMatrix <span class="token operator">*</span> initPos<span class="token punctuation">;</span>
    outModelViewMatrix <span class="token operator">=</span> modelViewMatrix<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>Of course, the <code>Renderer</code> has been modified to support the uniforms changes and to separate the rendering of non instanced meshes from the instanced ones. You can check the changes in the source code.</p> <p>In addition to that, some optimizations have been added to the source code by the JOML author <a href="https://github.com/httpdigest" target="_blank" rel="noopener noreferrer">Kai Burjack<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. These optimizations have been applied to the <code>Transformation</code> class and are summarized in the following list:</p> <ul><li>Removed redundant calls to set up matrices with identity values.</li> <li>Use quaternions for rotations which are more efficient.</li> <li>Use specific methods for rotating and translating matrices which are optimized for those operations.</li></ul> <p><img src="instanced_rendering.png" alt="Instanced Rendering"></p> <h2 id="particles-revisited"><a href="#particles-revisited" class="header-anchor">#</a> Particles revisited</h2> <p>With the support of instanced rendering we can also improve the performance for the particles rendering. Particles are the best use case for this.</p> <p>In order to apply instance rendering to particles we must provide support for texture atlas. This can be achieved by adding a new VBO with texture offsets for instanced rendering. The texture offsets can be modeled by a single vector of two floats, so there's no need to split the definition as in the matrices case.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// Texture offsets</span>
<span class="token function">glVertexAttribPointer</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> GL_FLOAT<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> INSTANCE_SIZE_BYTES<span class="token punctuation">,</span> strideStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glVertexAttribDivisor</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Instead of adding a new VBO, we will set all the instance attributes inside a single VBO. The next figure shows the concept. We are packing up all the attributes inside a single VBO. The values will change per each instance.</p> <p><img src="single_vbo.png" alt="Single VBO"></p> <p>In order to use a single VBO we need to modify the attribute size for all the attributes inside an instance. As you can see from the code above, the definition of the texture offsets uses a constant named <code>INSTANCE_SIZE_BYTES</code>. This constant is equal to the size in bytes of two matrices (one for the view model and the other one for the light view model) plus two floats (texture offsets), which in total is 136. The stride also needs to be modified properly.</p> <p>You can check the modifications in the source code.</p> <p>The <code>Renderer</code> class needs also to be modified to use instanced rendering for particles and support texture atlas in scene rendering. In this case, it makes no sense to support both types of rendering (non instance and instanced), so the modifications are simpler.</p> <p>The vertex shader for particles is also straightforward.</p> <div class="language-glsl line-numbers-mode"><pre class="language-glsl"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span></span></span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> position<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> texCoord<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> vertexNormal<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">mat4</span> modelViewMatrix<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">13</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> texOffset<span class="token punctuation">;</span>
<span class="token keyword">out</span> <span class="token keyword">vec2</span> outTexCoord<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> projectionMatrix<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">int</span> numCols<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">int</span> numRows<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> projectionMatrix <span class="token operator">*</span> modelViewMatrix <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Support for texture atlas, update texture coordinates</span>
    <span class="token keyword">float</span> x <span class="token operator">=</span> <span class="token punctuation">(</span>texCoord<span class="token punctuation">.</span>x <span class="token operator">/</span> numCols <span class="token operator">+</span> texOffset<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> y <span class="token operator">=</span> <span class="token punctuation">(</span>texCoord<span class="token punctuation">.</span>y <span class="token operator">/</span> numRows <span class="token operator">+</span> texOffset<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    outTexCoord <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>The results of these changes look exactly the same as when rendering non instanced particles but the performance is much higher. An FPS counter has been added to the window title, as an option. You can play with instanced and non instanced rendering to see the improvements by yourself.</p> <p><img src="particles.png" alt="Particles"></p> <h2 id="extra-bonus"><a href="#extra-bonus" class="header-anchor">#</a> Extra bonus</h2> <p>With all the infrastructure that we have right now, I've modified the rendering cubes code to use a height map as a base, using also texture atlas to use different textures. It also combines particles rendering. It looks like this.</p> <p><img src="cubes_height_map.png" alt="Cubes with height map"></p> <p>Please keep in mind that there's still much room for optimization, but the aim of the book is guiding you in learning LWJGL and OpenGL concepts and techniques. The goal is not to create a full blown game engine (an definitely not a voxel engine, which require a different approach and more optimizations).</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/CraftStarStudio/wjglbook-bookcontents-zh_CN/edit/master/chapter21/chapter21.md" target="_blank" rel="noopener noreferrer">帮助我们完善这个页面</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">最后更新 :</span> <span class="time">6/27/2021, 1:14:09 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/3d-game-development-with-lwjgl/chapter20/chapter20.html" class="prev">
        Particles
      </a></span> <span class="next"><a href="/3d-game-development-with-lwjgl/chapter22/chapter22.html">
        Audio
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/3d-game-development-with-lwjgl/assets/js/app.519c1cc5.js" defer></script><script src="/3d-game-development-with-lwjgl/assets/js/2.e7870360.js" defer></script><script src="/3d-game-development-with-lwjgl/assets/js/30.ee00c5df.js" defer></script>
  </body>
</html>
