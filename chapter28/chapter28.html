<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Deferred Shading | 使用 LWJGL 3 开发 3D 游戏</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/3d-game-development-with-lwjgl/assets/css/0.styles.33e5fdc6.css" as="style"><link rel="preload" href="/3d-game-development-with-lwjgl/assets/js/app.519c1cc5.js" as="script"><link rel="preload" href="/3d-game-development-with-lwjgl/assets/js/2.e7870360.js" as="script"><link rel="preload" href="/3d-game-development-with-lwjgl/assets/js/37.ec274013.js" as="script"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/10.7296f99c.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/11.a42afaf0.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/12.b7fdae6a.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/13.01b80f30.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/14.06f37286.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/15.c4635c97.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/16.f4253e97.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/17.c7f6896c.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/18.8a24c215.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/19.ab6ce5f4.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/20.9046ed34.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/21.3cb4242e.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/22.b2fa78a0.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/23.a9e504af.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/24.12580511.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/25.a115cf89.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/26.7193040d.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/27.4fa5cc0d.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/28.e559af67.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/29.d5befc6c.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/3.8fb1d8aa.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/30.ee00c5df.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/31.0effa8ac.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/32.c13100cf.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/33.c9fbfcdb.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/34.7bde7785.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/35.604c8847.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/36.ccd3a84c.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/38.66d82b73.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/4.e1b9ee22.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/5.75c3f2db.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/6.601d5460.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/7.1f9c2020.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/8.be9c92d8.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/9.048bb756.js">
    <link rel="stylesheet" href="/3d-game-development-with-lwjgl/assets/css/0.styles.33e5fdc6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/3d-game-development-with-lwjgl/" class="home-link router-link-active"><!----> <span class="site-name">使用 LWJGL 3 开发 3D 游戏</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/3d-game-development-with-lwjgl/" aria-current="page" class="sidebar-link">封面</a></li><li><a href="/3d-game-development-with-lwjgl/INTRODUCTION.html" class="sidebar-link">简介</a></li><li><a href="/3d-game-development-with-lwjgl/chapter01/chapter1.html" class="sidebar-link">第一步</a></li><li><a href="/3d-game-development-with-lwjgl/chapter02/chapter2.html" class="sidebar-link">The Game Loop</a></li><li><a href="/3d-game-development-with-lwjgl/chapter03/chapter3.html" class="sidebar-link">A brief about coordinates</a></li><li><a href="/3d-game-development-with-lwjgl/chapter04/chapter4.html" class="sidebar-link">Rendering</a></li><li><a href="/3d-game-development-with-lwjgl/chapter05/chapter5.html" class="sidebar-link">More on Rendering</a></li><li><a href="/3d-game-development-with-lwjgl/chapter06/chapter6.html" class="sidebar-link">Transformations</a></li><li><a href="/3d-game-development-with-lwjgl/chapter07/chapter7.html" class="sidebar-link">Textures</a></li><li><a href="/3d-game-development-with-lwjgl/chapter08/chapter8.html" class="sidebar-link">Camera</a></li><li><a href="/3d-game-development-with-lwjgl/chapter09/chapter9.html" class="sidebar-link">Loading more complex models</a></li><li><a href="/3d-game-development-with-lwjgl/chapter10/chapter10.html" class="sidebar-link">Let there be light</a></li><li><a href="/3d-game-development-with-lwjgl/chapter11/chapter11.html" class="sidebar-link">Let there be even more light</a></li><li><a href="/3d-game-development-with-lwjgl/chapter12/chapter12.html" class="sidebar-link">Game HUD</a></li><li><a href="/3d-game-development-with-lwjgl/chapter13/chapter13.html" class="sidebar-link">Sky Box and some optimizations</a></li><li><a href="/3d-game-development-with-lwjgl/chapter14/chapter14.html" class="sidebar-link">Height Maps</a></li><li><a href="/3d-game-development-with-lwjgl/chapter15/chapter15.html" class="sidebar-link">Terrain Collisions</a></li><li><a href="/3d-game-development-with-lwjgl/chapter16/chapter16.html" class="sidebar-link">Fog</a></li><li><a href="/3d-game-development-with-lwjgl/chapter17/chapter17.html" class="sidebar-link">Normal Mapping</a></li><li><a href="/3d-game-development-with-lwjgl/chapter18/chapter18.html" class="sidebar-link">Shadows</a></li><li><a href="/3d-game-development-with-lwjgl/chapter19/chapter19.html" class="sidebar-link">Animations</a></li><li><a href="/3d-game-development-with-lwjgl/chapter20/chapter20.html" class="sidebar-link">Particles</a></li><li><a href="/3d-game-development-with-lwjgl/chapter21/chapter21.html" class="sidebar-link">Instanced Rendering</a></li><li><a href="/3d-game-development-with-lwjgl/chapter22/chapter22.html" class="sidebar-link">Audio</a></li><li><a href="/3d-game-development-with-lwjgl/chapter23/chapter23.html" class="sidebar-link">3D Object Picking</a></li><li><a href="/3d-game-development-with-lwjgl/chapter24/chapter24.html" class="sidebar-link">HUD Revisited - NanoVG</a></li><li><a href="/3d-game-development-with-lwjgl/chapter25/chapter25.html" class="sidebar-link">Optimizations - Frustum Culling \(I\)</a></li><li><a href="/3d-game-development-with-lwjgl/chapter26/chapter26.html" class="sidebar-link">Cascaded Shadow Maps</a></li><li><a href="/3d-game-development-with-lwjgl/chapter27/chapter27.html" class="sidebar-link">Assimp</a></li><li><a href="/3d-game-development-with-lwjgl/chapter28/chapter28.html" aria-current="page" class="active sidebar-link">Deferred Shading</a></li><li><a href="/3d-game-development-with-lwjgl/appendixa/appendixa.html" class="sidebar-link">Appendix A - OpenGL Debugging</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="deferred-shading"><a href="#deferred-shading" class="header-anchor">#</a> Deferred Shading</h1> <p>Up to now the way that we are rendering a 3D scene is called forward rendering. We first render the 3D objects and apply the texture and lighting effects in a fragment shader. This method is not very efficient if we have a complex fragment shader pass with many lights and complex effects. In addition to that we may end up applying these effects to fragments that may be later on discarded due to depth testing (although this is not exactly true if we enable <a href="https://www.khronos.org/opengl/wiki/Early_Fragment_Test" target="_blank" rel="noopener noreferrer">early fragment testing<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>).</p> <p>In order to alleviate the problems described above we may change the way that we render the scene by using a technical called deferred shading. With deferred shading we first render the geometry information that is required in later stages (in the fragment shader) to a buffer. The complex calculus required by the fragment shader are postponed, deferred, to a later stage when using the information stored in those buffers.</p> <p>Hence, with deferred shading we perform two rendering passes. The first one, is the geometry pass, where we render the scene to a buffer that will contain the following information:</p> <ul><li>The positions (in our case in light view coordinate system, although you may see other samples where world coordinates are used).</li> <li>The diffuse colours for each position.</li> <li>The specular component for each position.</li> <li>The normals at each position (also in light view coordinate system).</li> <li>Shadow map for the directional light (you may find that this step is done separately in other implementations).</li></ul> <p>All that information is stored in a buffer called G-Buffer.</p> <p>The second pass is called the lighting pass. This pass takes a quad that fills up all the screen and generates the colour information for each fragment using the information contained in the G-Buffer. When we will be performing the lighting pass, the depth test will have already removed all the scene data that would not be seen. Hence, the number of operations to be done are restricted to what will be displayed on the screen.</p> <p><img src="schema.png" alt=""></p> <p>You may be asking if performing additional rendering passes will result in an increase of performance or not. The answer is that it depends. Deferred shading is usually used when you have many different light passes. In this case, the additional rendering steps are compensated by the reduction of operations that will be done in the fragment shader.</p> <p>So let’s start coding. The first task that we will be doing is create a new class for the G-Buffer. The class, named <code>GBuffer</code>, is defined like this:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>lwjglb<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>graph</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>lwjgl<span class="token punctuation">.</span>system<span class="token punctuation">.</span></span><span class="token class-name">MemoryStack</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>lwjglb<span class="token punctuation">.</span>engine<span class="token punctuation">.</span></span><span class="token class-name">Window</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span></span><span class="token class-name">ByteBuffer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span></span><span class="token class-name">IntBuffer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">org<span class="token punctuation">.</span>lwjgl<span class="token punctuation">.</span>opengl<span class="token punctuation">.</span></span>GL11<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">org<span class="token punctuation">.</span>lwjgl<span class="token punctuation">.</span>opengl<span class="token punctuation">.</span></span>GL20<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">org<span class="token punctuation">.</span>lwjgl<span class="token punctuation">.</span>opengl<span class="token punctuation">.</span></span>GL30<span class="token punctuation">.</span>*<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GBuffer</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> TOTAL_TEXTURES <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> gBufferId<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> textureIds<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> width<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> height<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>The class defines a constant that models the maximum number of buffers to be used. The identifier associated to the G-Buffer itself and an array for the individual buffers. The size of the screen is also stored.</p> <p>Let’s review the constructor:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">GBuffer</span><span class="token punctuation">(</span><span class="token class-name">Window</span> window<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// Create G-Buffer</span>
    gBufferId <span class="token operator">=</span> <span class="token function">glGenFramebuffers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glBindFramebuffer</span><span class="token punctuation">(</span>GL_DRAW_FRAMEBUFFER<span class="token punctuation">,</span> gBufferId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    textureIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>TOTAL_TEXTURES<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">glGenTextures</span><span class="token punctuation">(</span>textureIds<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create textures for position, diffuse color, specular color, normal, shadow factor and depth</span>
    <span class="token comment">// All coordinates are in world coordinates system</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>TOTAL_TEXTURES<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> textureIds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> attachmentType<span class="token punctuation">;</span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> TOTAL_TEXTURES <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">:</span>
                <span class="token comment">// Depth component</span>
                <span class="token function">glTexImage2D</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GL_DEPTH_COMPONENT32F<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GL_DEPTH_COMPONENT<span class="token punctuation">,</span> GL_FLOAT<span class="token punctuation">,</span>
                        <span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">)</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                attachmentType <span class="token operator">=</span> GL_DEPTH_ATTACHMENT<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token function">glTexImage2D</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GL_RGB32F<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GL_RGB<span class="token punctuation">,</span> GL_FLOAT<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">)</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                attachmentType <span class="token operator">=</span> GL_COLOR_ATTACHMENT0 <span class="token operator">+</span> i<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// For sampling</span>
        <span class="token function">glTexParameterf</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> GL_TEXTURE_MIN_FILTER<span class="token punctuation">,</span> GL_NEAREST<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">glTexParameterf</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> GL_TEXTURE_MAG_FILTER<span class="token punctuation">,</span> GL_NEAREST<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Attach the texture to the G-Buffer</span>
        <span class="token function">glFramebufferTexture2D</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> attachmentType<span class="token punctuation">,</span> GL_TEXTURE_2D<span class="token punctuation">,</span> textureIds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">MemoryStack</span> stack <span class="token operator">=</span> <span class="token class-name">MemoryStack</span><span class="token punctuation">.</span><span class="token function">stackPush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">IntBuffer</span> intBuff <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">mallocInt</span><span class="token punctuation">(</span>TOTAL_TEXTURES<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> values<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>GL_COLOR_ATTACHMENT0<span class="token punctuation">,</span> GL_COLOR_ATTACHMENT1<span class="token punctuation">,</span> GL_COLOR_ATTACHMENT2<span class="token punctuation">,</span> GL_COLOR_ATTACHMENT3<span class="token punctuation">,</span> GL_COLOR_ATTACHMENT4<span class="token punctuation">,</span> GL_COLOR_ATTACHMENT5<span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> values<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            intBuff<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>values<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        intBuff<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">glDrawBuffers</span><span class="token punctuation">(</span>intBuff<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Unbind</span>
    <span class="token function">glBindFramebuffer</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><p>The first thing that we do is create a frame buffer. Remember that a frame buffer is just an OpenGL objects that can be used to render operations instead of rendering to the screen. Then we generate a set of textures (6 textures), that will be associated to the frame buffer.</p> <p>After that, we use a for loop to initialize the textures. We have the following types:</p> <ul><li>“Regular textures”, that will store positions, normals, the diffuse component, etc.</li> <li>A texture for storing the depth buffer. This will be our last texture.</li></ul> <p>Once the texture has been initialized, we enable sampling for them and attach them to the frame buffer. Each texture is attached using an identifier which starts at <code>GL_COLOR_ATTACHMENT0</code>. Each texture increments by one that id, so the positions are attached using <code>GL_COLOR_ATTACHMENT0</code>, the diffuse component uses <code>GL_COLOR_ATTACHMENT1</code> (which is <code>GL_COLOR_ATTACHMENT0 + 1</code>), and so on.</p> <p>After all the textures have been created, we need to enable them to be used by the fragment shader for rendering. This is done with the <code>glDrawBuffers</code> call. We just pass the array with the identifiers of the colour attachments used (<code>GL_COLOR_ATTACHMENT0</code> to <code>GL_COLOR_ATTACHMENT5</code>).</p> <p>The rest of the class are just getter methods and the cleanup one.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> width<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> height<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getGBufferId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> gBufferId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getTextureIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> textureIds<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getPositionTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> textureIds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getDepthTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> textureIds<span class="token punctuation">[</span>TOTAL_TEXTURES<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cleanUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">glDeleteFramebuffers</span><span class="token punctuation">(</span>gBufferId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>textureIds <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>TOTAL_TEXTURES<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">glDeleteTextures</span><span class="token punctuation">(</span>textureIds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>We will create a new class named <code>SceneBuffer</code> which is just another frame buffer. We will use it when performing the light pass. Instead of rendering directly to the screen we will render to this frame buffer. By doing it this way, we can apply the rest of the effects (such as fog, skybox, etc.). The class is defined like this.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>lwjglb<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>graph</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>lwjglb<span class="token punctuation">.</span>engine<span class="token punctuation">.</span></span><span class="token class-name">Window</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span></span><span class="token class-name">ByteBuffer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">org<span class="token punctuation">.</span>lwjgl<span class="token punctuation">.</span>opengl<span class="token punctuation">.</span></span>GL11<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">org<span class="token punctuation">.</span>lwjgl<span class="token punctuation">.</span>opengl<span class="token punctuation">.</span></span>GL30<span class="token punctuation">.</span>*<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SceneBuffer</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> bufferId<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> textureId<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SceneBuffer</span><span class="token punctuation">(</span><span class="token class-name">Window</span> window<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// Create the buffer</span>
        bufferId <span class="token operator">=</span> <span class="token function">glGenFramebuffers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">glBindFramebuffer</span><span class="token punctuation">(</span>GL_DRAW_FRAMEBUFFER<span class="token punctuation">,</span> bufferId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Create texture</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> textureIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">glGenTextures</span><span class="token punctuation">(</span>textureIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        textureId <span class="token operator">=</span> textureIds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> textureId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">glTexImage2D</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GL_RGB32F<span class="token punctuation">,</span> window<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GL_RGB<span class="token punctuation">,</span> GL_FLOAT<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">)</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// For sampling</span>
        <span class="token function">glTexParameterf</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> GL_TEXTURE_MIN_FILTER<span class="token punctuation">,</span> GL_NEAREST<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">glTexParameterf</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> GL_TEXTURE_MAG_FILTER<span class="token punctuation">,</span> GL_NEAREST<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Attach the texture to the G-Buffer</span>
        <span class="token function">glFramebufferTexture2D</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> GL_COLOR_ATTACHMENT0<span class="token punctuation">,</span> GL_TEXTURE_2D<span class="token punctuation">,</span> textureId<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Unbind</span>
        <span class="token function">glBindFramebuffer</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getBufferId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> bufferId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getTextureId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> textureId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">glDeleteFramebuffers</span><span class="token punctuation">(</span>bufferId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">glDeleteTextures</span><span class="token punctuation">(</span>textureId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p>As you can see, this is similar to the <code>GBuffer</code> class, but here we will only use a single texture to store the resulting colours. Now that we have created these new classes, we can start using them. In the <code>Renderer</code> class, we will no longer be using the forward rendering shaders we were using for rendering the scene (named <code>scene_vertex.vs</code> and <code>scene_fragment.fs</code>).</p> <p>In the <code>init</code> method of the <code>Renderer</code> class you may see that a <code>GBuffer</code> instance is created and that we initialize and another set of shaders for the geometry pass (by calling the <code>setupGeometryShader</code> method) and the light pass (by calling the <code>setupDirLightShader</code> and <code>setupPointLightShader</code> methods). You may see also that we create a instance of the class <code>SceneBuffer</code> named <code>sceneBuffer</code>. This will be used when rendering lights as explained before. An utility matrix named <code>bufferPassModelMatrix</code> is also instantiated (it will be used when performing the geometry pass). You can see that we create a new <code>Mesh</code> at the end of the <code>init</code> method. This will be used in the light pass. More on this will be explained later.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Window</span> window<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    shadowRenderer<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GBuffer</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sceneBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SceneBuffer</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setupSkyBoxShader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setupParticlesShader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setupGeometryShader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setupDirLightShader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setupPointLightShader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setupFogShader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    bufferPassModelMatrix <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">Matrix4f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bufferPassMesh <span class="token operator">=</span> <span class="token class-name">StaticMeshesLoader</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">&quot;src/main/resources/models/buffer_pass_mess.obj&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;src/main/resources/models&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>The shaders used in the geometry and light passes are defined like usual (you can check the source code directly). Let’s focus in their content instead. Let’s focus in their content instead. We will start with the geometry pass, here’s the vertex shader code (<code>gbuffer_vertex.vs</code>):</p> <div class="language-glsl line-numbers-mode"><pre class="language-glsl"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span></span></span>

<span class="token keyword">const</span> <span class="token keyword">int</span> MAX_WEIGHTS <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">int</span> MAX_JOINTS <span class="token operator">=</span> <span class="token number">150</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">int</span> NUM_CASCADES <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>

<span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> position<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> texCoord<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> vertexNormal<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec4</span> jointWeights<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">ivec4</span> jointIndices<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">mat4</span> modelInstancedMatrix<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> texOffset<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">float</span> selectedInstanced<span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">int</span> isInstanced<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> viewMatrix<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> projectionMatrix<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> modelNonInstancedMatrix<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> jointsMatrix<span class="token punctuation">[</span>MAX_JOINTS<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> lightViewMatrix<span class="token punctuation">[</span>NUM_CASCADES<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> orthoProjectionMatrix<span class="token punctuation">[</span>NUM_CASCADES<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">int</span> numCols<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">int</span> numRows<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">float</span> selectedNonInstanced<span class="token punctuation">;</span>

<span class="token keyword">out</span> <span class="token keyword">vec2</span>  vs_textcoord<span class="token punctuation">;</span>
<span class="token keyword">out</span> <span class="token keyword">vec3</span>  vs_normal<span class="token punctuation">;</span>
<span class="token keyword">out</span> <span class="token keyword">vec4</span>  vs_mvVertexPos<span class="token punctuation">;</span>
<span class="token keyword">out</span> <span class="token keyword">vec4</span>  vs_mlightviewVertexPos<span class="token punctuation">[</span>NUM_CASCADES<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">out</span> <span class="token keyword">mat4</span>  vs_modelMatrix<span class="token punctuation">;</span>
<span class="token keyword">out</span> <span class="token keyword">float</span> vs_selected<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">vec4</span> initPos <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec4</span> initNormal <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">mat4</span> modelMatrix<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> isInstanced <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        vs_selected <span class="token operator">=</span> selectedInstanced<span class="token punctuation">;</span>
        modelMatrix <span class="token operator">=</span> modelInstancedMatrix<span class="token punctuation">;</span>

        initPos <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        initNormal <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>vertexNormal<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        vs_selected <span class="token operator">=</span> selectedNonInstanced<span class="token punctuation">;</span>
        modelMatrix <span class="token operator">=</span> modelNonInstancedMatrix<span class="token punctuation">;</span>

        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_WEIGHTS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">float</span> weight <span class="token operator">=</span> jointWeights<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>weight <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                count<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> jointIndex <span class="token operator">=</span> jointIndices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">vec4</span> tmpPos <span class="token operator">=</span> jointsMatrix<span class="token punctuation">[</span>jointIndex<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                initPos <span class="token operator">+=</span> weight <span class="token operator">*</span> tmpPos<span class="token punctuation">;</span>

                <span class="token keyword">vec4</span> tmpNormal <span class="token operator">=</span> jointsMatrix<span class="token punctuation">[</span>jointIndex<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>vertexNormal<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                initNormal <span class="token operator">+=</span> weight <span class="token operator">*</span> tmpNormal<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            initPos <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            initNormal <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>vertexNormal<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">mat4</span> modelViewMatrix <span class="token operator">=</span> viewMatrix <span class="token operator">*</span> modelMatrix<span class="token punctuation">;</span>
    vs_mvVertexPos <span class="token operator">=</span> modelViewMatrix <span class="token operator">*</span> initPos<span class="token punctuation">;</span>
    gl_Position <span class="token operator">=</span> projectionMatrix <span class="token operator">*</span> vs_mvVertexPos<span class="token punctuation">;</span>

    <span class="token comment">// Support for texture atlas, update texture coordinates</span>
    <span class="token keyword">float</span> x <span class="token operator">=</span> <span class="token punctuation">(</span>texCoord<span class="token punctuation">.</span>x <span class="token operator">/</span> numCols <span class="token operator">+</span> texOffset<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> y <span class="token operator">=</span> <span class="token punctuation">(</span>texCoord<span class="token punctuation">.</span>y <span class="token operator">/</span> numRows <span class="token operator">+</span> texOffset<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>

    vs_textcoord <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vs_normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>modelViewMatrix <span class="token operator">*</span> initNormal<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NUM_CASCADES <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vs_mlightviewVertexPos<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> orthoProjectionMatrix<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> lightViewMatrix<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> modelMatrix <span class="token operator">*</span> initPos<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    vs_modelMatrix <span class="token operator">=</span> modelMatrix<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br></div></div><p>This shader is very similar to the vertex shader used in previous chapters to render a scene. There are some changes in the name of the output variables but in essence is the same shader. Indeed, it should be almost the same, the way we render the vertices should not change, the major changes are done in the fragment shader, which is defined like this (<code>gbuffer_fragment.fs</code>):</p> <div class="language-glsl line-numbers-mode"><pre class="language-glsl"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span></span></span>

<span class="token keyword">const</span> <span class="token keyword">int</span> NUM_CASCADES <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>

<span class="token keyword">in</span> <span class="token keyword">vec2</span>  vs_textcoord<span class="token punctuation">;</span>
<span class="token keyword">in</span> <span class="token keyword">vec3</span>  vs_normal<span class="token punctuation">;</span>
<span class="token keyword">in</span> <span class="token keyword">vec4</span>  vs_mvVertexPos<span class="token punctuation">;</span>
<span class="token keyword">in</span> <span class="token keyword">vec4</span>  vs_mlightviewVertexPos<span class="token punctuation">[</span>NUM_CASCADES<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">in</span> <span class="token keyword">mat4</span>  vs_modelMatrix<span class="token punctuation">;</span>
<span class="token keyword">in</span> <span class="token keyword">float</span> vs_selected<span class="token punctuation">;</span>

<span class="token keyword">layout</span> <span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec3</span> fs_worldpos<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec3</span> fs_diffuse<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec3</span> fs_specular<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec3</span> fs_normal<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec2</span> fs_shadow<span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> viewMatrix<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">Material</span>
<span class="token punctuation">{</span>
    <span class="token keyword">vec4</span> diffuse<span class="token punctuation">;</span>
    <span class="token keyword">vec4</span> specular<span class="token punctuation">;</span>
    <span class="token keyword">int</span> hasTexture<span class="token punctuation">;</span>
    <span class="token keyword">int</span> hasNormalMap<span class="token punctuation">;</span>
    <span class="token keyword">float</span> reflectance<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> texture_sampler<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> normalMap<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> Material  material<span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> shadowMap_0<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> shadowMap_1<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> shadowMap_2<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">float</span> cascadeFarPlanes<span class="token punctuation">[</span>NUM_CASCADES<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> orthoProjectionMatrix<span class="token punctuation">[</span>NUM_CASCADES<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">int</span> renderShadow<span class="token punctuation">;</span>

<span class="token keyword">vec4</span> diffuseC<span class="token punctuation">;</span>
<span class="token keyword">vec4</span> speculrC<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">getColour</span><span class="token punctuation">(</span>Material material<span class="token punctuation">,</span> <span class="token keyword">vec2</span> textCoord<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>material<span class="token punctuation">.</span>hasTexture <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        diffuseC <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span>texture_sampler<span class="token punctuation">,</span> textCoord<span class="token punctuation">)</span><span class="token punctuation">;</span>
        speculrC <span class="token operator">=</span> diffuseC<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        diffuseC <span class="token operator">=</span> material<span class="token punctuation">.</span>diffuse<span class="token punctuation">;</span>
        speculrC <span class="token operator">=</span> material<span class="token punctuation">.</span>specular<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">vec3</span> <span class="token function">calcNormal</span><span class="token punctuation">(</span>Material material<span class="token punctuation">,</span> <span class="token keyword">vec3</span> normal<span class="token punctuation">,</span> <span class="token keyword">vec2</span> text_coord<span class="token punctuation">,</span> <span class="token keyword">mat4</span> modelMatrix<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">vec3</span> newNormal <span class="token operator">=</span> normal<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> material<span class="token punctuation">.</span>hasNormalMap <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        newNormal <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span>normalMap<span class="token punctuation">,</span> text_coord<span class="token punctuation">)</span><span class="token punctuation">.</span>rgb<span class="token punctuation">;</span>
        newNormal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>newNormal <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        newNormal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>viewMatrix <span class="token operator">*</span> modelMatrix <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>newNormal<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> newNormal<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">calcShadow</span><span class="token punctuation">(</span><span class="token keyword">vec4</span> position<span class="token punctuation">,</span> <span class="token keyword">int</span> idx<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> renderShadow <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">vec3</span> projCoords <span class="token operator">=</span> position<span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
    <span class="token comment">// Transform from screen coordinates to texture coordinates</span>
    projCoords <span class="token operator">=</span> projCoords <span class="token operator">*</span> <span class="token number">0.5</span> <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> bias <span class="token operator">=</span> <span class="token number">0.005</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span> shadowFactor <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token keyword">vec2</span> inc<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        inc <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token function">textureSize</span><span class="token punctuation">(</span>shadowMap_0<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        inc <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token function">textureSize</span><span class="token punctuation">(</span>shadowMap_1<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        inc <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token function">textureSize</span><span class="token punctuation">(</span>shadowMap_2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> row <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> row <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">++</span>row<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> col <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> col <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">++</span>col<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">float</span> textDepth<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                textDepth <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span>shadowMap_0<span class="token punctuation">,</span> projCoords<span class="token punctuation">.</span>xy <span class="token operator">+</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span>row<span class="token punctuation">,</span> col<span class="token punctuation">)</span> <span class="token operator">*</span> inc<span class="token punctuation">)</span><span class="token punctuation">.</span>r<span class="token punctuation">;</span> 
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                textDepth <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span>shadowMap_1<span class="token punctuation">,</span> projCoords<span class="token punctuation">.</span>xy <span class="token operator">+</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span>row<span class="token punctuation">,</span> col<span class="token punctuation">)</span> <span class="token operator">*</span> inc<span class="token punctuation">)</span><span class="token punctuation">.</span>r<span class="token punctuation">;</span> 
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                textDepth <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span>shadowMap_2<span class="token punctuation">,</span> projCoords<span class="token punctuation">.</span>xy <span class="token operator">+</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span>row<span class="token punctuation">,</span> col<span class="token punctuation">)</span> <span class="token operator">*</span> inc<span class="token punctuation">)</span><span class="token punctuation">.</span>r<span class="token punctuation">;</span> 
            <span class="token punctuation">}</span>
            shadowFactor <span class="token operator">+=</span> projCoords<span class="token punctuation">.</span>z <span class="token operator">-</span> bias <span class="token operator">&gt;</span> textDepth <span class="token operator">?</span> <span class="token number">1.0</span> <span class="token operator">:</span> <span class="token number">0.0</span><span class="token punctuation">;</span>        
        <span class="token punctuation">}</span>    
    <span class="token punctuation">}</span>
    shadowFactor <span class="token operator">/=</span> <span class="token number">9.0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>projCoords<span class="token punctuation">.</span>z <span class="token operator">&gt;</span> <span class="token number">1.0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        shadowFactor <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">1</span> <span class="token operator">-</span> shadowFactor<span class="token punctuation">;</span>
<span class="token punctuation">}</span> 

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">getColour</span><span class="token punctuation">(</span>material<span class="token punctuation">,</span> vs_textcoord<span class="token punctuation">)</span><span class="token punctuation">;</span>

    fs_worldpos   <span class="token operator">=</span> vs_mvVertexPos<span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
    fs_diffuse    <span class="token operator">=</span> diffuseC<span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
    fs_specular   <span class="token operator">=</span> speculrC<span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
    fs_normal     <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">calcNormal</span><span class="token punctuation">(</span>material<span class="token punctuation">,</span> vs_normal<span class="token punctuation">,</span> vs_textcoord<span class="token punctuation">,</span> vs_modelMatrix<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> idx<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>NUM_CASCADES<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">abs</span><span class="token punctuation">(</span>vs_mvVertexPos<span class="token punctuation">.</span>z<span class="token punctuation">)</span> <span class="token operator">&lt;</span> cascadeFarPlanes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            idx <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    fs_shadow  <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token function">calcShadow</span><span class="token punctuation">(</span>vs_mlightviewVertexPos<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">,</span> material<span class="token punctuation">.</span>reflectance<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> vs_selected <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fs_diffuse <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span>fs_diffuse<span class="token punctuation">.</span>x<span class="token punctuation">,</span> fs_diffuse<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br></div></div><p>The most relevant lines are:</p> <div class="language-glsl line-numbers-mode"><pre class="language-glsl"><code><span class="token keyword">layout</span> <span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec3</span> fs_worldpos<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec3</span> fs_diffuse<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec3</span> fs_specular<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec3</span> fs_normal<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec2</span> fs_shadow<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>This is where we are referring to the textures that this fragment shader will write to. As you can see we just dump the position (in light view coordinates), the diffuse colour (which can be the colour of the associated texture of a component of the material), the specular component, the normal, and the depth values for the shadow map.</p> <p>SIDE NOTE: We have simplified the <code>Material</code> class definition removing the ambient colour component.</p> <p>Going back to the <code>Renderer</code> class, the <code>render</code> method is defined like this:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token class-name">Window</span> window<span class="token punctuation">,</span> <span class="token class-name">Camera</span> camera<span class="token punctuation">,</span> <span class="token class-name">Scene</span> scene<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sceneChanged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>frustumCulling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        frustumFilter<span class="token punctuation">.</span><span class="token function">updateFrustum</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span><span class="token function">getProjectionMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> camera<span class="token punctuation">.</span><span class="token function">getViewMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        frustumFilter<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>scene<span class="token punctuation">.</span><span class="token function">getGameMeshes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        frustumFilter<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>scene<span class="token punctuation">.</span><span class="token function">getGameInstancedMeshes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Render depth map before view ports has been set up</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>scene<span class="token punctuation">.</span><span class="token function">isRenderShadows</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> sceneChanged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        shadowRenderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> scene<span class="token punctuation">,</span> camera<span class="token punctuation">,</span> transformation<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">glViewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Update projection matrix once per render cycle</span>
    window<span class="token punctuation">.</span><span class="token function">updateProjectionMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">renderGeometry</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> camera<span class="token punctuation">,</span> scene<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">initLightRendering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">renderPointLights</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> camera<span class="token punctuation">,</span> scene<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">renderDirectionalLight</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> camera<span class="token punctuation">,</span> scene<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">endLightRendering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">renderFog</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> camera<span class="token punctuation">,</span> scene<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">renderSkyBox</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> camera<span class="token punctuation">,</span> scene<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">renderParticles</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> camera<span class="token punctuation">,</span> scene<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>The geometry pass is done in the <code>renderGeometry</code> method (you can see that we no longer have a <code>renderScene</code>). The lighting pass is done in several steps, first we setup the buffer and other parameters to be used (<code>initLightRendering</code>), then we render point lights (<code>renderPointLights</code>) and the directional light (<code>renderDirectionalLight</code>) and finally the state is restored (<code>endLightRendering</code>).</p> <p>Let’s start with the geometry pass. The <code>renderGeometry</code> method is almost equivalent to the <code>renderScene</code> method used in previous chapters:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">renderGeometry</span><span class="token punctuation">(</span><span class="token class-name">Window</span> window<span class="token punctuation">,</span> <span class="token class-name">Camera</span> camera<span class="token punctuation">,</span> <span class="token class-name">Scene</span> scene<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Render G-Buffer for writing</span>
    <span class="token function">glBindFramebuffer</span><span class="token punctuation">(</span>GL_DRAW_FRAMEBUFFER<span class="token punctuation">,</span> gBuffer<span class="token punctuation">.</span><span class="token function">getGBufferId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">glDisable</span><span class="token punctuation">(</span>GL_BLEND<span class="token punctuation">)</span><span class="token punctuation">;</span>

    gBufferShaderProgram<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Matrix4f</span> viewMatrix <span class="token operator">=</span> camera<span class="token punctuation">.</span><span class="token function">getViewMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Matrix4f</span> projectionMatrix <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">getProjectionMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gBufferShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;viewMatrix&quot;</span><span class="token punctuation">,</span> viewMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gBufferShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;projectionMatrix&quot;</span><span class="token punctuation">,</span> projectionMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>

    gBufferShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;texture_sampler&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gBufferShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;normalMap&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ShadowCascade</span><span class="token punctuation">&gt;</span></span> shadowCascades <span class="token operator">=</span> shadowRenderer<span class="token punctuation">.</span><span class="token function">getShadowCascades</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token class-name">ShadowRenderer</span><span class="token punctuation">.</span>NUM_CASCADES<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ShadowCascade</span> shadowCascade <span class="token operator">=</span> shadowCascades<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        gBufferShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;orthoProjectionMatrix&quot;</span><span class="token punctuation">,</span> shadowCascade<span class="token punctuation">.</span><span class="token function">getOrthoProjMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        gBufferShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;cascadeFarPlanes&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ShadowRenderer</span><span class="token punctuation">.</span>CASCADE_SPLITS<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        gBufferShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;lightViewMatrix&quot;</span><span class="token punctuation">,</span> shadowCascade<span class="token punctuation">.</span><span class="token function">getLightViewMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    shadowRenderer<span class="token punctuation">.</span><span class="token function">bindTextures</span><span class="token punctuation">(</span>GL_TEXTURE2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> start <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token class-name">ShadowRenderer</span><span class="token punctuation">.</span>NUM_CASCADES<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        gBufferShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;shadowMap_&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> start <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    gBufferShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;renderShadow&quot;</span><span class="token punctuation">,</span> scene<span class="token punctuation">.</span><span class="token function">isRenderShadows</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">renderNonInstancedMeshes</span><span class="token punctuation">(</span>scene<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">renderInstancedMeshes</span><span class="token punctuation">(</span>scene<span class="token punctuation">,</span> viewMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>

    gBufferShaderProgram<span class="token punctuation">.</span><span class="token function">unbind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">glEnable</span><span class="token punctuation">(</span>GL_BLEND<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>The only differences are:</p> <ul><li>We bind to the G-Buffer instead of the screen.</li> <li>We disable blending. Since we just want to work with the values that are closest to the camera (the lowest depth values), we do not need blending.</li></ul> <p>If you debug the sample execution with an OpenGL debugger (such as RenderDoc), you can view the textures generated during the geometry pass. The positions texture will look like this:</p> <p><img src="text_positions.png" alt=""></p> <p>The texture that holds the values for the diffuse component will look like this:</p> <p><img src="text_diffuse.png" alt=""></p> <p>The texture that holds the values for the normals will look like this:</p> <p><img src="text_normals.png" alt=""></p> <p>Now it’s the turn of the light pass. We first need to set up a few things before rendering, this is done in the <code>initLightRendering</code> method:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initLightRendering</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Bind scene buffer</span>
    <span class="token function">glBindFramebuffer</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> sceneBuffer<span class="token punctuation">.</span><span class="token function">getBufferId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Clear G-Buffer</span>
    <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Disable depth testing to allow the drawing of multiple layers with the same depth</span>
    <span class="token function">glDisable</span><span class="token punctuation">(</span>GL_DEPTH_TEST<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">glEnable</span><span class="token punctuation">(</span>GL_BLEND<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glBlendEquation</span><span class="token punctuation">(</span>GL_FUNC_ADD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glBlendFunc</span><span class="token punctuation">(</span>GL_ONE<span class="token punctuation">,</span> GL_ONE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Bind GBuffer for reading</span>
    <span class="token function">glBindFramebuffer</span><span class="token punctuation">(</span>GL_READ_FRAMEBUFFER<span class="token punctuation">,</span> gBuffer<span class="token punctuation">.</span><span class="token function">getGBufferId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>Since we won’t be rendering to the screen, we first need to bind to the texture that will hold the results of the lighting pass. Then we clear that buffer and disable depth testing. This is not required any more, as depth testing has been already done in the geometry pass. Another important step is to enable blending. The last action is to enable the G-Buffer for reading, it will be used during the light pass.</p> <p>Before analyzing the render methods for the different types of light, let’s think a little bit about how we will render the lights. We need to use the contents of the G-Buffer, but in order to use them, we need to first render something. But, we have already drawn the scene, what are we going to render. now? The answer is simple, we just need to render a quad that fills all the screen. For each fragment of that quad, we will use the data contained in the G-Buffer and generate the correct output colour. Do you remember the <code>Mesh</code> that we loaded in the <code>init</code> method of the <code>Renderer</code> class? It was named <code>bufferPassMesh</code>, and it just contains that, a quad that fills up the whole screen.</p> <p>So, how the vertex shader for the light pass looks like?</p> <div class="language-glsl line-numbers-mode"><pre class="language-glsl"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span></span></span>

<span class="token keyword">layout</span> <span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> position<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> projectionMatrix<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> modelMatrix<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> projectionMatrix <span class="token operator">*</span> modelMatrix <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>The code above is the vertex shader used when rendering point lights and directional light (<code>light_vertex.vs</code>). It just dumps the vertices using the model matrix and a projection matrix. There’s no need to use a view matrix, we don’t need a camera here.</p> <p>The fragment shader for point lights (<code>point_light_fragment.fs</code>) is defined like this:</p> <div class="language-glsl line-numbers-mode"><pre class="language-glsl"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span></span></span>

<span class="token keyword">out</span> <span class="token keyword">vec4</span> fragColor<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">Attenuation</span>
<span class="token punctuation">{</span>
    <span class="token keyword">float</span> constant<span class="token punctuation">;</span>
    <span class="token keyword">float</span> linear<span class="token punctuation">;</span>
    <span class="token keyword">float</span> exponent<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">PointLight</span>
<span class="token punctuation">{</span>
    <span class="token keyword">vec3</span> colour<span class="token punctuation">;</span>
    <span class="token comment">// Light position is assumed to be in view coordinates</span>
    <span class="token keyword">vec3</span> position<span class="token punctuation">;</span>
    <span class="token keyword">float</span> intensity<span class="token punctuation">;</span>
    Attenuation att<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> positionsText<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> diffuseText<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> specularText<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> normalsText<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> shadowText<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> depthText<span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">vec2</span> screenSize<span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">float</span> specularPower<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> PointLight pointLight<span class="token punctuation">;</span>

<span class="token keyword">vec2</span> <span class="token function">getTextCoord</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> gl_FragCoord<span class="token punctuation">.</span>xy <span class="token operator">/</span> screenSize<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">vec4</span> <span class="token function">calcLightColour</span><span class="token punctuation">(</span><span class="token keyword">vec4</span> diffuseC<span class="token punctuation">,</span> <span class="token keyword">vec4</span> speculrC<span class="token punctuation">,</span> <span class="token keyword">float</span> reflectance<span class="token punctuation">,</span> <span class="token keyword">vec3</span> light_colour<span class="token punctuation">,</span> <span class="token keyword">float</span> light_intensity<span class="token punctuation">,</span> <span class="token keyword">vec3</span> position<span class="token punctuation">,</span> <span class="token keyword">vec3</span> to_light_dir<span class="token punctuation">,</span> <span class="token keyword">vec3</span> normal<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">vec4</span> diffuseColour <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec4</span> specColour <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Diffuse Light</span>
    <span class="token keyword">float</span> diffuseFactor <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> to_light_dir<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    diffuseColour <span class="token operator">=</span> diffuseC <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>light_colour<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> light_intensity <span class="token operator">*</span> diffuseFactor<span class="token punctuation">;</span>

    <span class="token comment">// Specular Light</span>
    <span class="token keyword">vec3</span> camera_direction <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token operator">-</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> from_light_dir <span class="token operator">=</span> <span class="token operator">-</span>to_light_dir<span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> reflected_light <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">reflect</span><span class="token punctuation">(</span>from_light_dir <span class="token punctuation">,</span> normal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> specularFactor <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span> <span class="token function">dot</span><span class="token punctuation">(</span>camera_direction<span class="token punctuation">,</span> reflected_light<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    specularFactor <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span>specularFactor<span class="token punctuation">,</span> specularPower<span class="token punctuation">)</span><span class="token punctuation">;</span>
    specColour <span class="token operator">=</span> speculrC <span class="token operator">*</span> light_intensity  <span class="token operator">*</span> specularFactor <span class="token operator">*</span> reflectance <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>light_colour<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>diffuseColour <span class="token operator">+</span> specColour<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">vec4</span> <span class="token function">calcPointLight</span><span class="token punctuation">(</span><span class="token keyword">vec4</span> diffuseC<span class="token punctuation">,</span> <span class="token keyword">vec4</span> speculrC<span class="token punctuation">,</span> <span class="token keyword">float</span> reflectance<span class="token punctuation">,</span> PointLight light<span class="token punctuation">,</span> <span class="token keyword">vec3</span> position<span class="token punctuation">,</span> <span class="token keyword">vec3</span> normal<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">vec3</span> light_direction <span class="token operator">=</span> light<span class="token punctuation">.</span>position <span class="token operator">-</span> position<span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> to_light_dir  <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>light_direction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec4</span> light_colour <span class="token operator">=</span> <span class="token function">calcLightColour</span><span class="token punctuation">(</span>diffuseC<span class="token punctuation">,</span> speculrC<span class="token punctuation">,</span> reflectance<span class="token punctuation">,</span> light<span class="token punctuation">.</span>colour<span class="token punctuation">,</span> light<span class="token punctuation">.</span>intensity<span class="token punctuation">,</span> position<span class="token punctuation">,</span> to_light_dir<span class="token punctuation">,</span> normal<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Apply Attenuation</span>
    <span class="token keyword">float</span> distance <span class="token operator">=</span> <span class="token function">length</span><span class="token punctuation">(</span>light_direction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> attenuationInv <span class="token operator">=</span> light<span class="token punctuation">.</span>att<span class="token punctuation">.</span>constant <span class="token operator">+</span> light<span class="token punctuation">.</span>att<span class="token punctuation">.</span>linear <span class="token operator">*</span> distance <span class="token operator">+</span>
        light<span class="token punctuation">.</span>att<span class="token punctuation">.</span>exponent <span class="token operator">*</span> distance <span class="token operator">*</span> distance<span class="token punctuation">;</span>
    <span class="token keyword">return</span> light_colour <span class="token operator">/</span> attenuationInv<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">vec2</span> textCoord <span class="token operator">=</span> <span class="token function">getTextCoord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> depth <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span>depthText<span class="token punctuation">,</span> textCoord<span class="token punctuation">)</span><span class="token punctuation">.</span>r<span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> worldPos <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span>positionsText<span class="token punctuation">,</span> textCoord<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
    <span class="token keyword">vec4</span> diffuseC <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span>diffuseText<span class="token punctuation">,</span> textCoord<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec4</span> speculrC <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span>specularText<span class="token punctuation">,</span> textCoord<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> normal  <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span>normalsText<span class="token punctuation">,</span> textCoord<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
    <span class="token keyword">float</span> shadowFactor <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span>shadowText<span class="token punctuation">,</span> textCoord<span class="token punctuation">)</span><span class="token punctuation">.</span>r<span class="token punctuation">;</span>
    <span class="token keyword">float</span> reflectance <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span>shadowText<span class="token punctuation">,</span> textCoord<span class="token punctuation">)</span><span class="token punctuation">.</span>g<span class="token punctuation">;</span>

    fragColor <span class="token operator">=</span> <span class="token function">calcPointLight</span><span class="token punctuation">(</span>diffuseC<span class="token punctuation">,</span> speculrC<span class="token punctuation">,</span> reflectance<span class="token punctuation">,</span> pointLight<span class="token punctuation">,</span> worldPos<span class="token punctuation">.</span>xyz<span class="token punctuation">,</span> normal<span class="token punctuation">.</span>xyz<span class="token punctuation">)</span> <span class="token operator">*</span> shadowFactor<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br></div></div><p>As you can see, it contains functions that should look familiar to you. They were used in previous chapters in the scene fragment shader. The important things here to note are the following lines:</p> <div class="language-glsl line-numbers-mode"><pre class="language-glsl"><code><span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> positionsText<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> diffuseText<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> specularText<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> normalsText<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> shadowText<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> depthText<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>These uniforms model the different textures that compose the G-Buffer. We will use them to access the data. You may be asking now, how do we know which pixel to peek from those textures when we are rendering a fragment? The answer is by using the <code>gl_FragCoord</code> input variable. This variable contains the windows relative coordinates for the current fragment. To transform from that coordinates system to the textures one we use this function:</p> <div class="language-glsl line-numbers-mode"><pre class="language-glsl"><code><span class="token keyword">vec2</span> <span class="token function">getTextCoord</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> gl_FragCoord<span class="token punctuation">.</span>xy <span class="token operator">/</span> screenSize<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>The fragment shader for the directional light is also quite similar, you can check the source code. Now that the shaders have been presented, let’s go back to the <code>Renderer</code> class. For point lights we will do as many passes as lights are, we just bind the shaders used for this type of lights and draw the quad for each of them.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">renderPointLights</span><span class="token punctuation">(</span><span class="token class-name">Window</span> window<span class="token punctuation">,</span> <span class="token class-name">Camera</span> camera<span class="token punctuation">,</span> <span class="token class-name">Scene</span> scene<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pointLightShaderProgram<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Matrix4f</span> viewMatrix <span class="token operator">=</span> camera<span class="token punctuation">.</span><span class="token function">getViewMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Matrix4f</span> projectionMatrix <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">getProjectionMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pointLightShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;modelMatrix&quot;</span><span class="token punctuation">,</span> bufferPassModelMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pointLightShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;projectionMatrix&quot;</span><span class="token punctuation">,</span> projectionMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Specular factor</span>
    pointLightShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;specularPower&quot;</span><span class="token punctuation">,</span> specularPower<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Bind the G-Buffer textures</span>
    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> textureIds <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>gBuffer<span class="token punctuation">.</span><span class="token function">getTextureIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> numTextures <span class="token operator">=</span> textureIds <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> textureIds<span class="token punctuation">.</span>length <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>numTextures<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">glActiveTexture</span><span class="token punctuation">(</span>GL_TEXTURE0 <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> textureIds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    pointLightShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;positionsText&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pointLightShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;diffuseText&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pointLightShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;specularText&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pointLightShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;normalsText&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pointLightShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;shadowText&quot;</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    pointLightShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;screenSize&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> gBuffer<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>gBuffer<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">SceneLight</span> sceneLight <span class="token operator">=</span> scene<span class="token punctuation">.</span><span class="token function">getSceneLight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">PointLight</span><span class="token punctuation">[</span><span class="token punctuation">]</span> pointLights <span class="token operator">=</span> sceneLight<span class="token punctuation">.</span><span class="token function">getPointLightList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> numPointLights <span class="token operator">=</span> pointLights <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> pointLights<span class="token punctuation">.</span>length <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>numPointLights<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Get a copy of the point light object and transform its position to view coordinates</span>
        <span class="token class-name">PointLight</span> currPointLight <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PointLight</span><span class="token punctuation">(</span>pointLights<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Vector3f</span> lightPos <span class="token operator">=</span> currPointLight<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tmpVec<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>lightPos<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tmpVec<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>viewMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
        lightPos<span class="token punctuation">.</span>x <span class="token operator">=</span> tmpVec<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        lightPos<span class="token punctuation">.</span>y <span class="token operator">=</span> tmpVec<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
        lightPos<span class="token punctuation">.</span>z <span class="token operator">=</span> tmpVec<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
        pointLightShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;pointLight&quot;</span><span class="token punctuation">,</span> currPointLight<span class="token punctuation">)</span><span class="token punctuation">;</span>

        bufferPassMesh<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    pointLightShaderProgram<span class="token punctuation">.</span><span class="token function">unbind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p>The approach is quite similar for directional light. In this case, we just use do one pass:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">renderDirectionalLight</span><span class="token punctuation">(</span><span class="token class-name">Window</span> window<span class="token punctuation">,</span> <span class="token class-name">Camera</span> camera<span class="token punctuation">,</span> <span class="token class-name">Scene</span> scene<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dirLightShaderProgram<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Matrix4f</span> viewMatrix <span class="token operator">=</span> camera<span class="token punctuation">.</span><span class="token function">getViewMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Matrix4f</span> projectionMatrix <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">getProjectionMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dirLightShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;modelMatrix&quot;</span><span class="token punctuation">,</span> bufferPassModelMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dirLightShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;projectionMatrix&quot;</span><span class="token punctuation">,</span> projectionMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Specular factor</span>
    dirLightShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;specularPower&quot;</span><span class="token punctuation">,</span> specularPower<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Bind the G-Buffer textures</span>
    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> textureIds <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>gBuffer<span class="token punctuation">.</span><span class="token function">getTextureIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> numTextures <span class="token operator">=</span> textureIds <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> textureIds<span class="token punctuation">.</span>length <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>numTextures<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">glActiveTexture</span><span class="token punctuation">(</span>GL_TEXTURE0 <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> textureIds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    dirLightShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;positionsText&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dirLightShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;diffuseText&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dirLightShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;specularText&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dirLightShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;normalsText&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dirLightShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;shadowText&quot;</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    dirLightShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;screenSize&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> gBuffer<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>gBuffer<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Ambient light</span>
    <span class="token class-name">SceneLight</span> sceneLight <span class="token operator">=</span> scene<span class="token punctuation">.</span><span class="token function">getSceneLight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dirLightShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;ambientLight&quot;</span><span class="token punctuation">,</span> sceneLight<span class="token punctuation">.</span><span class="token function">getAmbientLight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Directional light</span>
    <span class="token comment">// Get a copy of the directional light object and transform its position to view coordinates</span>
    <span class="token class-name">DirectionalLight</span> currDirLight <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DirectionalLight</span><span class="token punctuation">(</span>sceneLight<span class="token punctuation">.</span><span class="token function">getDirectionalLight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tmpVec<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>currDirLight<span class="token punctuation">.</span><span class="token function">getDirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tmpVec<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>viewMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    currDirLight<span class="token punctuation">.</span><span class="token function">setDirection</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span>tmpVec<span class="token punctuation">.</span>x<span class="token punctuation">,</span> tmpVec<span class="token punctuation">.</span>y<span class="token punctuation">,</span> tmpVec<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dirLightShaderProgram<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;directionalLight&quot;</span><span class="token punctuation">,</span> currDirLight<span class="token punctuation">)</span><span class="token punctuation">;</span>

    bufferPassMesh<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    dirLightShaderProgram<span class="token punctuation">.</span><span class="token function">unbind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>The <code>endLightRendering</code> simply restores the state.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">endLightRendering</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Bind screen for writing</span>
    <span class="token function">glBindFramebuffer</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glEnable</span><span class="token punctuation">(</span>GL_DEPTH_TEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glDisable</span><span class="token punctuation">(</span>GL_BLEND<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>If you execute the sample you will see something like this:</p> <p><img src="result.png" alt=""></p> <p>This chapter got longer than expected but there are a few key points that need to be clarified:</p> <ul><li>Spot lights have been removed in order to simplify this chapter.</li> <li>A common technique for point lights used in deferred shading is to calculate the area of the scene affected by that light. In this case, instead of rendering a quad that fills up the screen, you can use a smaller quad, a sphere, etc. Keep in mind that the best is enemy of the good. Performing complex calculus to determine the smallest shape required may be slower than using other coarse approaches.</li> <li>If you do not have many lights, this method will be slower than forward shading.</li></ul> <p>As a final note, if you want to see how these techniques are used in real world games, you can check <a href="http://www.adriancourreges.com/blog/2015/11/02/gta-v-graphics-study/" title="GTA V - Graphics Study" target="_blank" rel="noopener noreferrer">this superb explanation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> about how a GTA V frame gets rendered.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/CraftStarStudio/wjglbook-bookcontents-zh_CN/edit/master/chapter28/chapter28.md" target="_blank" rel="noopener noreferrer">帮助我们完善这个页面</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">最后更新 :</span> <span class="time">6/27/2021, 1:14:09 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/3d-game-development-with-lwjgl/chapter27/chapter27.html" class="prev">
        Assimp
      </a></span> <span class="next"><a href="/3d-game-development-with-lwjgl/appendixa/appendixa.html">
        Appendix A - OpenGL Debugging
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/3d-game-development-with-lwjgl/assets/js/app.519c1cc5.js" defer></script><script src="/3d-game-development-with-lwjgl/assets/js/2.e7870360.js" defer></script><script src="/3d-game-development-with-lwjgl/assets/js/37.ec274013.js" defer></script>
  </body>
</html>
