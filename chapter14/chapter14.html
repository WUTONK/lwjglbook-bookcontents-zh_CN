<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Height Maps | 使用 LWJGL 3 开发 3D 游戏</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/3d-game-development-with-lwjgl/assets/css/0.styles.33e5fdc6.css" as="style"><link rel="preload" href="/3d-game-development-with-lwjgl/assets/js/app.519c1cc5.js" as="script"><link rel="preload" href="/3d-game-development-with-lwjgl/assets/js/2.e7870360.js" as="script"><link rel="preload" href="/3d-game-development-with-lwjgl/assets/js/23.a9e504af.js" as="script"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/10.7296f99c.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/11.a42afaf0.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/12.b7fdae6a.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/13.01b80f30.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/14.06f37286.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/15.c4635c97.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/16.f4253e97.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/17.c7f6896c.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/18.8a24c215.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/19.ab6ce5f4.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/20.9046ed34.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/21.3cb4242e.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/22.b2fa78a0.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/24.12580511.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/25.a115cf89.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/26.7193040d.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/27.4fa5cc0d.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/28.e559af67.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/29.d5befc6c.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/3.8fb1d8aa.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/30.ee00c5df.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/31.0effa8ac.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/32.c13100cf.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/33.c9fbfcdb.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/34.7bde7785.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/35.604c8847.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/36.ccd3a84c.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/37.ec274013.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/38.66d82b73.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/4.e1b9ee22.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/5.75c3f2db.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/6.601d5460.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/7.1f9c2020.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/8.be9c92d8.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/9.048bb756.js">
    <link rel="stylesheet" href="/3d-game-development-with-lwjgl/assets/css/0.styles.33e5fdc6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/3d-game-development-with-lwjgl/" class="home-link router-link-active"><!----> <span class="site-name">使用 LWJGL 3 开发 3D 游戏</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/3d-game-development-with-lwjgl/" aria-current="page" class="sidebar-link">封面</a></li><li><a href="/3d-game-development-with-lwjgl/INTRODUCTION.html" class="sidebar-link">简介</a></li><li><a href="/3d-game-development-with-lwjgl/chapter01/chapter1.html" class="sidebar-link">第一步</a></li><li><a href="/3d-game-development-with-lwjgl/chapter02/chapter2.html" class="sidebar-link">The Game Loop</a></li><li><a href="/3d-game-development-with-lwjgl/chapter03/chapter3.html" class="sidebar-link">A brief about coordinates</a></li><li><a href="/3d-game-development-with-lwjgl/chapter04/chapter4.html" class="sidebar-link">Rendering</a></li><li><a href="/3d-game-development-with-lwjgl/chapter05/chapter5.html" class="sidebar-link">More on Rendering</a></li><li><a href="/3d-game-development-with-lwjgl/chapter06/chapter6.html" class="sidebar-link">Transformations</a></li><li><a href="/3d-game-development-with-lwjgl/chapter07/chapter7.html" class="sidebar-link">Textures</a></li><li><a href="/3d-game-development-with-lwjgl/chapter08/chapter8.html" class="sidebar-link">Camera</a></li><li><a href="/3d-game-development-with-lwjgl/chapter09/chapter9.html" class="sidebar-link">Loading more complex models</a></li><li><a href="/3d-game-development-with-lwjgl/chapter10/chapter10.html" class="sidebar-link">Let there be light</a></li><li><a href="/3d-game-development-with-lwjgl/chapter11/chapter11.html" class="sidebar-link">Let there be even more light</a></li><li><a href="/3d-game-development-with-lwjgl/chapter12/chapter12.html" class="sidebar-link">Game HUD</a></li><li><a href="/3d-game-development-with-lwjgl/chapter13/chapter13.html" class="sidebar-link">Sky Box and some optimizations</a></li><li><a href="/3d-game-development-with-lwjgl/chapter14/chapter14.html" aria-current="page" class="active sidebar-link">Height Maps</a></li><li><a href="/3d-game-development-with-lwjgl/chapter15/chapter15.html" class="sidebar-link">Terrain Collisions</a></li><li><a href="/3d-game-development-with-lwjgl/chapter16/chapter16.html" class="sidebar-link">Fog</a></li><li><a href="/3d-game-development-with-lwjgl/chapter17/chapter17.html" class="sidebar-link">Normal Mapping</a></li><li><a href="/3d-game-development-with-lwjgl/chapter18/chapter18.html" class="sidebar-link">Shadows</a></li><li><a href="/3d-game-development-with-lwjgl/chapter19/chapter19.html" class="sidebar-link">Animations</a></li><li><a href="/3d-game-development-with-lwjgl/chapter20/chapter20.html" class="sidebar-link">Particles</a></li><li><a href="/3d-game-development-with-lwjgl/chapter21/chapter21.html" class="sidebar-link">Instanced Rendering</a></li><li><a href="/3d-game-development-with-lwjgl/chapter22/chapter22.html" class="sidebar-link">Audio</a></li><li><a href="/3d-game-development-with-lwjgl/chapter23/chapter23.html" class="sidebar-link">3D Object Picking</a></li><li><a href="/3d-game-development-with-lwjgl/chapter24/chapter24.html" class="sidebar-link">HUD Revisited - NanoVG</a></li><li><a href="/3d-game-development-with-lwjgl/chapter25/chapter25.html" class="sidebar-link">Optimizations - Frustum Culling \(I\)</a></li><li><a href="/3d-game-development-with-lwjgl/chapter26/chapter26.html" class="sidebar-link">Cascaded Shadow Maps</a></li><li><a href="/3d-game-development-with-lwjgl/chapter27/chapter27.html" class="sidebar-link">Assimp</a></li><li><a href="/3d-game-development-with-lwjgl/chapter28/chapter28.html" class="sidebar-link">Deferred Shading</a></li><li><a href="/3d-game-development-with-lwjgl/appendixa/appendixa.html" class="sidebar-link">Appendix A - OpenGL Debugging</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="height-maps"><a href="#height-maps" class="header-anchor">#</a> Height Maps</h1> <p>In this chapter we will learn how to create complex terrains using height maps. Before we start, you will notice that some refactoring has been done. We have created some new packages and moved some of the classes to better organize them. You can check the changes in the source code.</p> <p>So what’s a height map? A height map is an image that is used to generate a 3D terrain which uses the pixel colours to get surface elevation data. Height maps images are usually gray scale and can be generated by programs like <a href="http://planetside.co.uk/" target="_blank" rel="noopener noreferrer">Terragen<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. A height map image looks like this.</p> <p><img src="heightmap.png" alt="Height map"></p> <p>The image above is like if you were looking at a fragment of land from above. With that image we will build a mesh composed by triangles formed by vertices. The altitude of each vertex will be calculated depending on the colour of each image pixel, with black representing the lowest value and white the highest one.</p> <p>We will create a grid of vertices, one for each pixel of the image. These vertices will be used to form triangles that compose the mesh as shown in the next figure.</p> <p><img src="heightmap_grid.png" alt="Height map grid"></p> <p>That mesh will form a giant quad that will be rendered across the x and z axes using the pixel colours to change the elevation in the y axis.</p> <p><img src="heightmap_coordinates.png" alt="Height map coordinates"></p> <p>The process of creating a 3D terrain from a height map can be summarized as follows:</p> <ul><li>Load the image that contains the height map. (We will use a <code>BufferedImage</code> instance to get access to each pixel).</li> <li>For each image pixel create a vertex with its height is based on the pixel colour.</li> <li>Assign the correct texture coordinate to the vertex.</li> <li>Set up the indices to draw the triangles associated to the vertex.</li></ul> <p>We will create a class named <code>HeightMapMesh</code> that will create a <code>Mesh</code> based on a height map image performing the steps described above. Let’s first review the constants defined for that class:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAX_COLOUR <span class="token operator">=</span> <span class="token number">255</span> <span class="token operator">*</span> <span class="token number">255</span> <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>As we have explained above, we will calculate the height of each vertex based on the colour of each pixel of the image used as height map. Images are usually greyscale; for a PNG image this means that each RGB component for each pixel can vary from $$0$$ to $$255$$, so we have $$256$$ discrete values to define different heights. This may be enough precision for you, but if it’s not we could use the three RGB components to have more intermediate values, and in this case the height could be calculated from the interval $$0$$ to $$255^{3}$$. We will choose the second approach so we are not limited to greyscale images.</p> <p>The next constants are:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">float</span> STARTX <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0.5f</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">float</span> STARTZ <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0.5f</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>The mesh will be formed by a set of vertices (one per pixel) whose x and z coordinates will be in the following range:</p> <ul><li>[-0.5, 0.5], that is, [<code>STARTX</code>, <code>-STARTX</code>] for the x axis.</li> <li>[-0.5, 0.5], that is, [<code>STARTZ</code>, <code>-STARTZ</code>] for the z axis.</li></ul> <p>Don't worry too much about those values: later on the resulting mesh can be scaled to accommodate its size in the world. Regarding y axis, we will set up two parameters, <code>minY</code> and <code>maxY</code>, for setting the lowest and highest value that the y coordinate can have. These parameters are not constant because we may want to change them at run time, independently of the scaling applied. At the end, the terrain will be contained in a cube in the range <code>[STARTX, -STARTX]</code>, <code>[minY, maxY]</code> and <code>[STARTZ, -STARTZ]</code>.</p> <p>The mesh will be created in the constructor of the <code>HeightMapMesh</code> class, which is defined like this.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">HeightMapMesh</span><span class="token punctuation">(</span><span class="token keyword">float</span> minY<span class="token punctuation">,</span> <span class="token keyword">float</span> maxY<span class="token punctuation">,</span> <span class="token class-name">String</span> heightMapFile<span class="token punctuation">,</span> <span class="token class-name">String</span> textureFile<span class="token punctuation">,</span> <span class="token keyword">int</span> textInc<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>It receives the minimum and maximum value for the y axis, the name of the file that contains the image to be used as height map and the texture file to be used. It also receives an integer named <code>textInc</code> that we will discuss later on.</p> <p>The first thing we do in the constructor is to load the height map image into a <code>ByteBuffer</code> instance.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">this</span><span class="token punctuation">.</span>minY <span class="token operator">=</span> minY<span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>maxY <span class="token operator">=</span> maxY<span class="token punctuation">;</span>

<span class="token class-name">ByteBuffer</span> buf <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> width<span class="token punctuation">;</span>
<span class="token keyword">int</span> height<span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">MemoryStack</span> stack <span class="token operator">=</span> <span class="token class-name">MemoryStack</span><span class="token punctuation">.</span><span class="token function">stackPush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">IntBuffer</span> w <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">mallocInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IntBuffer</span> h <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">mallocInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IntBuffer</span> channels <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">mallocInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token class-name">Texture</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span>heightMapFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">toURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> filePath <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    buf <span class="token operator">=</span> <span class="token function">stbi_load</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> channels<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>buf <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;Image file [&quot;</span> <span class="token operator">+</span> filePath  <span class="token operator">+</span> <span class="token string">&quot;] not loaded: &quot;</span> <span class="token operator">+</span> <span class="token function">stbi_failure_reason</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    width <span class="token operator">=</span> w<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    height <span class="token operator">=</span> h<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>Then, we load the texture file into a <code>ByteBuffer</code> and setup the variables that we will need to construct the <code>Mesh</code>. The <code>incx</code> and <code>incz</code> variables will have the increment to be applied to each vertex in the x and z coordinates so the <code>Mesh</code> covers the range stated above.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Texture</span> texture <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Texture</span><span class="token punctuation">(</span>textureFile<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">float</span> incx <span class="token operator">=</span> <span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> incz <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>STARTZ <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>height <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Float</span><span class="token punctuation">&gt;</span></span> positions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Float</span><span class="token punctuation">&gt;</span></span> textCoords <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> indices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>After that we are ready to iterate over the image, creating a vertex per each pixel, setting up its texture coordinates and setting up the indices to define correctly the triangles that compose the <code>Mesh</code>.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> row <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> row <span class="token operator">&lt;</span> height<span class="token punctuation">;</span> row<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> col <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> col <span class="token operator">&lt;</span> width<span class="token punctuation">;</span> col<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Create vertex for current position</span>
        positions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>STARTX <span class="token operator">+</span> col <span class="token operator">*</span> incx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// x</span>
        positions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">getHeight</span><span class="token punctuation">(</span>col<span class="token punctuation">,</span> row<span class="token punctuation">,</span> width<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//y</span>
        positions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>STARTZ <span class="token operator">+</span> row <span class="token operator">*</span> incz<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//z</span>

        <span class="token comment">// Set texture coordinates</span>
        textCoords<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> textInc <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> col <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> width<span class="token punctuation">)</span><span class="token punctuation">;</span>
        textCoords<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> textInc <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> row <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Create indices</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>col <span class="token operator">&lt;</span> width <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> row <span class="token operator">&lt;</span> height <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> leftTop <span class="token operator">=</span> row <span class="token operator">*</span> width <span class="token operator">+</span> col<span class="token punctuation">;</span>
            <span class="token keyword">int</span> leftBottom <span class="token operator">=</span> <span class="token punctuation">(</span>row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> width <span class="token operator">+</span> col<span class="token punctuation">;</span>
            <span class="token keyword">int</span> rightBottom <span class="token operator">=</span> <span class="token punctuation">(</span>row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> width <span class="token operator">+</span> col <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> rightTop <span class="token operator">=</span> row <span class="token operator">*</span> width <span class="token operator">+</span> col <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

            indices<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rightTop<span class="token punctuation">)</span><span class="token punctuation">;</span>
            indices<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>leftBottom<span class="token punctuation">)</span><span class="token punctuation">;</span>
            indices<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>leftTop<span class="token punctuation">)</span><span class="token punctuation">;</span>

            indices<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rightBottom<span class="token punctuation">)</span><span class="token punctuation">;</span>
            indices<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>leftBottom<span class="token punctuation">)</span><span class="token punctuation">;</span>
            indices<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rightTop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>The process of creating the vertex coordinates is self explanatory. Let’s ignore at this moment why we multiply the texture coordinates by a number and how the height is calculated. You can see that for each vertex we define the indices of two triangles (except if we are in the last row or column). Let’s visualize it with a $$3\times3$$ image to visualize how they are constructed. A $$3\times3$$ image contains $$9$$ vertices, and thus $$4$$ quads formed by $$2\times4$$ triangles. The following picture shows that grid, naming each vertex in the form Vrc (r: row, c: column).</p> <p><img src="heightmap_vertices.png" alt="Height map vertices"></p> <p>When we are processing the first vertex (V00), we define the indices of the two triangles shaded in red.</p> <p><img src="heightmap_indices_i.png" alt="Height map indices I"></p> <p>When we are processing the second vertex (V01), we define the indices of the two triangles shaded in red. But, when we are processing the third vertex (V02) we do not need to define more indices, the triangles for that row have already been defined.</p> <p><img src="heightmap_indices_ii.png" alt="Height map indices II"></p> <p>You can easily see how the process continues for the rest of vertices. Once we have created all the vertex positions, the texture coordinates and the indices, we need to create a <code>Mesh</code> and the associated <code>Material</code> with all that data.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> posArr <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">listToArray</span><span class="token punctuation">(</span>positions<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> indicesArr <span class="token operator">=</span> indices<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mapToInt</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> textCoordsArr <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">listToArray</span><span class="token punctuation">(</span>textCoords<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> normalsArr <span class="token operator">=</span> <span class="token function">calcNormals</span><span class="token punctuation">(</span>posArr<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>mesh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mesh</span><span class="token punctuation">(</span>posArr<span class="token punctuation">,</span> textCoordsArr<span class="token punctuation">,</span> normalsArr<span class="token punctuation">,</span> indicesArr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Material</span> material <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Material</span><span class="token punctuation">(</span>texture<span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mesh<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span>material<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">stbi_image_free</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>You can see that we calculate the normals taking as an input the vertex positions. Before we see how normals can be calculated, let’s see how heights are obtained. We have created a method named <code>getHeight</code> which calculates the height for a vertex.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">float</span> <span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> z<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token class-name">ByteBuffer</span> buffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">byte</span> r <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>x <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">0</span> <span class="token operator">+</span> z <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">*</span> width<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">byte</span> g <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>x <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> z <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">*</span> width<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">byte</span> b <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>x <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">+</span> z <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">*</span> width<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">byte</span> a <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>x <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">3</span> <span class="token operator">+</span> z <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">*</span> width<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> argb <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0xFF</span> <span class="token operator">&amp;</span> a<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0xFF</span> <span class="token operator">&amp;</span> r<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span>
            <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0xFF</span> <span class="token operator">&amp;</span> g<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">0xFF</span> <span class="token operator">&amp;</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>minY <span class="token operator">+</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>maxY <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>minY<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> argb <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> MAX_COLOUR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>The method receives the x and z coordinates for a pixel, the width of the image and the <code>ByteBuffer</code> that contains it and returns the RGB colour (the sum of the individual R, G and B components) and assigns a value contained between <code>minY</code> and <code>maxY</code> (<code>minY</code> for black colour and <code>maxY</code> for white colour).</p> <p>You may develop a simpler version using a <code>BufferedImage</code> which contains handy methods for getting RGB values, but we would be using AWT. Remember that AWT does not mix well with OSX so try to avoid using their classes.</p> <p>Let’s now consider how texture coordinates are calculated. The first option is to wrap the texture along the whole mesh: the top left vertex would have (0, 0) texture coordinates and the bottom right vertex would have (1, 1) texture coordinates. The problem with this approach is that the texture should be huge in order to provide good results, as otherwise it would be stretched too much.</p> <p>But we can still use a small texture with very good results by employing a very efficient technique. If we set texture coordinates that are beyond the $$[1, 1]$$ range, we get back to origin and start counting again from the start. The following picture shows this behavior tiling the same texture in several quads that extend beyond the $$[1, 1]$$ range.</p> <p><img src="texture_coordinates_i.png" alt="Texture coordinates I"></p> <p>This is what we will do when setting the texture coordinates. We will be multiplying the texture coordinates (calculated as if the texture just was wrapped covering the whole mesh) by a factor, the <code>textInc</code> parameter, to increase the number of pixels of the texture to be used between adjacent vertices.</p> <p><img src="texture_coordinates_ii.png" alt="Texture coordinates II"></p> <p>The only thing that’s pending now is normal calculation. Remember that we need normals so light can be applied to the terrain correctly. Without normals our terrain will be rendered with the same colour no matter how light hits each point. The method that we will use here may not be the most efficient for height maps but it will help you understand how normals can be auto-calculated. If you search for other solutions you may find more efficient approaches that only use the heights of adjacent points without performing cross product operations. Nevertheless, since this is only done at startup, the method presented here will not hurt performance so much.</p> <p>Let’s explain graphically how a normal can be calculated. Imagine that we have a vertex named $$\vec{P0}$$. We first calculate, for each of the surrounding vertices ($$\vec{P1}$$, $$\vec{P02}$$, $$\vec{P3}$$ and $$\vec{P4}$$), the vectors that are tangent to the surface that connects these points. These vectors, ($$\vec{V1}$$, $$\vec{V2}$$, $$\vec{V3}$$ and $$\vec{V4}$$), are calculated by subtracting each adjacent point from $$\vec{P0}$$ ($$\vec{V1} = \vec{P1}-\vec{P0}$$, etc.)</p> <p><img src="normals_calc_i.png" alt="Normals calculation I"></p> <p>Then, we calculate the normal for each of the planes that connects the adjacent points. This is done by performing the cross product between the previous calculated vectors. For instance, the normal of the surface that connects $$\vec{P1}$$ and $$\vec{P2}$$ (shaded in blue) is calculated as the cross product between $$\vec{V1}$$ and $$\vec{V2}$$, $$\vec{V12} = \vec{V1} \times \vec{V2}$$.</p> <p><img src="normals_calc_ii.png" alt="Normals calculation II"></p> <p>If we calculate the rest of the normals for the rest of the surfaces ($$\vec{V23} = \vec{V2} \times \vec{V3}$$, $$\vec{V34} = \vec{V3} \times \vec{V4}$$ and $$\vec{V41} = \vec{V4} \times \vec{V1}$$), the normal for $$\vec{P0}$$ will be the sum (normalized) of all the normals of the surrounding surfaces: $$\hat{N0} = \hat{V12} +
\hat{V23} + \hat{V34} + \hat{V41}$$.</p> <p><img src="normals_calc_iii.png" alt="Normals calculation III"></p> <p>The implementation of the method that calculates the normals is as follows.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">calcNormals</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> posArr<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Vector3f</span> v0 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Vector3f</span> v1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Vector3f</span> v2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Vector3f</span> v3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Vector3f</span> v4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Vector3f</span> v12 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Vector3f</span> v23 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Vector3f</span> v34 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Vector3f</span> v41 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Float</span><span class="token punctuation">&gt;</span></span> normals <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Vector3f</span> normal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> row <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> row <span class="token operator">&lt;</span> height<span class="token punctuation">;</span> row<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> col <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> col <span class="token operator">&lt;</span> width<span class="token punctuation">;</span> col<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>row <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> row <span class="token operator">&lt;</span> height <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> col <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> col <span class="token operator">&lt;</span> width <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> i0 <span class="token operator">=</span> row<span class="token operator">*</span>width<span class="token operator">*</span><span class="token number">3</span> <span class="token operator">+</span> col<span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">;</span>
                v0<span class="token punctuation">.</span>x <span class="token operator">=</span> posArr<span class="token punctuation">[</span>i0<span class="token punctuation">]</span><span class="token punctuation">;</span>
                v0<span class="token punctuation">.</span>y <span class="token operator">=</span> posArr<span class="token punctuation">[</span>i0 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                v0<span class="token punctuation">.</span>z <span class="token operator">=</span> posArr<span class="token punctuation">[</span>i0 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

                <span class="token keyword">int</span> i1 <span class="token operator">=</span> row<span class="token operator">*</span>width<span class="token operator">*</span><span class="token number">3</span> <span class="token operator">+</span> <span class="token punctuation">(</span>col<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">;</span>
                v1<span class="token punctuation">.</span>x <span class="token operator">=</span> posArr<span class="token punctuation">[</span>i1<span class="token punctuation">]</span><span class="token punctuation">;</span>
                v1<span class="token punctuation">.</span>y <span class="token operator">=</span> posArr<span class="token punctuation">[</span>i1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                v1<span class="token punctuation">.</span>z <span class="token operator">=</span> posArr<span class="token punctuation">[</span>i1 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                    
                v1 <span class="token operator">=</span> v1<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>v0<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">int</span> i2 <span class="token operator">=</span> <span class="token punctuation">(</span>row<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>width<span class="token operator">*</span><span class="token number">3</span> <span class="token operator">+</span> col<span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">;</span>
                v2<span class="token punctuation">.</span>x <span class="token operator">=</span> posArr<span class="token punctuation">[</span>i2<span class="token punctuation">]</span><span class="token punctuation">;</span>
                v2<span class="token punctuation">.</span>y <span class="token operator">=</span> posArr<span class="token punctuation">[</span>i2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                v2<span class="token punctuation">.</span>z <span class="token operator">=</span> posArr<span class="token punctuation">[</span>i2 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                v2 <span class="token operator">=</span> v2<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>v0<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">int</span> i3 <span class="token operator">=</span> <span class="token punctuation">(</span>row<span class="token punctuation">)</span><span class="token operator">*</span>width<span class="token operator">*</span><span class="token number">3</span> <span class="token operator">+</span> <span class="token punctuation">(</span>col<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">;</span>
                v3<span class="token punctuation">.</span>x <span class="token operator">=</span> posArr<span class="token punctuation">[</span>i3<span class="token punctuation">]</span><span class="token punctuation">;</span>
                v3<span class="token punctuation">.</span>y <span class="token operator">=</span> posArr<span class="token punctuation">[</span>i3 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                v3<span class="token punctuation">.</span>z <span class="token operator">=</span> posArr<span class="token punctuation">[</span>i3 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                v3 <span class="token operator">=</span> v3<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>v0<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">int</span> i4 <span class="token operator">=</span> <span class="token punctuation">(</span>row<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>width<span class="token operator">*</span><span class="token number">3</span> <span class="token operator">+</span> col<span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">;</span>
                v4<span class="token punctuation">.</span>x <span class="token operator">=</span> posArr<span class="token punctuation">[</span>i4<span class="token punctuation">]</span><span class="token punctuation">;</span>
                v4<span class="token punctuation">.</span>y <span class="token operator">=</span> posArr<span class="token punctuation">[</span>i4 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                v4<span class="token punctuation">.</span>z <span class="token operator">=</span> posArr<span class="token punctuation">[</span>i4 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                v4 <span class="token operator">=</span> v4<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>v0<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    
                v1<span class="token punctuation">.</span><span class="token function">cross</span><span class="token punctuation">(</span>v2<span class="token punctuation">,</span> v12<span class="token punctuation">)</span><span class="token punctuation">;</span>
                v12<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                v2<span class="token punctuation">.</span><span class="token function">cross</span><span class="token punctuation">(</span>v3<span class="token punctuation">,</span> v23<span class="token punctuation">)</span><span class="token punctuation">;</span>
                v23<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    
                v3<span class="token punctuation">.</span><span class="token function">cross</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> v34<span class="token punctuation">)</span><span class="token punctuation">;</span>
                v34<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    
                v4<span class="token punctuation">.</span><span class="token function">cross</span><span class="token punctuation">(</span>v1<span class="token punctuation">,</span> v41<span class="token punctuation">)</span><span class="token punctuation">;</span>
                v41<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    
                normal <span class="token operator">=</span> v12<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>v23<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>v34<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>v41<span class="token punctuation">)</span><span class="token punctuation">;</span>
                normal<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                normal<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                normal<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                normal<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            normal<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            normals<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>normal<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            normals<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>normal<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
            normals<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>normal<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">listToArray</span><span class="token punctuation">(</span>normals<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br></div></div><p>Finally, in order to build larger terrains, we have two options:</p> <ul><li>Create a larger height map.</li> <li>Reuse a height map and tile it through the 3D space. The height map will be like a terrain block that could be translated across the world like tiles. In order to do so, the pixels of the edge of the height map must be the same (the left edge must be equal to the right side and the top edge must be equal to the bottom one) to avoid gaps between the tiles.</li></ul> <p>We will use the second approach (and select an appropriate height map). To support this, we will create a class named <code>Terrain</code> that creates a square of height map tiles, defined like this.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>lwjglb<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>items</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>lwjglb<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>graph<span class="token punctuation">.</span></span><span class="token class-name">HeightMapMesh</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Terrain</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">GameItem</span><span class="token punctuation">[</span><span class="token punctuation">]</span> gameItems<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Terrain</span><span class="token punctuation">(</span><span class="token keyword">int</span> blocksPerRow<span class="token punctuation">,</span> <span class="token keyword">float</span> scale<span class="token punctuation">,</span> <span class="token keyword">float</span> minY<span class="token punctuation">,</span> <span class="token keyword">float</span> maxY<span class="token punctuation">,</span> <span class="token class-name">String</span> heightMap<span class="token punctuation">,</span> <span class="token class-name">String</span> textureFile<span class="token punctuation">,</span> <span class="token keyword">int</span> textInc<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        gameItems <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GameItem</span><span class="token punctuation">[</span>blocksPerRow <span class="token operator">*</span> blocksPerRow<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">HeightMapMesh</span> heightMapMesh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HeightMapMesh</span><span class="token punctuation">(</span>minY<span class="token punctuation">,</span> maxY<span class="token punctuation">,</span> heightMap<span class="token punctuation">,</span> textureFile<span class="token punctuation">,</span> textInc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> row <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> row <span class="token operator">&lt;</span> blocksPerRow<span class="token punctuation">;</span> row<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> col <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> col <span class="token operator">&lt;</span> blocksPerRow<span class="token punctuation">;</span> col<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">float</span> xDisplacement <span class="token operator">=</span> <span class="token punctuation">(</span>col <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> blocksPerRow <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> scale <span class="token operator">*</span> <span class="token class-name">HeightMapMesh</span><span class="token punctuation">.</span><span class="token function">getXLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> zDisplacement <span class="token operator">=</span> <span class="token punctuation">(</span>row <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> blocksPerRow <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> scale <span class="token operator">*</span> <span class="token class-name">HeightMapMesh</span><span class="token punctuation">.</span><span class="token function">getZLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name">GameItem</span> terrainBlock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GameItem</span><span class="token punctuation">(</span>heightMapMesh<span class="token punctuation">.</span><span class="token function">getMesh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                terrainBlock<span class="token punctuation">.</span><span class="token function">setScale</span><span class="token punctuation">(</span>scale<span class="token punctuation">)</span><span class="token punctuation">;</span>
                terrainBlock<span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span>xDisplacement<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> zDisplacement<span class="token punctuation">)</span><span class="token punctuation">;</span>
                gameItems<span class="token punctuation">[</span>row <span class="token operator">*</span> blocksPerRow <span class="token operator">+</span> col<span class="token punctuation">]</span> <span class="token operator">=</span> terrainBlock<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">GameItem</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getGameItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> gameItems<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>Let's explain the overall process, using blocks that have the following coordinates (for x and z and with the constants defined above).</p> <p><img src="terrain_construction_1.png" alt="Terrain Construction I"></p> <p>Let's suppose that we are creating a terrain formed by a 3x3 blocks grid. Let's assume also that we wont' scale the terrain blocks (that is, the variable <code>blocksPerRow</code> will be $$3$$ and the variable <code>scale</code> will be $$1$$). We want the grid to be centered at (0, 0) coordinates.</p> <p>We need to translate the blocks so the vertices will have the following coordinates.</p> <p><img src="terrain_construction_2.png" alt="Terrain Construction II"></p> <p>The translation is achieved by calling <code>setPosition</code> method, but remember that what we set is a displacement not a position. If you review the figure above you will see that the central block does not require any displacement, it's already positioned in the adequate coordinates. The vertex drawn in green needs a displacement, for the x coordinate, of $$-1$$ and the vertex drawn in blue needs a displacement of $$+1$$. The formula to calculate the x displacement, taking into consideration the scale and the block width, is this one:</p> <p>$$xDisplacement=(col - (blocksPerRow -1 ) / 2) \times scale \times width$$</p> <p>And the equivalent formula for z displacement is:</p> <p>$$zDisplacement=(row - (blocksPerRow -1 ) / 2) \times scale \times height$$</p> <p>If we create a Terrain instance in the <code>DummyGame</code> class, we can get something like this.</p> <p><img src="terrain_result.png" alt="Terrain result"></p> <p>You can move the camera around the terrain and see how it’s rendered. Since we still do not have implemented collision detection you can pass through it and look at it from above. Because we have face culling enabled, some parts of the terrain are not rendered when looking from below.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/CraftStarStudio/wjglbook-bookcontents-zh_CN/edit/master/chapter14/chapter14.md" target="_blank" rel="noopener noreferrer">帮助我们完善这个页面</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">最后更新 :</span> <span class="time">6/27/2021, 1:14:09 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/3d-game-development-with-lwjgl/chapter13/chapter13.html" class="prev">
        Sky Box and some optimizations
      </a></span> <span class="next"><a href="/3d-game-development-with-lwjgl/chapter15/chapter15.html">
        Terrain Collisions
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/3d-game-development-with-lwjgl/assets/js/app.519c1cc5.js" defer></script><script src="/3d-game-development-with-lwjgl/assets/js/2.e7870360.js" defer></script><script src="/3d-game-development-with-lwjgl/assets/js/23.a9e504af.js" defer></script>
  </body>
</html>
