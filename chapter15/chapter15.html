<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Terrain Collisions | 使用 LWJGL 3 开发 3D 游戏</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/3d-game-development-with-lwjgl/assets/css/0.styles.33e5fdc6.css" as="style"><link rel="preload" href="/3d-game-development-with-lwjgl/assets/js/app.519c1cc5.js" as="script"><link rel="preload" href="/3d-game-development-with-lwjgl/assets/js/2.e7870360.js" as="script"><link rel="preload" href="/3d-game-development-with-lwjgl/assets/js/24.12580511.js" as="script"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/10.7296f99c.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/11.a42afaf0.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/12.b7fdae6a.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/13.01b80f30.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/14.06f37286.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/15.c4635c97.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/16.f4253e97.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/17.c7f6896c.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/18.8a24c215.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/19.ab6ce5f4.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/20.9046ed34.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/21.3cb4242e.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/22.b2fa78a0.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/23.a9e504af.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/25.a115cf89.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/26.7193040d.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/27.4fa5cc0d.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/28.e559af67.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/29.d5befc6c.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/3.8fb1d8aa.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/30.ee00c5df.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/31.0effa8ac.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/32.c13100cf.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/33.c9fbfcdb.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/34.7bde7785.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/35.604c8847.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/36.ccd3a84c.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/37.ec274013.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/38.66d82b73.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/4.e1b9ee22.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/5.75c3f2db.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/6.601d5460.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/7.1f9c2020.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/8.be9c92d8.js"><link rel="prefetch" href="/3d-game-development-with-lwjgl/assets/js/9.048bb756.js">
    <link rel="stylesheet" href="/3d-game-development-with-lwjgl/assets/css/0.styles.33e5fdc6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/3d-game-development-with-lwjgl/" class="home-link router-link-active"><!----> <span class="site-name">使用 LWJGL 3 开发 3D 游戏</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/3d-game-development-with-lwjgl/" aria-current="page" class="sidebar-link">封面</a></li><li><a href="/3d-game-development-with-lwjgl/INTRODUCTION.html" class="sidebar-link">简介</a></li><li><a href="/3d-game-development-with-lwjgl/chapter01/chapter1.html" class="sidebar-link">第一步</a></li><li><a href="/3d-game-development-with-lwjgl/chapter02/chapter2.html" class="sidebar-link">The Game Loop</a></li><li><a href="/3d-game-development-with-lwjgl/chapter03/chapter3.html" class="sidebar-link">A brief about coordinates</a></li><li><a href="/3d-game-development-with-lwjgl/chapter04/chapter4.html" class="sidebar-link">Rendering</a></li><li><a href="/3d-game-development-with-lwjgl/chapter05/chapter5.html" class="sidebar-link">More on Rendering</a></li><li><a href="/3d-game-development-with-lwjgl/chapter06/chapter6.html" class="sidebar-link">Transformations</a></li><li><a href="/3d-game-development-with-lwjgl/chapter07/chapter7.html" class="sidebar-link">Textures</a></li><li><a href="/3d-game-development-with-lwjgl/chapter08/chapter8.html" class="sidebar-link">Camera</a></li><li><a href="/3d-game-development-with-lwjgl/chapter09/chapter9.html" class="sidebar-link">Loading more complex models</a></li><li><a href="/3d-game-development-with-lwjgl/chapter10/chapter10.html" class="sidebar-link">Let there be light</a></li><li><a href="/3d-game-development-with-lwjgl/chapter11/chapter11.html" class="sidebar-link">Let there be even more light</a></li><li><a href="/3d-game-development-with-lwjgl/chapter12/chapter12.html" class="sidebar-link">Game HUD</a></li><li><a href="/3d-game-development-with-lwjgl/chapter13/chapter13.html" class="sidebar-link">Sky Box and some optimizations</a></li><li><a href="/3d-game-development-with-lwjgl/chapter14/chapter14.html" class="sidebar-link">Height Maps</a></li><li><a href="/3d-game-development-with-lwjgl/chapter15/chapter15.html" aria-current="page" class="active sidebar-link">Terrain Collisions</a></li><li><a href="/3d-game-development-with-lwjgl/chapter16/chapter16.html" class="sidebar-link">Fog</a></li><li><a href="/3d-game-development-with-lwjgl/chapter17/chapter17.html" class="sidebar-link">Normal Mapping</a></li><li><a href="/3d-game-development-with-lwjgl/chapter18/chapter18.html" class="sidebar-link">Shadows</a></li><li><a href="/3d-game-development-with-lwjgl/chapter19/chapter19.html" class="sidebar-link">Animations</a></li><li><a href="/3d-game-development-with-lwjgl/chapter20/chapter20.html" class="sidebar-link">Particles</a></li><li><a href="/3d-game-development-with-lwjgl/chapter21/chapter21.html" class="sidebar-link">Instanced Rendering</a></li><li><a href="/3d-game-development-with-lwjgl/chapter22/chapter22.html" class="sidebar-link">Audio</a></li><li><a href="/3d-game-development-with-lwjgl/chapter23/chapter23.html" class="sidebar-link">3D Object Picking</a></li><li><a href="/3d-game-development-with-lwjgl/chapter24/chapter24.html" class="sidebar-link">HUD Revisited - NanoVG</a></li><li><a href="/3d-game-development-with-lwjgl/chapter25/chapter25.html" class="sidebar-link">Optimizations - Frustum Culling \(I\)</a></li><li><a href="/3d-game-development-with-lwjgl/chapter26/chapter26.html" class="sidebar-link">Cascaded Shadow Maps</a></li><li><a href="/3d-game-development-with-lwjgl/chapter27/chapter27.html" class="sidebar-link">Assimp</a></li><li><a href="/3d-game-development-with-lwjgl/chapter28/chapter28.html" class="sidebar-link">Deferred Shading</a></li><li><a href="/3d-game-development-with-lwjgl/appendixa/appendixa.html" class="sidebar-link">Appendix A - OpenGL Debugging</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="terrain-collisions"><a href="#terrain-collisions" class="header-anchor">#</a> Terrain Collisions</h1> <p>Once we have created a terrain, the next step is to detect collisions to avoid traversing through it. If you recall from previous chapter, a terrain is composed by blocks, and each of those blocks is constructed from a height map. The height map is used to set the height of the vertices of the triangles that form the terrain.</p> <p>In order to detect a collision we must compare current position $$y$$ value with the $$y$$ value of the point of the terrain we are currently in. If we are above terrain’s $$y$$ value there’s no collision, otherwise we need to get back. It's a simple concept, isn't it? Indeed it is, but we need to perform several calculations before we are able to do that comparison.</p> <p>The first thing we need to define is what we understand for the term &quot;current position&quot;. Since we do not have yet a player concept the answer is easy, the current position will be the camera position. So we already have one of the components of the comparison, thus, the next thing to calculate is terrain height at the current position.</p> <p>As it's been said before, the terrain is composed by a grid of terrain blocks as shown in the next figure.</p> <p><img src="terrain_grid.png" alt=""></p> <p>Each terrain block is constructed from the same height map mesh, but is scaled and displaced precisely to form a terrain grid that looks like a continuous landscape.</p> <p>So first we need to determine which terrain block the camera is in. In order to do that, we will calculate the bounding box of each terrain block taking into consideration the displacement and the scaling. Since the terrain will not be displaced or scaled at runtime, we can perform those calculations in the <code>Terrain</code> class constructor. By doing so we can access them later at any time without repeating those operations in each game loop cycle.</p> <p>We will create a new method that calculates the bounding box of a terrain block, named <code>getBoundingBox</code>.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Box2D</span> <span class="token function">getBoundingBox</span><span class="token punctuation">(</span><span class="token class-name">GameItem</span> terrainBlock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">float</span> scale <span class="token operator">=</span> terrainBlock<span class="token punctuation">.</span><span class="token function">getScale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Vector3f</span> position <span class="token operator">=</span> terrainBlock<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span> topLeftX <span class="token operator">=</span> <span class="token class-name">HeightMapMesh</span><span class="token punctuation">.</span>STARTX <span class="token operator">*</span> scale <span class="token operator">+</span> position<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token keyword">float</span> topLeftZ <span class="token operator">=</span> <span class="token class-name">HeightMapMesh</span><span class="token punctuation">.</span>STARTZ <span class="token operator">*</span> scale <span class="token operator">+</span> position<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
    <span class="token keyword">float</span> width <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token class-name">HeightMapMesh</span><span class="token punctuation">.</span>STARTX <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> scale<span class="token punctuation">;</span>
    <span class="token keyword">float</span> height <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token class-name">HeightMapMesh</span><span class="token punctuation">.</span>STARTZ <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> scale<span class="token punctuation">;</span>
    <span class="token class-name">Box2D</span> boundingBox <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Box2D</span><span class="token punctuation">(</span>topLeftX<span class="token punctuation">,</span> topLeftZ<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> boundingBox<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>The <code>Box2D</code> class is a simplified version of the <code>java.awt.Rectangle2D.Float</code> class which we created to avoid using AWT.</p> <p>Now we need to calculate the world coordinates of the terrain blocks. In the previous chapter you saw that all of our terrain meshes were created inside a quad with its origin set to <code>[STARTX, STARTZ]</code>. Thus, we need to transform those coordinates to the world coordinates taking into consideration the scale and the displacement as shown in the next figure.</p> <p><img src="model_to_world_coordinates.png" alt="Model to world coordinates"></p> <p>As it’s been said above, this can be done in the Terrain class constructor since it won't change at run time. So we need to add a new attribute which will hold the bounding boxes:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Box2D</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> boundingBoxes<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>In the <code>Terrain</code> constructor, while we are creating the terrain blocks, we just need to invoke the method that calculates the bounding box.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Terrain</span><span class="token punctuation">(</span><span class="token keyword">int</span> terrainSize<span class="token punctuation">,</span> <span class="token keyword">float</span> scale<span class="token punctuation">,</span> <span class="token keyword">float</span> minY<span class="token punctuation">,</span> <span class="token keyword">float</span> maxY<span class="token punctuation">,</span> <span class="token class-name">String</span> heightMapFile<span class="token punctuation">,</span> <span class="token class-name">String</span> textureFile<span class="token punctuation">,</span> <span class="token keyword">int</span> textInc<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>terrainSize <span class="token operator">=</span> terrainSize<span class="token punctuation">;</span>
    gameItems <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GameItem</span><span class="token punctuation">[</span>terrainSize <span class="token operator">*</span> terrainSize<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token class-name">ByteBuffer</span> buf <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> width<span class="token punctuation">;</span>
    <span class="token keyword">int</span> height<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">MemoryStack</span> stack <span class="token operator">=</span> <span class="token class-name">MemoryStack</span><span class="token punctuation">.</span><span class="token function">stackPush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">IntBuffer</span> w <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">mallocInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IntBuffer</span> h <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">mallocInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IntBuffer</span> channels <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">mallocInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token class-name">Texture</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span>heightMapFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">toURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> filePath <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        buf <span class="token operator">=</span> <span class="token function">stbi_load</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> channels<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>buf <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;Image file [&quot;</span> <span class="token operator">+</span> filePath  <span class="token operator">+</span> <span class="token string">&quot;] not loaded: &quot;</span> <span class="token operator">+</span> <span class="token function">stbi_failure_reason</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        width <span class="token operator">=</span> w<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        height <span class="token operator">=</span> h<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// The number of vertices per column and row</span>
    verticesPerCol <span class="token operator">=</span> width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    verticesPerRow <span class="token operator">=</span> height <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

    heightMapMesh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HeightMapMesh</span><span class="token punctuation">(</span>minY<span class="token punctuation">,</span> maxY<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> textureFile<span class="token punctuation">,</span> textInc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    boundingBoxes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Box2D</span><span class="token punctuation">[</span>terrainSize<span class="token punctuation">]</span><span class="token punctuation">[</span>terrainSize<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> row <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> row <span class="token operator">&lt;</span> terrainSize<span class="token punctuation">;</span> row<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> col <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> col <span class="token operator">&lt;</span> terrainSize<span class="token punctuation">;</span> col<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">float</span> xDisplacement <span class="token operator">=</span> <span class="token punctuation">(</span>col <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> terrainSize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> scale <span class="token operator">*</span> <span class="token class-name">HeightMapMesh</span><span class="token punctuation">.</span><span class="token function">getXLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">float</span> zDisplacement <span class="token operator">=</span> <span class="token punctuation">(</span>row <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> terrainSize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> scale <span class="token operator">*</span> <span class="token class-name">HeightMapMesh</span><span class="token punctuation">.</span><span class="token function">getZLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">GameItem</span> terrainBlock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GameItem</span><span class="token punctuation">(</span>heightMapMesh<span class="token punctuation">.</span><span class="token function">getMesh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            terrainBlock<span class="token punctuation">.</span><span class="token function">setScale</span><span class="token punctuation">(</span>scale<span class="token punctuation">)</span><span class="token punctuation">;</span>
            terrainBlock<span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span>xDisplacement<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> zDisplacement<span class="token punctuation">)</span><span class="token punctuation">;</span>
            gameItems<span class="token punctuation">[</span>row <span class="token operator">*</span> terrainSize <span class="token operator">+</span> col<span class="token punctuation">]</span> <span class="token operator">=</span> terrainBlock<span class="token punctuation">;</span>

            boundingBoxes<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getBoundingBox</span><span class="token punctuation">(</span>terrainBlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	
	<span class="token function">stbi_image_free</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p>So, with all the bounding boxes pre-calculated, we are ready to create a new method that will return the height of the terrain taking as a parameter the current position. This method will be named <code>getHeightVector</code> and is defined like this.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">float</span> <span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token class-name">Vector3f</span> position<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">float</span> result <span class="token operator">=</span> <span class="token class-name">Float</span><span class="token punctuation">.</span>MIN_VALUE<span class="token punctuation">;</span>
    <span class="token comment">// For each terrain block we get the bounding box, translate it to view coordinates</span>
    <span class="token comment">// and check if the position is contained in that bounding box</span>
    <span class="token class-name">Box2D</span> boundingBox <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> found <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token class-name">GameItem</span> terrainBlock <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> row <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> row <span class="token operator">&lt;</span> terrainSize <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>found<span class="token punctuation">;</span> row<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> col <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> col <span class="token operator">&lt;</span> terrainSize <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>found<span class="token punctuation">;</span> col<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            terrainBlock <span class="token operator">=</span> gameItems<span class="token punctuation">[</span>row <span class="token operator">*</span> terrainSize <span class="token operator">+</span> col<span class="token punctuation">]</span><span class="token punctuation">;</span>
            boundingBox <span class="token operator">=</span> boundingBoxes<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">;</span>
            found <span class="token operator">=</span> boundingBox<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>position<span class="token punctuation">.</span>x<span class="token punctuation">,</span> position<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// If we have found a terrain block that contains the position we need</span>
    <span class="token comment">// to calculate the height of the terrain on that position</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>found<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Vector3f</span><span class="token punctuation">[</span><span class="token punctuation">]</span> triangle <span class="token operator">=</span> <span class="token function">getTriangle</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> boundingBox<span class="token punctuation">,</span> terrainBlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> <span class="token function">interpolateHeight</span><span class="token punctuation">(</span>triangle<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> triangle<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> triangle<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> position<span class="token punctuation">.</span>x<span class="token punctuation">,</span> position<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>The first thing that to we do in that method is to determine the terrain block that we are in. Since we already have the bounding box for each terrain block, the algorithm is simple. We just simply need to iterate over the array of bounding boxes and check if the current position is inside (the class
<code>Box2D</code> provides a method for this).</p> <p>Once we have found the terrain block, we need to calculate the triangle we are in. This is done in the <code>getTriangle</code> method that will be described later on. After that, we have the coordinates of the triangle that we are in, including its height. But we need the height of a point that is not located at any of those vertices but in a place in between. This is done in the $$interpolateHeight$$ method. We will also explain how this is done later on.</p> <p>Let’s first start with the process of determining the triangle that we are in. The quad that forms a terrain block can be seen as a grid in which each cell is formed by two triangles Let’s define some variables first:</p> <ul><li>$$boundingBox.x$$ is the $$x$$ coordinate of the origin of the bounding box associated to the quad.</li> <li>$$boundingBox.y$$ is the $$z$$ coordinates  of the origin of the bounding box associated to the quad (Although you see a “$$y$$”, it models the $$z$$ axis).</li> <li>$$boundingBox.width$$ is the width of the quad.</li> <li>$$boundingBox.height$$ is the height of the quad.</li> <li>$$cellWidth$$ is the width  of a cell.</li> <li>$$cellHeight$$ is the height of a cell.</li></ul> <p>All of the variables defined above are expressed in world coordinates.  To calculate the width of a cell we just need to divide the bounding box width by the number of vertices per column:</p> <p>$$cellWidth = \frac{boundingBox.width}{verticesPerCol}$$</p> <p>And the variable <code>cellHeight</code> is calculated analogously:</p> <p>$$cellHeight = \frac{boundingBox.height}{verticesPerRow}$$</p> <p>Once we have those variables we can calculate the row and the column of the cell we are currently in, which is quite straightforward:</p> <p>$$col = \frac{position.x - boundingBox.x}{boundingBox.width}$$</p> <p>$$row = \frac{position.z - boundingBox.y}{boundingBox.height}$$</p> <p>The following picture shows all the variables  described above for a sample terrain block.</p> <p><img src="terrain_block_variables_n.png" alt="Terrain block variables"></p> <p>With all that information we are able to calculate the positions of the vertices of the triangles contained in the cell. How we can do this? Let’s examine the triangles that form a single cell.</p> <p><img src="cell.png" alt="Cell"></p> <p>You can see that the cell is divided by a diagonal that separates the two triangles. To determine which is the triangle associated to the current position, we check if the $$z$$ coordinate is above or below that diagonal. In our case, if current position $$z$$ value is less than the $$z$$ value of the diagonal setting the $$x$$ value to the $$x$$ value of current position we are in T1. If it's greater than that we are in T2.</p> <p>We can determine that by calculating the line equation that matches the diagonal.</p> <p>If you remember your school math classes, the equation of a line that passes from two points (in 2D) is:</p> <p>$$y-y1=m\cdot(x-x1),$$</p> <p>where m is the line slope, that is, how much the height changes when moving through the $$x$$ axis. Note that, in our case, the $$y$$ coordinates are the $$z$$ ones. Also note that we are using 2D coordinates because we are not calculating heights here. We just want to select the proper triangle and to do that $$x$$ an $$z$$ coordinates are enough. So, in our case the line equation should be rewritten like this.</p> <p>$$z-z1=m\cdot(x-x1)$$</p> <p>The slope can be calculated in the following way:</p> <p>$$m=\frac{z1-z2}{x1-x2}$$</p> <p>So the equation of the diagonal to get the $$z$$ value given a $$x$$ position is like this:</p> <p>$$z=m\cdot(xpos-x1)+z1=\frac{z1-z2}{x1-x2}\cdot(xpos-x1)+z1$$</p> <p>Where $$x1$$, $$x2$$, $$z1$$ and $$z2$$ are the $$x$$ and $$z$$ coordinates of the vertices $$V1$$ and $$V2$$, respectively.</p> <p>So the method to get the triangle that the current position is in, named <code>getTriangle</code>, applying all the calculations described above can be implemented like this:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">Vector3f</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getTriangle</span><span class="token punctuation">(</span><span class="token class-name">Vector3f</span> position<span class="token punctuation">,</span> <span class="token class-name">Box2D</span> boundingBox<span class="token punctuation">,</span> <span class="token class-name">GameItem</span> terrainBlock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get the column and row of the heightmap associated to the current position</span>
    <span class="token keyword">float</span> cellWidth <span class="token operator">=</span> boundingBox<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> verticesPerCol<span class="token punctuation">;</span>
    <span class="token keyword">float</span> cellHeight <span class="token operator">=</span> boundingBox<span class="token punctuation">.</span>height <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> verticesPerRow<span class="token punctuation">;</span>
    <span class="token keyword">int</span> col <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>position<span class="token punctuation">.</span>x <span class="token operator">-</span> boundingBox<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">/</span> cellWidth<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> row <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>position<span class="token punctuation">.</span>z <span class="token operator">-</span> boundingBox<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">/</span> cellHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Vector3f</span><span class="token punctuation">[</span><span class="token punctuation">]</span> triangle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    triangle<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span>
        boundingBox<span class="token punctuation">.</span>x <span class="token operator">+</span> col <span class="token operator">*</span> cellWidth<span class="token punctuation">,</span>
        <span class="token function">getWorldHeight</span><span class="token punctuation">(</span>row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> col<span class="token punctuation">,</span> terrainBlock<span class="token punctuation">)</span><span class="token punctuation">,</span>
        boundingBox<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token punctuation">(</span>row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> cellHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
    triangle<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span>
        boundingBox<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token punctuation">(</span>col <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> cellWidth<span class="token punctuation">,</span>
        <span class="token function">getWorldHeight</span><span class="token punctuation">(</span>row<span class="token punctuation">,</span> col <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> terrainBlock<span class="token punctuation">)</span><span class="token punctuation">,</span>
        boundingBox<span class="token punctuation">.</span>y <span class="token operator">+</span> row <span class="token operator">*</span> cellHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>position<span class="token punctuation">.</span>z <span class="token operator">&lt;</span> <span class="token function">getDiagonalZCoord</span><span class="token punctuation">(</span>triangle<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">,</span> triangle<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>z<span class="token punctuation">,</span> triangle<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">,</span> triangle<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>z<span class="token punctuation">,</span> position<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        triangle<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span>
            boundingBox<span class="token punctuation">.</span>x <span class="token operator">+</span> col <span class="token operator">*</span> cellWidth<span class="token punctuation">,</span>
            <span class="token function">getWorldHeight</span><span class="token punctuation">(</span>row<span class="token punctuation">,</span> col<span class="token punctuation">,</span> terrainBlock<span class="token punctuation">)</span><span class="token punctuation">,</span>
            boundingBox<span class="token punctuation">.</span>y <span class="token operator">+</span> row <span class="token operator">*</span> cellHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        triangle<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span>
            boundingBox<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token punctuation">(</span>col <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> cellWidth<span class="token punctuation">,</span>
            <span class="token function">getWorldHeight</span><span class="token punctuation">(</span>row <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> col <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> terrainBlock<span class="token punctuation">)</span><span class="token punctuation">,</span>
            boundingBox<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token punctuation">(</span>row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> cellHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> triangle<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">protected</span> <span class="token keyword">float</span> <span class="token function">getDiagonalZCoord</span><span class="token punctuation">(</span><span class="token keyword">float</span> x1<span class="token punctuation">,</span> <span class="token keyword">float</span> z1<span class="token punctuation">,</span> <span class="token keyword">float</span> x2<span class="token punctuation">,</span> <span class="token keyword">float</span> z2<span class="token punctuation">,</span> <span class="token keyword">float</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">float</span> z <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>z1 <span class="token operator">-</span> z2<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>x1 <span class="token operator">-</span> x2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> x1<span class="token punctuation">)</span> <span class="token operator">+</span> z1<span class="token punctuation">;</span>
    <span class="token keyword">return</span> z<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">protected</span> <span class="token keyword">float</span> <span class="token function">getWorldHeight</span><span class="token punctuation">(</span><span class="token keyword">int</span> row<span class="token punctuation">,</span> <span class="token keyword">int</span> col<span class="token punctuation">,</span> <span class="token class-name">GameItem</span> gameItem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">float</span> y <span class="token operator">=</span> heightMapMesh<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span>row<span class="token punctuation">,</span> col<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> y <span class="token operator">*</span> gameItem<span class="token punctuation">.</span><span class="token function">getScale</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> gameItem<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>You can see that we have two additional methods. The first one, named <code>getDiagonalZCoord</code>, calculates the $$z$$ coordinate of the diagonal given a $$x$$ position and two vertices. The other one, named <code>getWorldHeight</code>, is used to retrieve the height of the triangle vertices, the $$y$$ coordinate. When the terrain mesh is constructed the height of each vertex is pre-calculated and stored, we only need to translate it to world coordinates.</p> <p>At this point we have the triangle coordinates that the current position is in. Finally, we are ready to calculate terrain height at the current position. How can we do this? Well, our triangle is contained in a plane, and a plane can be defined by three points, in this case, the three vertices that define a triangle.</p> <p>The plane equation is as follows:
$$a\cdot x+b\cdot y+c\cdot z+d=0$$</p> <p>The values of the constants of the previous equation are:</p> <p>$$a=(B_{y}-A_{y}) \cdot (C_{z} - A_{z}) - (C_{y} - A_{y}) \cdot (B_{z}-A_{z})$$</p> <p>$$b=(B_{z}-A_{z}) \cdot (C_{x} - A_{x}) - (C_{z} - A_{z}) \cdot (B_{z}-A_{z})$$</p> <p>$$c=(B_{x}-A_{x}) \cdot (C_{y} - A_{y}) - (C_{x} - A_{x}) \cdot (B_{y}-A_{y})$$</p> <p>Where $$A$$, $$B$$ and $$C$$ are the three vertices needed to define the plane.</p> <p>Then, with previous equations and the values of the $$x$$ and $$z$$ coordinates for the current position we are able to calculate the y value, that is the height of the terrain at the current position:</p> <p>$$y = (-d - a \cdot x - c \cdot z) / b$$</p> <p>The method that performs the previous calculations is the following:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">float</span> <span class="token function">interpolateHeight</span><span class="token punctuation">(</span><span class="token class-name">Vector3f</span> pA<span class="token punctuation">,</span> <span class="token class-name">Vector3f</span> pB<span class="token punctuation">,</span> <span class="token class-name">Vector3f</span> pC<span class="token punctuation">,</span> <span class="token keyword">float</span> x<span class="token punctuation">,</span> <span class="token keyword">float</span> z<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Plane equation ax+by+cz+d=0</span>
    <span class="token keyword">float</span> a <span class="token operator">=</span> <span class="token punctuation">(</span>pB<span class="token punctuation">.</span>y <span class="token operator">-</span> pA<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>pC<span class="token punctuation">.</span>z <span class="token operator">-</span> pA<span class="token punctuation">.</span>z<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>pC<span class="token punctuation">.</span>y <span class="token operator">-</span> pA<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>pB<span class="token punctuation">.</span>z <span class="token operator">-</span> pA<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> b <span class="token operator">=</span> <span class="token punctuation">(</span>pB<span class="token punctuation">.</span>z <span class="token operator">-</span> pA<span class="token punctuation">.</span>z<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>pC<span class="token punctuation">.</span>x <span class="token operator">-</span> pA<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>pC<span class="token punctuation">.</span>z <span class="token operator">-</span> pA<span class="token punctuation">.</span>z<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>pB<span class="token punctuation">.</span>x <span class="token operator">-</span> pA<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> c <span class="token operator">=</span> <span class="token punctuation">(</span>pB<span class="token punctuation">.</span>x <span class="token operator">-</span> pA<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>pC<span class="token punctuation">.</span>y <span class="token operator">-</span> pA<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>pC<span class="token punctuation">.</span>x <span class="token operator">-</span> pA<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>pB<span class="token punctuation">.</span>y <span class="token operator">-</span> pA<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> d <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span>a <span class="token operator">*</span> pA<span class="token punctuation">.</span>x <span class="token operator">+</span> b <span class="token operator">*</span> pA<span class="token punctuation">.</span>y <span class="token operator">+</span> c <span class="token operator">*</span> pA<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// y = (-d -ax -cz) / b</span>
    <span class="token keyword">float</span> y <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">-</span>d <span class="token operator">-</span> a <span class="token operator">*</span> x <span class="token operator">-</span> c <span class="token operator">*</span> z<span class="token punctuation">)</span> <span class="token operator">/</span> b<span class="token punctuation">;</span>
    <span class="token keyword">return</span> y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>And that’s all! We are now able to detect the collisions, so in the <code>DummyGame</code> class we can change the following lines when we update the camera position:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// Update camera position</span>
<span class="token class-name">Vector3f</span> prevPos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3f</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
camera<span class="token punctuation">.</span><span class="token function">movePosition</span><span class="token punctuation">(</span>cameraInc<span class="token punctuation">.</span>x <span class="token operator">*</span> CAMERA_POS_STEP<span class="token punctuation">,</span> cameraInc<span class="token punctuation">.</span>y <span class="token operator">*</span> CAMERA_POS_STEP<span class="token punctuation">,</span> cameraInc<span class="token punctuation">.</span>z <span class="token operator">*</span> CAMERA_POS_STEP<span class="token punctuation">)</span><span class="token punctuation">;</span>        
<span class="token comment">// Check if there has been a collision. If true, set the y position to</span>
<span class="token comment">// the maximum height</span>
<span class="token keyword">float</span> height <span class="token operator">=</span> terrain<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> camera<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>y <span class="token operator">&lt;=</span> height <span class="token punctuation">)</span>  <span class="token punctuation">{</span>
    camera<span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span>prevPos<span class="token punctuation">.</span>x<span class="token punctuation">,</span> prevPos<span class="token punctuation">.</span>y<span class="token punctuation">,</span> prevPos<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>As you can see, the concept of detecting terrain collisions is easy to understand, but we need to carefully perform a set of calculations and be aware of the different coordinate systems we are dealing with.</p> <p>Besides that, although the algorithm presented here is valid in most of the cases, there are still situations that need to be handled carefully. One effect that you may observe is the one called tunnelling. Imagine the following situation: we are travelling at a fast speed through our terrain and because of that, the position increment gets a high value. This value can get so high that, since we are detecting collisions with the final position, we may have skipped obstacles that lay in between.</p> <p><img src="tunnelling.png" alt="Tunnelling"></p> <p>There are many solutions to the tunnelling effect, the simplest one being to split the calculation to be performed in smaller increments.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/CraftStarStudio/wjglbook-bookcontents-zh_CN/edit/master/chapter15/chapter15.md" target="_blank" rel="noopener noreferrer">帮助我们完善这个页面</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">最后更新 :</span> <span class="time">6/27/2021, 1:14:09 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/3d-game-development-with-lwjgl/chapter14/chapter14.html" class="prev">
        Height Maps
      </a></span> <span class="next"><a href="/3d-game-development-with-lwjgl/chapter16/chapter16.html">
        Fog
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/3d-game-development-with-lwjgl/assets/js/app.519c1cc5.js" defer></script><script src="/3d-game-development-with-lwjgl/assets/js/2.e7870360.js" defer></script><script src="/3d-game-development-with-lwjgl/assets/js/24.12580511.js" defer></script>
  </body>
</html>
